---
phase: 15-cross-context-integration
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift
  - MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/*.png
autonomous: false

must_haves:
  truths:
    - "Baseline snapshot images exist for all 6 combinations (narrow/medium/wide x light/dark)"
    - "A markdown file containing YAML front matter, tables, and task lists renders correctly at wide width (spacebar popup context)"
    - "The same file renders correctly at narrow width (Finder column preview pane) with scaled fonts, responsive tables, and properly sized checkboxes"
    - "The same file renders correctly at medium width with appropriate use of available space"
    - "Both light and dark mode produce correct rendering with proper semantic colors"
    - "Snapshot tests pass in verify mode (non-record) against baselines"
    - "Manual context switching test confirms no layout artifacts when switching between spacebar popup, column preview, and fullscreen"
  artifacts:
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/testAllContexts.narrow-light.png"
      provides: "Narrow light mode baseline snapshot"
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/testAllContexts.narrow-dark.png"
      provides: "Narrow dark mode baseline snapshot"
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/testAllContexts.medium-light.png"
      provides: "Medium light mode baseline snapshot"
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/testAllContexts.medium-dark.png"
      provides: "Medium dark mode baseline snapshot"
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/testAllContexts.wide-light.png"
      provides: "Wide light mode baseline snapshot"
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/testAllContexts.wide-dark.png"
      provides: "Wide dark mode baseline snapshot"
  key_links:
    - from: "Snapshot baselines"
      to: "CrossContextSnapshotTests.swift"
      via: "assertSnapshot verification"
      pattern: "assertSnapshot.*precision.*0\\.98"
---

<objective>
Record baseline snapshots, review them for visual defects, fix any rendering issues found, and verify the full test suite passes.

Purpose: Generate the golden baseline images for all 6 width/appearance combinations, visually inspect them for rendering correctness, fix any integration issues discovered, and confirm the snapshot test suite passes in verification mode. This completes the cross-context integration testing and satisfies LAYOUT-05.
Output: Verified baseline snapshots committed to the repository, passing test suite, any rendering fixes applied.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cross-context-integration/15-CONTEXT.md
@.planning/phases/15-cross-context-integration/15-RESEARCH.md
@.planning/phases/15-cross-context-integration/15-01-SUMMARY.md
@MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift
@MDQuickLook/MDQuickLook Extension/PreviewViewController.swift
@MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Record baseline snapshots and run verification</name>
  <files>
    MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift
    MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/*.png
  </files>
  <action>
**Step 1: Enable record mode and run tests to generate baselines**

Temporarily set `shouldRecordSnapshots = true` in CrossContextSnapshotTests.swift (or use the `withSnapshotTesting(record: .all)` override in `invokeTest()`).

Run the snapshot tests:
```bash
xcodebuild test -project MDQuickLook/MDQuickLook.xcodeproj -target MDQuickLookTests -configuration Debug -derivedDataPath build 2>&1
```

If `-target` doesn't work, try `-scheme MDQuickLookTests`. If no auto-generated scheme exists, you may need to create one or use `xcodebuild -create-xctest-scheme MDQuickLookTests`.

The test run in record mode should:
- Generate 6 PNG snapshot files in `__Snapshots__/CrossContextSnapshotTests/` directory
- Each named: `testAllContexts.{width}-{appearance}.png` (narrow-light, narrow-dark, medium-light, medium-dark, wide-light, wide-dark)

**Step 2: Verify baselines were created**

Check that all 6 snapshot files exist and have non-zero size:
```bash
ls -la MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/
```

Note: The exact path for `__Snapshots__` depends on swift-snapshot-testing's default behavior. It typically places them relative to the test source file. If the snapshots land in a different directory, locate them and note the actual path.

**Step 3: Set record mode back to false**

Change `shouldRecordSnapshots` back to `false` in CrossContextSnapshotTests.swift.

**Step 4: Run tests in verification mode**

Run tests again WITHOUT record mode:
```bash
xcodebuild test -project MDQuickLook/MDQuickLook.xcodeproj -target MDQuickLookTests -configuration Debug -derivedDataPath build 2>&1
```

All 6 tests should pass (comparing against the baselines just recorded).

**Step 5: Inspect snapshots for visual defects**

Open each of the 6 snapshot PNG files and inspect for rendering issues. Look specifically for:
- YAML front matter section: bold keys, normal values, distinct separator from body
- Table rendering: columns proportional, content visible, not clipped
- Task list checkboxes: SF Symbol circles (unchecked) and checkmarks (checked), blue accent color
- Heading hierarchy: h1 > h2 > h3 sizing visible
- Code block: monospaced font, distinct background
- Blockquote: indented with left border
- Narrow mode (260px): Scaled-down fonts, smaller insets, compact table
- Dark mode: Proper semantic colors (dark background, light text), YAML/code/blockquote fills appropriate
- No layout artifacts: No overlapping text, no clipped content, no blank areas

**Step 6: Fix any rendering issues found (per zero tolerance policy)**

If ANY visual defect is found:
1. Identify which source file in `MDQuickLook Extension/` needs patching
2. Apply minimal targeted fix (per user decision: "minimal targeted patches to code from previous phases")
3. Re-record the affected snapshots (set record mode to true, run tests, set back to false)
4. Verify fix doesn't break other snapshots
5. If a fix requires major rework of a feature, STOP and note it -- per user decision, major rework becomes a new phase

Track all fixes via descriptive commit messages (per user decision: "issue tracking via descriptive git commit messages").

**Step 7: Final verification run**

After any fixes, run tests one final time in verification mode to confirm all 6 pass.
  </action>
  <verify>
Run tests in verification (non-record) mode:
```bash
xcodebuild test -project MDQuickLook/MDQuickLook.xcodeproj -target MDQuickLookTests -configuration Debug -derivedDataPath build 2>&1 | grep -E "(Test Suite|Test Case|passed|failed)"
```
All 6 snapshot assertions should pass. Verify 6 baseline PNG files exist with non-zero size.
  </verify>
  <done>
1. Six baseline snapshot PNGs exist (narrow-light, narrow-dark, medium-light, medium-dark, wide-light, wide-dark)
2. All snapshot tests pass in verification mode (shouldRecordSnapshots = false)
3. Any rendering defects found were fixed with minimal patches
4. shouldRecordSnapshots is set to false in committed code
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete cross-context snapshot test suite with baseline images for all 6 width/appearance combinations. The baselines verify that YAML front matter, tables, task lists, and all markdown features render correctly across Quick Look contexts (narrow/medium/wide) in both light and dark mode.
  </what-built>
  <how-to-verify>
1. Review the 6 baseline snapshot images in `MDQuickLook/MDQuickLookTests/SnapshotTests/__Snapshots__/CrossContextSnapshotTests/` (or wherever they were generated):
   - `testAllContexts.narrow-light.png` -- Finder column preview pane, light mode
   - `testAllContexts.narrow-dark.png` -- Finder column preview pane, dark mode
   - `testAllContexts.medium-light.png` -- Intermediate width, light mode
   - `testAllContexts.medium-dark.png` -- Intermediate width, dark mode
   - `testAllContexts.wide-light.png` -- Spacebar popup / fullscreen, light mode
   - `testAllContexts.wide-dark.png` -- Spacebar popup / fullscreen, dark mode

2. For each snapshot, verify:
   - YAML front matter renders as styled metadata section (not raw YAML text)
   - Table is readable with proportional columns
   - Task list checkboxes show circles/checkmarks with blue accent
   - Headings, bold, italic, code, blockquotes all render correctly
   - Text is readable and properly sized for the width
   - Dark mode uses appropriate colors throughout

3. **REQUIRED: Manual context switching test** (covers success criterion #4):
   - Copy `comprehensive-v1.2.md` to Desktop
   - Build and install: `make install && make reload`
   - Select the file in Finder and press spacebar (popup) — verify rendering
   - Without closing, switch to fullscreen Quick Look — verify no layout artifacts or stale rendering
   - Close and switch to column view, use preview pane (narrow) — verify rendering
   - Press spacebar from column view — verify switching from narrow to popup produces no artifacts
   - Toggle system dark mode and repeat spacebar → fullscreen transition
  </how-to-verify>
  <resume-signal>Type "approved" if snapshots look correct AND context switching produces no artifacts, or describe any rendering issues you see</resume-signal>
</task>

</tasks>

<verification>
- All 6 snapshot baseline images exist and are non-zero size
- xcodebuild test passes with all assertions green
- No visible rendering defects in any snapshot (zero tolerance per user decision)
- Snapshots cover: narrow (260px), medium (500px), wide (800px) x light, dark
- shouldRecordSnapshots = false in committed code
- Any fixes applied are minimal targeted patches with descriptive commit messages
</verification>

<success_criteria>
All v1.2 features (YAML front matter, tables, task lists, layout scaling) render correctly across all Quick Look width contexts in both light and dark mode, verified by passing automated snapshot tests and human visual review. LAYOUT-05 requirement satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/15-cross-context-integration/15-02-SUMMARY.md`
</output>
