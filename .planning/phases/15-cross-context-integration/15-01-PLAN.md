---
phase: 15-cross-context-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
  - MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift
  - MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md
autonomous: true

must_haves:
  truths:
    - "XCTest target MDQuickLookTests exists in the Xcode project and compiles"
    - "swift-snapshot-testing is added as a package dependency available to the test target"
    - "A comprehensive markdown test file exercising YAML front matter, tables, task lists, and standard content is bundled in test resources"
    - "Snapshot test cases cover 3 widths (260, 500, 800) x 2 appearances (light, dark) = 6 snapshots"
  artifacts:
    - path: "MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift"
      provides: "Snapshot test suite covering full context matrix"
      min_lines: 60
    - path: "MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md"
      provides: "Comprehensive test markdown file with all v1.2 features"
      min_lines: 40
    - path: "MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj"
      provides: "Updated project with test target, SPM dependency, and resource bundle"
      contains: "MDQuickLookTests"
  key_links:
    - from: "MDQuickLookTests target"
      to: "MDQuickLook Extension target"
      via: "@testable import"
      pattern: "@testable import MDQuickLook_Extension"
    - from: "CrossContextSnapshotTests.swift"
      to: "comprehensive-v1.2.md"
      via: "Bundle resource loading"
      pattern: "Bundle.*url.*forResource.*comprehensive"
    - from: "MDQuickLookTests target"
      to: "swift-snapshot-testing"
      via: "SPM dependency"
      pattern: "SnapshotTesting"
---

<objective>
Set up the snapshot testing infrastructure for cross-context visual regression testing.

Purpose: Create a persistent test target with swift-snapshot-testing that can verify all v1.2 rendering features (YAML front matter, tables, task lists, layout scaling) across Quick Look contexts (narrow/medium/wide) in both light and dark mode. This test suite stays in the project for future regression testing.
Output: Compilable XCTest target with snapshot test cases and comprehensive test markdown file.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cross-context-integration/15-CONTEXT.md
@.planning/phases/15-cross-context-integration/15-RESEARCH.md
@MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
@MDQuickLook/MDQuickLook Extension/PreviewViewController.swift
@MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test target infrastructure and comprehensive test markdown</name>
  <files>
    MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
    MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift
    MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md
  </files>
  <action>
This task sets up the entire snapshot testing infrastructure. It has three parts:

**Part A: Create comprehensive test markdown file**

Create `MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md` that exercises ALL v1.2 features in a single file (per user decision). Must include:
- YAML front matter block with `---` delimiters containing title, author, tags (as list), date, description
- H1, H2, H3 headings
- Regular body paragraphs with **bold**, *italic*, ~~strikethrough~~
- An unordered list with 3+ items
- An ordered list with 3+ items
- A GFM task list with mix of `- [ ]` unchecked and `- [x]` checked items (at least 4 items)
- A nested list containing both regular bullets and task list items
- A GFM table with at least 3 columns and 4 rows (varied content widths to test column sizing)
- A fenced code block (```swift or similar) with 3-5 lines
- A blockquote with 2+ lines
- A horizontal rule (`---`)
- An image reference `![Alt text](image.png)` to test placeholder rendering
- A link `[text](url)` to test text-only link rendering

Keep the file realistic -- it should look like a real README/document, not a synthetic test fixture. Around 50-80 lines.

**Part B: Create snapshot test swift file**

Create `MDQuickLook/MDQuickLookTests/SnapshotTests/CrossContextSnapshotTests.swift` with:

```swift
import XCTest
import SnapshotTesting
@testable import MDQuickLook_Extension
```

Test class `CrossContextSnapshotTests: XCTestCase` with:

1. Width configurations array: `("narrow", 260)`, `("medium", 500)`, `("wide", 800)` -- matching WidthTier breakpoints per user decision
2. Appearance configurations array: `("light", .aqua)`, `("dark", .darkAqua)`
3. A `shouldRecordSnapshots` boolean (default `false`) with `invokeTest()` override that uses `withSnapshotTesting(record: .all)` when true
4. A `testAllContexts()` method that loops through all width x appearance combinations (6 total), calling a private helper
5. Private `verifySnapshot(width:height:appearance:named:)` helper that:
   - Creates PreviewViewController, calls loadView()
   - Sets view.frame to (0, 0, width, height) where height is 800
   - Sets view.appearance = NSAppearance(named: appearance) BEFORE loading content (per research pitfall #3)
   - Loads "comprehensive-v1.2" from Bundle(for: type(of: self))
   - Uses XCTestExpectation to wait for preparePreviewOfFile completion (timeout 5.0 seconds)
   - After completion, calls layoutManager.ensureLayout to force synchronous layout (per research pitfall #2)
   - Calls assertSnapshot(matching: vc.view, as: .image(precision: 0.98), named: name) with 0.98 precision (per research)

IMPORTANT: The extension source files use `private` access on PreviewViewController's properties (textView, textStorage, etc.). The test needs to call `ensureLayout` but can't access private properties directly. Two options:
- Option A (preferred): Add `@testable import` which gives access to `internal` properties. Check if the properties we need (textView, layoutManager, textStorage) are `private` or `internal` in PreviewViewController.swift. If they are `private`, the test should still work because `preparePreviewOfFile` already calls `ensureLayout` internally before calling the completion handler. The snapshot should capture the fully-laid-out view.
- Option B: If layout issues appear, we can add an `internal` helper method to PreviewViewController in a later fix.

For now, rely on the fact that PreviewViewController.preparePreviewOfFile already forces layout via `layoutManager.ensureLayout(forCharacterRange:)` at line 153. The view should be ready for snapshotting after the completion handler fires.

**Part C: Modify project.pbxproj to add test target**

This is the most complex part. Modify `MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj` to add:

1. **New XCRemoteSwiftPackageReference** for swift-snapshot-testing:
   - URL: `https://github.com/pointfreeco/swift-snapshot-testing`
   - requirement: `upToNextMajor` from version `1.18.0`

2. **New PBXNativeTarget** `MDQuickLookTests`:
   - productType: `com.apple.product-type.bundle.unit-test`
   - Sources build phase containing CrossContextSnapshotTests.swift
   - Resources build phase containing comprehensive-v1.2.md
   - Frameworks build phase with SnapshotTesting product dependency
   - Target dependency on MDQuickLook Extension target (for @testable import)
   - Build settings: SWIFT_VERSION = 5.0, TEST_HOST = "", BUNDLE_LOADER = "", MACOSX_DEPLOYMENT_TARGET matching project (14.0)
   - Configuration list with Debug and Release

3. **PBXFileReference entries** for new files:
   - CrossContextSnapshotTests.swift
   - comprehensive-v1.2.md
   - MDQuickLookTests.xctest product

4. **PBXGroup entries**:
   - MDQuickLookTests group containing SnapshotTests subgroup and Resources subgroup
   - Add MDQuickLookTests group to root project group
   - Add MDQuickLookTests.xctest to Products group

5. **XCSwiftPackageProductDependency** for SnapshotTesting product linked to test target

6. **Add test target** to project's `targets` array

Use unique hex IDs that don't conflict with existing ones (prefix with `C1` or `D1` series to differentiate from existing `A`, `B`, `3`, `5`, `6`, `7`, `8`, `9`, `E` prefixed IDs).

CRITICAL: The test target needs `@testable import MDQuickLook_Extension`. For this to work, the test target must have the extension target as a dependency AND the extension's build settings must have `ENABLE_TESTABILITY = YES` in Debug configuration. Check: the project-level Debug config already has `ENABLE_TESTABILITY = YES;` (line 335), so extension Debug builds should be testable.

The test target's build settings should include:
- `TEST_TARGET_NAME = "MDQuickLook Extension"` -- so Xcode knows which target to build for testing
- `PRODUCT_BUNDLE_IDENTIFIER = com.rocketpop.MDQuickLook.Tests`
- `CODE_SIGN_STYLE = Automatic`
- `DEVELOPMENT_TEAM = ""`
  </action>
  <verify>
Build the test target to verify it compiles:
```bash
xcodebuild -project MDQuickLook/MDQuickLook.xcodeproj -scheme MDQuickLookTests -configuration Debug build-for-testing -derivedDataPath build 2>&1 | tail -20
```
If no scheme named MDQuickLookTests exists yet (schemes may need to be auto-generated), try:
```bash
xcodebuild -project MDQuickLook/MDQuickLook.xcodeproj -list
```
to see available schemes. May need to create a scheme or use `-target MDQuickLookTests` instead of `-scheme`.

Also verify the comprehensive markdown file exists and has all required features:
```bash
wc -l MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md
grep -c "^---" MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md  # Should be 2 (YAML delimiters)
grep -c "\- \[" MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md  # Task list items
grep -c "|" MDQuickLook/MDQuickLookTests/Resources/comprehensive-v1.2.md      # Table rows
```
  </verify>
  <done>
1. `xcodebuild build-for-testing` succeeds for the test target without errors
2. comprehensive-v1.2.md contains YAML front matter, tables, task lists, code blocks, blockquotes, lists, headings, and formatting
3. CrossContextSnapshotTests.swift imports SnapshotTesting and MDQuickLook_Extension, defines 6 snapshot test cases (3 widths x 2 appearances)
4. project.pbxproj includes MDQuickLookTests target with swift-snapshot-testing dependency and comprehensive-v1.2.md in resources
  </done>
</task>

</tasks>

<verification>
- Test target compiles without errors via xcodebuild
- Comprehensive test markdown file contains all v1.2 features (YAML, tables, task lists, formatting, code, blockquotes)
- Test file is in the test bundle's Copy Bundle Resources phase
- swift-snapshot-testing is resolved and linked to test target
</verification>

<success_criteria>
The MDQuickLookTests target exists in the Xcode project, compiles successfully, and contains a snapshot test suite ready to run. The comprehensive markdown test file is bundled as a resource. Running the tests (in record mode) will be handled by Plan 02.
</success_criteria>

<output>
After completion, create `.planning/phases/15-cross-context-integration/15-01-SUMMARY.md`
</output>
