---
phase: 03-tables-advanced-elements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/TableExtractor.swift
  - md-quick-look/MDQuickLook/TableRenderer.swift
autonomous: true

must_haves:
  truths:
    - "Table extraction identifies GFM tables in markdown documents"
    - "Tables display with proper cell structure and borders"
    - "Header cells have bold font and bottom border separator"
    - "Cell alignment respects markdown column alignment syntax"
    - "Empty cells show subtle middot indicator"
  artifacts:
    - path: "md-quick-look/MDQuickLook/TableExtractor.swift"
      provides: "MarkupVisitor implementation for table detection"
      contains: "struct TableExtractor"
    - path: "md-quick-look/MDQuickLook/TableRenderer.swift"
      provides: "NSTextTable/NSTextTableBlock construction"
      contains: "class TableRenderer"
  key_links:
    - from: "TableExtractor"
      to: "swift-markdown Document"
      via: "MarkupVisitor protocol visitTable method"
      pattern: "func visitTable"
    - from: "TableRenderer"
      to: "NSTextTableBlock"
      via: "cell construction with paragraphStyle.textBlocks"
      pattern: "paragraphStyle.textBlocks = \\[block\\]"
---

<objective>
Create table detection and rendering infrastructure using swift-markdown's MarkupVisitor and AppKit's NSTextTable/NSTextTableBlock.

Purpose: Build the core table rendering pipeline that can extract GFM tables from markdown and render them as styled NSAttributedString with proper cell structure.

Output: TableExtractor.swift (MarkupVisitor for table detection) and TableRenderer.swift (NSTextTable rendering)
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tables-advanced-elements/03-RESEARCH.md
@.planning/phases/03-tables-advanced-elements/03-CONTEXT.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TableExtractor with MarkupVisitor</name>
  <files>md-quick-look/MDQuickLook/TableExtractor.swift</files>
  <action>
Create TableExtractor.swift implementing swift-markdown's MarkupVisitor protocol to detect and extract table data from parsed markdown documents.

Implementation details:
1. Import Markdown framework (swift-markdown)
2. Create struct `ExtractedTable` containing:
   - `columnAlignments: [Table.ColumnAlignment?]` from markdown syntax
   - `headerCells: [String]` - plain text content of header cells
   - `bodyRows: [[String]]` - 2D array of body row cell contents
   - `sourceRange: SourceRange?` for document positioning
3. Create struct `TableExtractor: MarkupVisitor` with:
   - `typealias Result = [ExtractedTable]`
   - `mutating func defaultVisit(_ markup: Markup) -> [ExtractedTable]` - recursively visit children
   - `mutating func visitTable(_ table: Table) -> [ExtractedTable]` - extract table data
4. In visitTable:
   - Extract alignments from `table.columnAlignments`
   - Extract header cells from `table.head.cells` using `cell.plainText`
   - Extract body rows from `table.body.rows` using each row's cells
   - Return array with single ExtractedTable

Key patterns from research:
- Use `cell.plainText.trimmingCharacters(in: .whitespacesAndNewlines)` for cell content
- swift-markdown Table API: table.head, table.body.rows, table.columnAlignments
- Handle case where table has no body (header-only table)

Do NOT process inline formatting within cells yet - start with plainText per research recommendation.
  </action>
  <verify>
Build succeeds: `cd . && xcodebuild -project md-quick-look/md-quick-look.xcodeproj -scheme md-quick-look -configuration Release build 2>&1 | tail -20`
  </verify>
  <done>
TableExtractor.swift exists and compiles. Struct can extract table column alignments, header cells, and body row cells from swift-markdown Table nodes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TableRenderer with NSTextTable</name>
  <files>md-quick-look/MDQuickLook/TableRenderer.swift</files>
  <action>
Create TableRenderer.swift that converts ExtractedTable to NSAttributedString using NSTextTable and NSTextTableBlock.

Implementation details:
1. Import AppKit and os.log (follow existing logging pattern)
2. Add OSLog extension: `static let tableRenderer = OSLog(subsystem: "com.razielpanic.md-quick-look", category: "tableRenderer")`
3. Create class `TableRenderer` with:
   - Private constant `bodyFontSize: CGFloat = 14.0` (match MarkdownRenderer)
   - `func render(_ table: ExtractedTable) -> NSAttributedString` - main entry point

4. In render():
   - Create NSTextTable instance
   - Set `numberOfColumns` from table column count (max of header vs body rows)
   - Set `collapsesBorders = true` and `hidesEmptyCells = false`
   - Configure table width constraint: set `table.setContentWidth(90.0, type: .percentageValueType)` to cap tables at 90% of container width per phase decision
   - Create NSMutableAttributedString for result
   - Render header row (row 0) with `isHeader: true`
   - Render body rows starting at row 1
   - Return result

5. Create private helper `renderCell(table:row:column:content:isHeader:alignment:) -> NSAttributedString`:
   - Create NSTextTableBlock with table, startingRow, rowSpan=1, startingColumn, columnSpan=1
   - Configure padding: 6pt on all edges using `block.setWidth(6.0, type: .absoluteValueType, for: .padding, edge: edge)` for each edge
   - For header cells ONLY: add bottom border `block.setWidth(1.0, type: .absoluteValueType, for: .border, edge: .maxY)` and `block.setBorderColor(NSColor.separatorColor)`
   - Create NSMutableParagraphStyle with `textBlocks = [block]`
   - Set horizontal alignment based on Table.ColumnAlignment: .left/.nil -> .left, .center -> .center, .right -> .right
   - Configure vertical centering: NSTextTableBlock verticalAlignment property defaults to .middle in AppKit, which center-aligns content vertically within the cell (this satisfies the phase decision for center vertical alignment)
   - Set `lineBreakMode = .byTruncatingTail` for truncation with ellipsis (per phase decision: truncate aggressively for quick scanning)
   - CRITICAL: Cell content MUST end with "\n" for NSTextTable to work
   - Handle empty cells: if content is empty, use middot "\u{00B7}" with tertiaryLabelColor and light gray background (NSColor.quaternaryLabelColor.withAlphaComponent(0.2)) per phase decision
   - Font: boldSystemFont for headers, systemFont for body cells
   - Return NSAttributedString with content + "\n" and attributes

6. Column width handling (Claude's discretion per phase decision):
   - Let NSTextTable auto-fit column widths based on content (default AppKit behavior)
   - The 90% max table width constraint combined with truncation ensures tables fit within window
   - No explicit minimum column widths needed - AppKit handles this sensibly

7. Add logging for table rendering (start/complete, cell count)

Key patterns from research:
- Every cell paragraph MUST end with newline
- Header separator is border on .maxY edge of header cells only
- Empty cell indicator is middot (middle dot) with gray color and subtle background
- NSTextTableBlock's default vertical alignment is .middle (centered)
  </action>
  <verify>
Build succeeds: `cd . && xcodebuild -project md-quick-look/md-quick-look.xcodeproj -scheme md-quick-look -configuration Release build 2>&1 | tail -20`
  </verify>
  <done>
TableRenderer.swift exists and compiles. Class can convert ExtractedTable to NSAttributedString with proper NSTextTable structure, 90% max width constraint, header separator line, horizontal and vertical cell alignment, truncation with ellipsis, and empty cell indicators.
  </done>
</task>

</tasks>

<verification>
1. Both files compile without errors
2. TableExtractor follows MarkupVisitor protocol pattern
3. TableRenderer produces NSAttributedString with NSTextTableBlock in paragraph styles
4. Table width capped at 90% of container
5. Code follows existing project conventions (logging, naming, structure)
</verification>

<success_criteria>
- TableExtractor.swift created with MarkupVisitor implementation
- TableRenderer.swift created with NSTextTable/NSTextTableBlock rendering
- Table width constraint set to 90% max
- Vertical alignment uses AppKit default (centered)
- Truncation with ellipsis for long cell content
- Both files integrate with existing project structure (same directory as MarkdownRenderer)
- Build succeeds with no warnings related to table code
</success_criteria>

<output>
After completion, create `.planning/phases/03-tables-advanced-elements/03-01-SUMMARY.md`
</output>
