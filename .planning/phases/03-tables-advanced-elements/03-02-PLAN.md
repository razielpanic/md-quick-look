---
phase: 03-tables-advanced-elements
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: false

must_haves:
  truths:
    - "Documents with tables render tables using NSTextTable (not raw pipe text)"
    - "Documents without tables render identically to before (no regression)"
    - "Tables appear inline with other document content in correct position"
    - "Wide tables scale to fit within 90% of window width"
    - "User can visually verify table rendering in Quick Look preview"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Hybrid rendering for documents with tables"
      contains: "TableExtractor"
  key_links:
    - from: "MarkdownRenderer.render()"
      to: "TableExtractor"
      via: "Document parsing and table detection"
      pattern: "TableExtractor.*visit"
    - from: "MarkdownRenderer"
      to: "TableRenderer"
      via: "render extracted tables"
      pattern: "TableRenderer.*render"
---

<objective>
Integrate table rendering into MarkdownRenderer using hybrid approach: detect tables with swift-markdown, render tables with TableRenderer, render non-table content with existing AttributedString approach.

Purpose: Enable the Quick Look extension to display GFM tables with proper formatting while maintaining backward compatibility for all existing markdown elements.

Output: Modified MarkdownRenderer.swift with hybrid rendering and visual verification of table display
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tables-advanced-elements/03-RESEARCH.md
@.planning/phases/03-tables-advanced-elements/03-CONTEXT.md
@.planning/phases/03-tables-advanced-elements/03-01-SUMMARY.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@md-quick-look/MDQuickLook/TableExtractor.swift
@md-quick-look/MDQuickLook/TableRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement hybrid rendering in MarkdownRenderer</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Modify MarkdownRenderer to detect tables and use hybrid rendering approach.

Implementation details:

1. Add import for Markdown framework at top of file (swift-markdown)

2. Create private helper method `hasGFMTables(in markdown: String) -> Bool`:
   - Parse with `Document(parsing: markdown, options: [.parseBlockDirectives])`
   - Use TableExtractor to check for tables
   - Return true if any tables found

3. Modify the main `render(markdown:)` method:
   - After preprocessing (images, soft breaks), check for tables
   - If NO tables: use existing flow (unchanged behavior)
   - If HAS tables: call new `renderWithTables(markdown:)` method

4. Create private method `renderWithTables(markdown: String) -> NSAttributedString`:
   This is the hybrid approach - split document into table and non-table segments:

   a. Parse document with swift-markdown: `Document(parsing: markdown)`
   b. Use TableExtractor to get all tables with their source ranges
   c. If tables have no source ranges or parsing issues, fall back to existing rendering

   d. Build result by interleaving non-table and table content:
      - Sort tables by source range start position
      - Track current position in markdown string
      - For each table:
        * Render markdown BEFORE table (from current position to table start) using existing AttributedString approach
        * Render table using TableRenderer
        * Update current position to after table
      - Render remaining markdown AFTER last table

   e. For "render segment" helper - extract substring and render with existing flow:
      - Call existing preprocessing and AttributedString conversion
      - Apply same block/inline styles as current render()

   Simplification: If source ranges are not reliable, use fallback approach:
   - Replace table markdown with placeholder marker
   - Render with AttributedString
   - Replace placeholders with rendered tables

5. Create private helper `renderNonTableSegment(_ segment: String) -> NSAttributedString`:
   - Apply existing preprocessing (images, soft breaks)
   - Use AttributedString(markdown:) parsing
   - Apply all existing style processing
   - Return styled NSAttributedString

6. Handle malformed tables per phase decision:
   - If TableExtractor returns table but rendering fails, render raw table text with monospace font
   - Create helper `renderMalformedTable(_ rawText: String) -> NSAttributedString`

7. Add logging for hybrid rendering path selection

Key implementation notes:
- Preserve ALL existing rendering logic for non-table content
- Tables rendered by TableRenderer integrate seamlessly
- Source range handling may need iteration - start simple, refine if needed
- The fallback approach (placeholder substitution) may be more reliable initially
  </action>
  <verify>
Build succeeds: `cd . && xcodebuild -project md-quick-look/md-quick-look.xcodeproj -scheme md-quick-look -configuration Release build 2>&1 | tail -20`
  </verify>
  <done>
MarkdownRenderer.swift modified with hybrid rendering. Documents with tables use TableExtractor + TableRenderer pipeline. Documents without tables use unchanged existing logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and install extension</name>
  <files>None (build only)</files>
  <action>
Build and install the extension for visual verification:

1. Run `make install` from project root
2. Verify build succeeds
3. Verify extension is installed to /Applications
  </action>
  <verify>
`cd . && make install 2>&1 | tail -10` shows successful installation
  </verify>
  <done>
Extension built and installed to /Applications/md-quick-look.app
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify table rendering in Quick Look</name>
  <what-built>
Table rendering integration in Quick Look extension. The extension should now display GFM tables with:
- Proper rows and columns (not raw pipe text)
- Bold header row with separator line below
- Cell alignment (left/center/right) from markdown syntax
- Empty cell indicators (middot with subtle background)
- Tables capped at 90% of window width
- Wide tables scale proportionally to fit
- Existing markdown elements unchanged (headings, lists, code blocks, etc.)
  </what-built>
  <how-to-verify>
1. Create a test markdown file with a GFM table:

```markdown
# Table Test

Some text before the table.

| Name | Age | City |
|:-----|:---:|-----:|
| Alice | 30 | New York |
| Bob | 25 | San Francisco |
| | 40 | Chicago |

Some text after the table.

## Another section

- List item 1
- List item 2
```

2. Save as `table-test.md` in a convenient location
3. In Finder, select the file and press Space to trigger Quick Look
4. Verify:
   - [ ] Table appears as structured table (not raw `| pipe | text |`)
   - [ ] "Name" column is left-aligned
   - [ ] "Age" column is center-aligned
   - [ ] "City" column is right-aligned
   - [ ] Header row is bold
   - [ ] Line appears between header and body rows
   - [ ] Empty cell in third row shows subtle indicator (middot)
   - [ ] Text before and after table renders normally
   - [ ] Heading and list below table render normally

5. Test wide table scaling:
   Create `wide-table-test.md`:
```markdown
# Wide Table Test

| Column A | Column B | Column C | Column D | Column E | Column F | Column G |
|----------|----------|----------|----------|----------|----------|----------|
| Data 1 | Data 2 | Data 3 | Data 4 | Data 5 | Data 6 | Data 7 |
| Longer content here | More content | Even more | Still going | And more | Keep going | Final |
```
   - [ ] Table fits within window (does not overflow)
   - [ ] Table has breathing room on sides (not edge-to-edge)
   - [ ] Long cell content truncates with ellipsis

6. Test edge cases:
   - File with no tables (should render exactly as before)
   - File with only a table (just the table)
   - Header-only table (table with just header row, no body)
  </how-to-verify>
  <resume-signal>Type "approved" if tables render correctly, or describe what needs fixing</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. Documents without tables render identically to Phase 2 (regression test)
3. Documents with tables show table structure instead of raw pipe text
4. Table alignment, header styling, and cell formatting work correctly
5. Wide tables scale to fit within 90% of window width
6. User verification confirms visual quality
</verification>

<success_criteria>
- MarkdownRenderer hybrid approach working for documents with/without tables
- Tables render with proper NSTextTable structure
- Wide tables scale proportionally, capped at 90% width
- No regression in existing markdown element rendering
- User approves visual verification
</success_criteria>

<output>
After completion, create `.planning/phases/03-tables-advanced-elements/03-02-SUMMARY.md`
</output>
