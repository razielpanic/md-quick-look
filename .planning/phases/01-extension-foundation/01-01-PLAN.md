---
phase: 01-extension-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/md-spotlighter.xcodeproj/project.pbxproj
  - md-spotlighter/md-spotlighter/main.swift
  - md-spotlighter/md-spotlighter/Info.plist
  - md-spotlighter/MDQuickLook/PreviewViewController.swift
  - md-spotlighter/MDQuickLook/Info.plist
  - md-spotlighter/MDQuickLook/PreviewViewController.xib
  - md-spotlighter/Package.swift
autonomous: true

must_haves:
  truths:
    - "Extension loads markdown file content when triggered via Quick Look"
    - "Markdown content displays with basic styled formatting (not raw text)"
    - "Extension builds without errors on macOS 26+"
  artifacts:
    - path: "md-spotlighter/md-spotlighter.xcodeproj/project.pbxproj"
      provides: "Xcode project with host app and Quick Look extension targets"
    - path: "md-spotlighter/MDQuickLook/PreviewViewController.swift"
      provides: "QLPreviewingController implementation"
      contains: "QLPreviewingController"
    - path: "md-spotlighter/MDQuickLook/Info.plist"
      provides: "UTI registration for markdown files"
      contains: "net.daringfireball.markdown"
  key_links:
    - from: "md-spotlighter/MDQuickLook/Info.plist"
      to: "Quick Look system"
      via: "QLSupportedContentTypes UTI declaration"
      pattern: "QLSupportedContentTypes"
    - from: "md-spotlighter/MDQuickLook/PreviewViewController.swift"
      to: "markdown file"
      via: "preparePreviewOfFile(at:completionHandler:)"
      pattern: "preparePreviewOfFile"
---

<objective>
Create the Xcode project structure with host application and Quick Look extension target, implementing the core QLPreviewingController protocol to load and render markdown files with styled formatting.

Purpose: Establish the foundational project architecture that enables markdown preview in Finder's Quick Look.
Output: Working Xcode project with extension that can parse and display markdown content.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-extension-foundation/01-RESEARCH.md
@.planning/phases/01-extension-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project with host app and Quick Look extension</name>
  <files>
    md-spotlighter/md-spotlighter.xcodeproj/project.pbxproj
    md-spotlighter/md-spotlighter/main.swift
    md-spotlighter/md-spotlighter/Info.plist
    md-spotlighter/MDQuickLook/Info.plist
    md-spotlighter/MDQuickLook/PreviewViewController.xib
  </files>
  <action>
Create Xcode project structure using command line tools (not Xcode GUI):

1. Create directory structure:
   - md-spotlighter/ (project root)
   - md-spotlighter/md-spotlighter/ (host app target)
   - md-spotlighter/MDQuickLook/ (Quick Look extension target)

2. Host app (minimal, just registers extension):
   - main.swift: Simple @main App struct with empty WindowGroup
   - Info.plist: Standard macOS app config
   - Bundle identifier: com.razielpanic.md-spotlighter

3. Quick Look extension Info.plist (CRITICAL for UTI registration):
   - CFBundleName: ".md for QuickLook"
   - CFBundleIdentifier: com.razielpanic.md-spotlighter.quicklook
   - NSExtension with:
     - NSExtensionPointIdentifier: com.apple.quicklook.preview
     - NSExtensionPrincipalClass: $(PRODUCT_MODULE_NAME).PreviewViewController
     - NSExtensionAttributes with QLSupportedContentTypes array:
       - net.daringfireball.markdown
       - public.plain-text (fallback for .md files without proper UTI)

4. Create project.pbxproj:
   - Two targets: md-spotlighter (app) and MDQuickLook (extension)
   - Extension embedded in app bundle at Contents/Library/QuickLook/
   - macOS 26.0 deployment target
   - Swift Package dependency: swift-markdown from swiftlang/swift-markdown

5. Create PreviewViewController.xib:
   - Simple NSView as root
   - File's Owner set to PreviewViewController class

Use xcodebuild or swift package commands where possible. For project.pbxproj, generate manually with proper UUIDs.
  </action>
  <verify>
    xcodebuild -project md-spotlighter/md-spotlighter.xcodeproj -list
    Should show both targets: md-spotlighter and MDQuickLook
  </verify>
  <done>
    Xcode project exists with two targets, extension Info.plist declares markdown UTIs, project builds framework structure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement PreviewViewController with markdown parsing and rendering</name>
  <files>
    md-spotlighter/MDQuickLook/PreviewViewController.swift
    md-spotlighter/Package.swift
  </files>
  <action>
Implement PreviewViewController.swift with QLPreviewingController protocol:

1. Import statements:
   - Cocoa, QuickLookUI, Markdown (from swift-markdown)
   - os.log for debug logging

2. OSLog extension for subsystem "com.razielpanic.md-spotlighter" category "quicklook"

3. PreviewViewController class:
   - Inherits from NSViewController, conforms to QLPreviewingController
   - nibName returns "PreviewViewController"

4. loadView():
   - Create NSView as self.view
   - Set autoresizingMask to [.width, .height]

5. preparePreviewOfFile(at:completionHandler:):
   - Log "Extension loaded for file: {path}"
   - Load file content with String(contentsOf:encoding:) - handle error
   - Parse markdown using AttributedString(markdown:) initializer (macOS 12+ native support)
     - This handles bold, italic, code, links automatically
   - Create NSTextView:
     - Frame matches view.bounds
     - autoresizingMask [.width, .height]
     - isEditable = false
     - isSelectable = true (for copy/paste if user wants)
     - Set textStorage with NSAttributedString from parsed AttributedString
   - Add textView as subview of self.view
   - Log "Rendering complete"
   - Call handler(nil) on success, handler(error) on failure

6. Error handling:
   - If file read fails, show error message in textView instead of crashing
   - Always call completion handler

Key constraints from CONTEXT.md:
- Styled rendering from start (no raw markdown visible)
- No loading indicators if first content appears instantly
- Key milestone logging only (loaded, complete)
  </action>
  <verify>
    xcodebuild -project md-spotlighter/md-spotlighter.xcodeproj -scheme MDQuickLook -configuration Debug build
    Build should succeed with no errors.
  </verify>
  <done>
    PreviewViewController.swift exists, compiles, implements QLPreviewingController protocol with markdown parsing via AttributedString.
  </done>
</task>

</tasks>

<verification>
1. Project structure exists at md-spotlighter/
2. xcodebuild -list shows both targets
3. xcodebuild build succeeds for both targets
4. Info.plist contains correct UTI declarations
5. PreviewViewController implements preparePreviewOfFile method
</verification>

<success_criteria>
- Xcode project builds without errors
- Extension target embedded in host app bundle
- PreviewViewController loads markdown files and renders styled content
- UTI registration configured for markdown files
</success_criteria>

<output>
After completion, create `.planning/phases/01-extension-foundation/01-01-SUMMARY.md`
</output>
