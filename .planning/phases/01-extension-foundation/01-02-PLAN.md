---
phase: 01-extension-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - Makefile
  - samples/basic.md
  - samples/empty.md
autonomous: false

must_haves:
  truths:
    - "User can run 'make install' to build and install extension"
    - "User can select sample.md in Finder, press spacebar, and see styled preview"
    - "Extension appears in System Settings > Extensions > Quick Look"
  artifacts:
    - path: "Makefile"
      provides: "Build automation with install, clean, reload targets"
      contains: "qlmanage -r"
    - path: "samples/basic.md"
      provides: "Test file with heading, bold, italic, list, code"
  key_links:
    - from: "Makefile"
      to: "~/Library/QuickLook/"
      via: "cp command in install target"
      pattern: "Library/QuickLook"
    - from: "Extension bundle"
      to: "Quick Look system"
      via: "qlmanage -r reload command"
      pattern: "qlmanage.*-r"
---

<objective>
Create build automation and test samples, then verify the extension works in Finder.

Purpose: Enable repeatable build/install workflow and confirm end-to-end Quick Look integration works.
Output: Makefile with automation, sample markdown files, verified working extension in Finder.
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-extension-foundation/01-RESEARCH.md
@.planning/phases/01-extension-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Makefile and sample markdown files</name>
  <files>
    Makefile
    samples/basic.md
    samples/empty.md
  </files>
  <action>
Create Makefile at project root with these targets:

1. Variables:
   - PROJECT_DIR = md-quick-look
   - SCHEME = md-quick-look
   - BUILD_DIR = build
   - INSTALL_DIR = $(HOME)/Library/QuickLook
   - APP_NAME = md-quick-look.app

2. Targets:

   build:
     - xcodebuild -project $(PROJECT_DIR)/md-quick-look.xcodeproj \
       -scheme $(SCHEME) \
       -configuration Release \
       -derivedDataPath $(BUILD_DIR) \
       build

   install: build
     - rm -rf "$(INSTALL_DIR)/$(APP_NAME)"
     - cp -R "$(BUILD_DIR)/Build/Products/Release/$(APP_NAME)" "$(INSTALL_DIR)/"
     - Note: Extension is embedded in app bundle at Contents/Library/QuickLook/

   reload:
     - qlmanage -r
     - qlmanage -r cache
     - @echo "Quick Look reloaded. Open a new Finder window to test."

   clean:
     - rm -rf $(BUILD_DIR)
     - rm -rf "$(INSTALL_DIR)/$(APP_NAME)"

   test: install reload
     - @echo "Testing with sample file..."
     - qlmanage -p samples/basic.md

   all: install reload
     - @echo "Extension installed and Quick Look reloaded."

3. .PHONY declaration for all targets

Create samples/ directory with test files:

samples/basic.md:
```markdown
# Sample Markdown File

This is a **bold** and *italic* test.

## Features

- Item one
- Item two
- Item three

### Code Example

`inline code` and:

    code block
    with indentation

> This is a blockquote

[Link text](https://example.com)
```

samples/empty.md:
```markdown
```
(Empty file to test edge case)
  </action>
  <verify>
    ls -la Makefile samples/
    make --dry-run build
  </verify>
  <done>
    Makefile exists with build, install, clean, reload, test targets. Sample files exist in samples/ directory.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build, install, and reload extension</name>
  <files></files>
  <action>
Execute the build and install workflow:

1. Run: make all
   - This builds the project, installs to ~/Library/QuickLook/, and reloads Quick Look

2. Verify installation:
   - ls -la ~/Library/QuickLook/md-quick-look.app/
   - Check Contents/Library/QuickLook/ contains the extension

3. Run qlmanage -m to list Quick Look generators
   - Look for com.razielpanic.md-quick-look.quicklook in output

4. Test with sample file:
   - make test (runs qlmanage -p samples/basic.md)
   - Should display preview window with styled markdown

If errors occur:
- Check Console.app for sandbox errors: log stream --predicate 'subsystem == "com.razielpanic.md-quick-look"'
- Check extension registration: qlmanage -m | grep spotlighter
  </action>
  <verify>
    make all succeeds
    qlmanage -m shows extension registered
    make test opens preview window
  </verify>
  <done>
    Extension built, installed to ~/Library/QuickLook/, Quick Look system reloaded, qlmanage -p displays preview.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Quick Look extension that loads and renders markdown files with styled formatting.
    - Built and installed extension to ~/Library/QuickLook/
    - Extension registered with Quick Look system
    - Sample markdown files for testing
  </what-built>
  <how-to-verify>
    1. Open Finder and navigate to the samples/ folder in the project
    2. Select basic.md
    3. Press spacebar to trigger Quick Look
    4. Verify you see styled markdown (heading, bold, italic, list, code) - NOT raw markdown text
    5. Open System Settings > Privacy & Security > Extensions > Quick Look
    6. Verify ".md for QuickLook" appears in the list and is enabled
  </how-to-verify>
  <resume-signal>Type "approved" if Quick Look preview shows styled markdown and extension appears in System Settings, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. make build succeeds
2. make install copies app to ~/Library/QuickLook/
3. make reload reloads Quick Look system
4. qlmanage -m shows extension
5. Finder Quick Look (spacebar on .md file) shows styled preview
6. System Settings shows extension installed
</verification>

<success_criteria>
- make all completes without errors
- Extension appears in System Settings > Extensions > Quick Look
- Pressing spacebar on .md file in Finder shows styled markdown preview
- Preview shows heading, bold/italic, list, code block - not raw markdown text
</success_criteria>

<output>
After completion, create `.planning/phases/01-extension-foundation/01-02-SUMMARY.md`
</output>
