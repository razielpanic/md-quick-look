---
phase: 11-yaml-front-matter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
  - MDQuickLook/MDQuickLook Extension/MarkdownLayoutManager.swift
  - samples/yaml-front-matter.md
autonomous: false

must_haves:
  truths:
    - "A markdown file with YAML front matter shows a visually distinct metadata section above the rendered body"
    - "The --- delimiters do not appear as horizontal rules or garbled headings in the preview"
    - "List values like tags: [a, b, c] display as comma-separated inline text"
    - "Files without front matter render exactly as before (no regression)"
    - "Empty front matter, Windows line endings, and missing closing delimiter produce reasonable output without crashes"
  artifacts:
    - path: "MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift"
      provides: "YAML front matter extraction, parsing, and styled rendering"
      contains: "extractYAMLFrontMatter"
    - path: "MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift"
      provides: "Key-value parsing with list value support"
      contains: "parseYAMLKeyValues"
    - path: "MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift"
      provides: "Styled front matter section rendering"
      contains: "renderFrontMatter"
    - path: "MDQuickLook/MDQuickLook Extension/MarkdownLayoutManager.swift"
      provides: "Custom background drawing for front matter section"
      contains: "frontMatterMarker"
    - path: "samples/yaml-front-matter.md"
      provides: "Test file with YAML front matter for visual verification"
  key_links:
    - from: "MarkdownRenderer.render()"
      to: "extractYAMLFrontMatter()"
      via: "Called FIRST in render pipeline, before preprocessImages"
      pattern: "extractYAMLFrontMatter\\(from:"
    - from: "extractYAMLFrontMatter()"
      to: "parseYAMLKeyValues()"
      via: "Parses extracted YAML content into dictionary"
      pattern: "parseYAMLKeyValues\\("
    - from: "MarkdownRenderer.render()"
      to: "renderFrontMatter()"
      via: "Prepends styled section to final output when front matter exists"
      pattern: "renderFrontMatter\\("
    - from: "MarkdownLayoutManager.drawBackground()"
      to: ".frontMatterMarker"
      via: "Draws background fill for front matter section"
      pattern: "frontMatterMarker"
---

<objective>
Implement YAML front matter detection, extraction, parsing, and styled rendering in the Quick Look extension.

Purpose: Markdown files with YAML front matter (used by Jekyll, Hugo, Obsidian, etc.) currently display garbled output because swift-markdown parses `---` as horizontal rules. This plan adds preprocessing to extract front matter before markdown parsing, parse key-value pairs, and render them as a visually distinct styled section above the document body.

Output: Modified MarkdownRenderer.swift with YAML preprocessing pipeline, modified MarkdownLayoutManager.swift with front matter background drawing, and a test sample file.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-yaml-front-matter/11-CONTEXT.md
@.planning/phases/11-yaml-front-matter/11-RESEARCH.md
@MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
@MDQuickLook/MDQuickLook Extension/MarkdownLayoutManager.swift
@MDQuickLook/MDQuickLook Extension/PreviewViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement YAML front matter extraction, parsing, and styled rendering</name>
  <files>
    MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
    MDQuickLook/MDQuickLook Extension/MarkdownLayoutManager.swift
  </files>
  <action>
    **In MarkdownRenderer.swift**, add three new private methods and modify the render pipeline:

    **1. Add `extractYAMLFrontMatter(from:)` method** (add in new `// MARK: - YAML Front Matter` section after the Image Preprocessing section):
    - Normalize line endings: replace `\r\n` with `\n` before regex
    - Use regex pattern `^---\n(.+?)\n---\n(.*)` with `.dotMatchesLineSeparators` option
    - Return tuple of `([(key: String, value: String)], String)` — use array of tuples (NOT dictionary) to preserve original YAML key ordering
    - If regex doesn't match (no front matter, malformed, missing closing delimiter): return `([], markdown)` — original markdown unchanged
    - If front matter block is empty (just `---\n---`): regex won't match due to `.+?` requiring content, so returns `([], bodyMarkdown)` gracefully
    - Add os_log calls matching existing logging patterns

    **2. Add `parseYAMLKeyValues(_:)` method:**
    - Input: raw YAML string between delimiters
    - Output: `[(key: String, value: String)]` array preserving order
    - For each line: skip empty lines and lines starting with `#` (YAML comments)
    - Split on first `:` only (values may contain colons, e.g., `url: https://example.com`)
    - Trim whitespace from key and value
    - Handle list values: if value starts with `[` and ends with `]`, remove brackets, split by comma, trim each item, strip surrounding quotes (`"` and `'`), rejoin with `, ` (comma-space)
    - Strip surrounding quotes from regular values too
    - Date values, booleans: keep as-is (no conversion per user decision)
    - Add os_log for parsed pair count

    **3. Add `renderFrontMatter(_:)` method:**
    - Input: `[(key: String, value: String)]` array
    - Output: `NSAttributedString` for the front matter section
    - Guard against empty array, return empty NSAttributedString
    - Use a custom attribute `.frontMatterMarker` (define in MarkdownLayoutManager.swift alongside existing markers) so LayoutManager draws a uniform background — same pattern as `.codeBlockMarker`
    - **Visual design (Claude's discretion choices):**
      - Background: drawn by MarkdownLayoutManager using `.tertiarySystemFill` (slightly lighter than code blocks which use `.secondarySystemFill`) to differentiate
      - No section header label — keep it clean, the visual card is sufficient distinction
      - Key styling: bold system font at 12pt, `.labelColor`
      - Value styling: regular system font at 12pt, `.secondaryLabelColor`
      - Format each pair as `"key  value\n"` using a tab stop for alignment (tab character between key and value)
      - Paragraph style: `headIndent: 12`, `firstLineHeadIndent: 12`, `tailIndent: -12` (inset from both edges), `paragraphSpacing: 2`, tab stop at 120pt for value alignment
      - Multi-column: Use tab-stop approach for a 2-column layout when there are 4+ key-value pairs. Pair entries side by side: `"key1  val1\tkey2  val2\n"` with a second tab stop at ~50% of a reasonable width (e.g., 300pt). For fewer than 4 pairs, single column. This is the simpler approach recommended by research.
    - Apply `.frontMatterMarker` attribute to the entire front matter section range (excluding the trailing separator)
    - After the front matter content, append a single `\n` as separator before the body

    **4. Modify `render(markdown:)` method:**
    - As the FIRST step (before `preprocessImages`), call `extractYAMLFrontMatter(from: markdown)`
    - Destructure into `(frontMatter, bodyMarkdown)`
    - Pass `bodyMarkdown` (NOT original `markdown`) to existing `preprocessBlockquoteSoftBreaks(in: preprocessImages(in:))` chain
    - At the end of the method (after all styling), if `!frontMatter.isEmpty`, create result as `NSMutableAttributedString`, append `renderFrontMatter(frontMatter)`, then append the styled body content, and return
    - Apply same pattern to the `renderWithTables` path: after hybrid rendering completes, prepend front matter section if present

    **5. Modify `renderWithTables(markdown:)` method:**
    - This method is called from `render()` when tables are detected. It currently returns the table-rendered content directly.
    - After `renderWithSourceRanges` or `renderWithPlaceholders` returns, the calling code in `render()` already handles prepending front matter (from step 4 above). No changes needed inside `renderWithTables` itself — the front matter extraction happens before this method is called.

    **In MarkdownLayoutManager.swift**, add front matter background drawing:

    **6. Add `.frontMatterMarker` custom attribute key:**
    - Add `static let frontMatterMarker = NSAttributedString.Key("com.rocketpop.frontMatterMarker")` in the existing extension block alongside `.blockquoteMarker` and `.codeBlockMarker`

    **7. Add front matter background drawing in `drawBackground(forGlyphRange:at:)`:**
    - After the code block drawing section, add a new section that enumerates `.frontMatterMarker` ranges
    - Use the same union-rect pattern as code blocks (enumerate line fragments, build union rect)
    - Draw background with `.tertiarySystemFill` color (lighter than code blocks' `.secondarySystemFill`)
    - Use full container width minus small insets: `x: origin.x + 6, width: textContainer.containerSize.width - 12`
    - Draw a 1pt bottom border line using `.separatorColor` at the bottom of the union rect to visually separate from body content
    - Add rounded corners using `NSBezierPath(roundedRect:xRadius:yRadius:)` with 6pt radius for the background fill
    - Add os_log for debugging
  </action>
  <verify>
    Run `make build` from project root. Build must succeed with zero errors. Grep the built MarkdownRenderer.swift for `extractYAMLFrontMatter`, `parseYAMLKeyValues`, `renderFrontMatter`, and `frontMatterMarker` to confirm all methods exist.
  </verify>
  <done>
    MarkdownRenderer.swift contains YAML front matter extraction as first preprocessing step, key-value parsing with list value support, and styled rendering with tab-stop alignment and multi-column layout. MarkdownLayoutManager.swift draws rounded-rect background with `.tertiarySystemFill` and bottom separator for front matter sections. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test sample and verify rendering</name>
  <files>
    samples/yaml-front-matter.md
  </files>
  <action>
    **Create `samples/yaml-front-matter.md`** with comprehensive test content:

    ```markdown
    ---
    title: Sample Document
    author: Jane Smith
    date: 2024-03-15
    tags: [swift, markdown, yaml]
    categories: ["tutorial", "reference"]
    published: true
    version: 1.2.3
    description: A sample document for testing YAML front matter rendering
    ---

    # Sample Document

    This document has YAML front matter that should appear as a styled metadata section above this heading.

    ## Features

    - The front matter section should have a distinct background
    - Keys should be bold, values should be in secondary color
    - List values like tags should show as comma-separated text
    - The `---` delimiters should NOT appear as horizontal rules

    ## Code Example

    ```yaml
    ---
    title: This is inside a code block
    ---
    ```

    This YAML inside a code block should render as code, NOT be extracted as front matter.

    > This is a blockquote to verify no regression in existing rendering.

    **Bold text**, *italic text*, and `inline code` should all still work correctly.
    ```

    Then run `make build` to ensure the project still compiles with the new sample file present (sample files don't affect the build, but this confirms the build is still clean after Task 1 changes).

    Also create `samples/no-front-matter.md` as a regression test — just a simple markdown file without any front matter to verify it renders normally:

    ```markdown
    # No Front Matter

    This file has no YAML front matter. It should render exactly as before.

    - Item 1
    - Item 2
    - Item 3
    ```
  </action>
  <verify>
    `make build` succeeds. Both sample files exist in the samples/ directory. Run `qlmanage -p samples/yaml-front-matter.md` to preview (this will open Quick Look). Run `qlmanage -p samples/no-front-matter.md` to verify no regression.
  </verify>
  <done>
    Sample files created for testing. Build succeeds. Quick Look preview can be triggered for manual verification.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete YAML front matter rendering pipeline: detection, extraction, parsing, and styled display. Files with YAML front matter between `---` delimiters now show a visually distinct metadata section (rounded background, bold keys, secondary-color values) above the rendered markdown body. Files without front matter render unchanged.
  </what-built>
  <how-to-verify>
    1. Run `make install && make reload` from the project root to install the updated extension
    2. Open Finder and navigate to the `samples/` directory
    3. Select `yaml-front-matter.md` and press spacebar for Quick Look preview:
       - Verify: A styled metadata section appears at the top with a subtle background
       - Verify: Keys (title, author, date, tags, etc.) are bold
       - Verify: Values are in a secondary/muted color
       - Verify: Tags show as "swift, markdown, yaml" (comma-separated, no brackets)
       - Verify: Categories show as "tutorial, reference" (quotes stripped)
       - Verify: No `---` horizontal rules appear at the top
       - Verify: The heading "# Sample Document" renders normally below the metadata
       - Verify: The YAML inside the code block is NOT extracted as front matter
       - Verify: Blockquote, bold, italic, inline code all render correctly (no regression)
    4. Select `no-front-matter.md` and press spacebar:
       - Verify: Renders normally with heading and list, no metadata section
    5. Select `basic.md` (existing sample) and press spacebar:
       - Verify: Renders exactly as before (no regression)
    6. Toggle system appearance (System Settings > Appearance > Dark/Light):
       - Verify: Front matter background adapts to dark mode (should use semantic colors)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `make build` succeeds with zero errors
- `extractYAMLFrontMatter` is called FIRST in the render pipeline (before `preprocessImages`)
- Files with front matter: metadata section rendered above body, `---` not visible
- Files without front matter: render unchanged (no regression)
- List values display as comma-separated text
- Semantic colors used throughout (no hard-coded RGB)
- Light mode and dark mode both render correctly
</verification>

<success_criteria>
1. YAML front matter between `---` delimiters is detected, extracted, and displayed as a styled section (YAML-01, YAML-02, YAML-03, YAML-05)
2. List values render as comma-separated inline text (YAML-04)
3. Edge cases handled gracefully: empty front matter, Windows line endings, missing closing delimiter (YAML-06)
4. No regression in existing markdown rendering
5. Visual verification approved by user in both light and dark mode
</success_criteria>

<output>
After completion, create `.planning/phases/11-yaml-front-matter/11-01-SUMMARY.md`
</output>
