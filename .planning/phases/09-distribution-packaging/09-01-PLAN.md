---
phase: 09-distribution-packaging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MDQuickLook/MDQuickLook/Info.plist
  - MDQuickLook/MDQuickLook Extension/Info.plist
  - MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "Built .app bundle shows version 1.1.0 in Info.plist"
    - "DMG file exists with version in filename"
    - "DMG contains working MD Quick Look.app"
  artifacts:
    - path: "MDQuickLook/MDQuickLook/Info.plist"
      provides: "Host app version 1.1.0"
      contains: "1.1.0"
    - path: "MDQuickLook/MDQuickLook Extension/Info.plist"
      provides: "Extension version 1.1.0"
      contains: "1.1.0"
    - path: "build/Build/Products/Release/MD Quick Look.app"
      provides: "Built application bundle"
    - path: "MD-Quick-Look-1.1.0.dmg"
      provides: "Unsigned DMG distribution package"
  key_links:
    - from: "MDQuickLook/MDQuickLook/Info.plist"
      to: "build/Build/Products/Release/MD Quick Look.app"
      via: "xcodebuild reads plist during build"
      pattern: "CFBundleShortVersionString.*1\\.1\\.0"
---

<objective>
Bump app version to 1.1.0, rebuild the app, and create an unsigned DMG distribution package.

Purpose: The app currently shows version 0.1.0 in Info.plist. For the v1.1 public release, the version must be 1.1.0 everywhere. Once rebuilt, we package it into a professional DMG using create-dmg.
Output: An unsigned DMG file (MD-Quick-Look-1.1.0.dmg) ready to attach to a GitHub release.
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-distribution-packaging/09-RESEARCH.md
@Makefile
@MDQuickLook/MDQuickLook/Info.plist
@MDQuickLook/MDQuickLook Extension/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bump version to 1.1.0 and rebuild app</name>
  <files>
    MDQuickLook/MDQuickLook/Info.plist
    MDQuickLook/MDQuickLook Extension/Info.plist
    MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
  </files>
  <action>
Update the version string from 0.1.0 to 1.1.0 in three places:

1. **MDQuickLook/MDQuickLook/Info.plist** — Change CFBundleShortVersionString from "0.1.0" to "1.1.0". Also update CFBundleVersion from "1" to "2" (build number increment).

2. **MDQuickLook/MDQuickLook Extension/Info.plist** — Same changes: CFBundleShortVersionString "0.1.0" to "1.1.0", CFBundleVersion "1" to "2".

3. **MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj** — Find all 4 instances of `MARKETING_VERSION = 0.1.0` and change to `MARKETING_VERSION = 1.1.0`. Find all 4 instances of `CURRENT_PROJECT_VERSION = 1` and change to `CURRENT_PROJECT_VERSION = 2`.

After updating versions, run a clean rebuild:
```bash
cd .
make clean
make build
```

Then verify the built .app has the correct version:
```bash
/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "build/Build/Products/Release/MD Quick Look.app/Contents/Info.plist"
```
Expected output: `1.1.0`
  </action>
  <verify>
Run: `/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "build/Build/Products/Release/MD Quick Look.app/Contents/Info.plist"`
Expected: 1.1.0

Run: `ls -la "build/Build/Products/Release/MD Quick Look.app"` — should exist and be recent timestamp

Run: `grep -c 'MARKETING_VERSION = 1.1.0' MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj`
Expected: 4
  </verify>
  <done>
All Info.plist files and project.pbxproj show version 1.1.0. Built .app in build/Build/Products/Release/ has version 1.1.0 embedded. Build completed without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unsigned DMG with create-dmg</name>
  <files>
    MD-Quick-Look-1.1.0.dmg
  </files>
  <action>
Install create-dmg globally via npm, then create the unsigned DMG from the built .app.

1. **Install create-dmg:**
```bash
npm install --global create-dmg
```

2. **Create unsigned DMG from the built app:**
```bash
cd .
create-dmg 'build/Build/Products/Release/MD Quick Look.app' --no-code-sign --overwrite
```

create-dmg reads the version from the app's Info.plist and produces a file named like `MD-Quick-Look-1.1.0.dmg` automatically. The tool also automatically:
- Sets up the Applications symlink for drag-to-install
- Configures the DMG window layout
- Uses the app icon on the DMG volume

3. **Verify the DMG:**
```bash
# Check file exists and has reasonable size (should be several MB)
ls -lh MD-Quick-Look-*.dmg

# Mount and verify contents
hdiutil attach MD-Quick-Look-*.dmg -mountpoint /tmp/mdql-dmg-test
ls -la /tmp/mdql-dmg-test/
# Should show: MD Quick Look.app and Applications symlink
hdiutil detach /tmp/mdql-dmg-test
```

Note: create-dmg outputs the DMG to the current working directory. The exact filename depends on what create-dmg generates from the app bundle version. If the filename differs from expected (e.g., includes spaces or different format), note the actual filename for Plan 02.
  </action>
  <verify>
Run: `ls -lh ./MD-Quick-Look-*.dmg` — should show a DMG file of reasonable size (2-20 MB)

Run: Mount DMG and verify it contains the app:
```bash
DMGFILE=$(ls ./MD-Quick-Look-*.dmg | head -1)
hdiutil attach "$DMGFILE" -mountpoint /tmp/mdql-verify
ls "/tmp/mdql-verify/MD Quick Look.app/Contents/Info.plist" && echo "APP OK"
ls "/tmp/mdql-verify/Applications" && echo "SYMLINK OK"
hdiutil detach /tmp/mdql-verify
```
Expected: "APP OK" and "SYMLINK OK"
  </verify>
  <done>
Unsigned DMG file exists in project root with version in filename. DMG contains MD Quick Look.app and an Applications symlink. DMG mounts correctly and app inside shows version 1.1.0.
  </done>
</task>

</tasks>

<verification>
1. Version 1.1.0 appears in both Info.plist files, all 4 MARKETING_VERSION entries in project.pbxproj
2. Built .app exists at build/Build/Products/Release/MD Quick Look.app with version 1.1.0
3. DMG file exists in project root matching pattern MD-Quick-Look-*.dmg
4. DMG mounts and contains the app bundle with Applications symlink
</verification>

<success_criteria>
- Info.plist and project.pbxproj all updated to version 1.1.0
- xcodebuild completes without errors
- Unsigned DMG created with create-dmg
- DMG verified mountable with correct contents
</success_criteria>

<output>
After completion, create `.planning/phases/09-distribution-packaging/09-01-SUMMARY.md`
</output>
