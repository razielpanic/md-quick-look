---
phase: 04-performance-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/PreviewViewController.swift
autonomous: true

must_haves:
  truths:
    - "Large files (>500KB) are truncated before rendering"
    - "Truncation message appears at bottom of preview showing file size"
    - "Small files (<500KB) render completely without truncation"
    - "Preview loads quickly without Finder freezing"
  artifacts:
    - path: "md-quick-look/MDQuickLook/PreviewViewController.swift"
      provides: "File size check and truncation logic"
      contains: "fileSize > maxSize"
  key_links:
    - from: "PreviewViewController.preparePreviewOfFile"
      to: "FileManager.attributesOfItem"
      via: "File size check before reading"
      pattern: "attributesOfItem.*\\.size"
---

<objective>
Implement file size truncation to ensure instant preview rendering for all file sizes.

Purpose: Prevent slow rendering or memory issues with large markdown files by reading only the first 500KB and showing a user-friendly truncation message.

Output: PreviewViewController that checks file size before reading, truncates large files, and displays truncation notice.
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance-and-polish/04-CONTEXT.md
@.planning/phases/04-performance-and-polish/04-RESEARCH.md
@md-quick-look/MDQuickLook/PreviewViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement file size checking and truncation</name>
  <files>md-quick-look/MDQuickLook/PreviewViewController.swift</files>
  <action>
Modify preparePreviewOfFile(at:completionHandler:) to:

1. Check file size BEFORE reading content:
```swift
let attrs = try FileManager.default.attributesOfItem(atPath: url.path)
guard let fileSize = attrs[.size] as? UInt64 else {
    handler(NSError(domain: "MDSpotlighter", code: -1, userInfo: [NSLocalizedDescriptionKey: "Cannot determine file size"]))
    return
}
```

2. Define truncation threshold:
```swift
let maxSize: UInt64 = 500_000  // 500KB - supports large docs while ensuring <1s render
```

3. For files OVER maxSize, read only first N bytes using FileHandle:
```swift
if fileSize > maxSize {
    guard let fileHandle = FileHandle(forReadingAtPath: url.path) else {
        handler(NSError(domain: "MDSpotlighter", code: -1, userInfo: [NSLocalizedDescriptionKey: "Cannot open file for reading"]))
        return
    }
    defer { try? fileHandle.close() }

    let data = fileHandle.readData(ofLength: Int(maxSize))
    var truncated = String(data: data, encoding: .utf8) ?? ""

    // Add user-friendly truncation message at bottom
    let sizeStr = ByteCountFormatter.string(fromByteCount: Int64(fileSize), countStyle: .file)
    truncated.append("\n\n---\n\nContent truncated (file is \(sizeStr))")
    markdownContent = truncated

    os_log("Truncated large file: %@ (%lld bytes, showing first 500KB)", log: .quicklook, type: .info, url.lastPathComponent, fileSize)
} else {
    // Read full file for typical sizes
    markdownContent = try String(contentsOf: url, encoding: .utf8)
}
```

4. Update the existing file reading logic to use the new truncation-aware approach.

5. Ensure proper error handling if file cannot be read or size cannot be determined.

IMPORTANT: The truncation message uses standard markdown horizontal rule (---) which will render as a visual separator. The warning text "Content truncated" appears after the separator so users can still read the available content first.
  </action>
  <verify>
Build succeeds: `make build` from project root.
Test manually with:
1. Create a 2MB test file: `python3 -c "print('# Test\\n\\n' + 'Lorem ipsum dolor sit amet. ' * 50000)" > /tmp/large-test.md`
2. Create a 10KB test file: `python3 -c "print('# Test\\n\\n' + 'Lorem ipsum dolor sit amet. ' * 500)" > /tmp/small-test.md`
3. Quick Look both files - large file shows truncation message, small file shows fully.
  </verify>
  <done>
- Files over 500KB are truncated and show "Content truncated (file is X.X MB)" at bottom
- Files under 500KB render completely
- Build completes without errors
  </done>
</task>

</tasks>

<verification>
1. Build passes: `make build`
2. Large file (>500KB) shows truncation message with file size
3. Small file (<500KB) renders completely without message
4. No Finder freezing when Quick Looking large files
</verification>

<success_criteria>
- PreviewViewController checks file size before reading
- Files over 500KB are truncated with user-friendly message
- Small files render without modification
- Extension builds and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-and-polish/04-01-SUMMARY.md`
</output>
