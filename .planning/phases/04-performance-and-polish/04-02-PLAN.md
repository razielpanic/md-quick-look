---
phase: 04-performance-and-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
  - md-quick-look/MDQuickLook/MarkdownLayoutManager.swift
  - md-quick-look/MDQuickLook/TableRenderer.swift
autonomous: false

must_haves:
  truths:
    - "Preview text is visible in both light and dark mode"
    - "Code block backgrounds adapt to system appearance"
    - "Inline code uses same background color as code blocks (consistent styling)"
    - "Blockquote borders and backgrounds adapt to system appearance"
    - "Table borders adapt to system appearance"
    - "Links have appropriate color in both modes"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Semantic color usage for text and links"
      contains: "NSColor.labelColor"
    - path: "md-quick-look/MDQuickLook/MarkdownLayoutManager.swift"
      provides: "Semantic color usage for borders"
      contains: "NSColor.separatorColor"
    - path: "md-quick-look/MDQuickLook/TableRenderer.swift"
      provides: "Semantic color usage for table cells"
      contains: "NSColor.labelColor"
  key_links:
    - from: "MarkdownRenderer.applyBaseStyles"
      to: "NSColor.labelColor"
      via: "Base text color"
      pattern: "\\.labelColor"
    - from: "MarkdownLayoutManager.drawBackground"
      to: "NSColor.separatorColor"
      via: "Blockquote border color"
      pattern: "separatorColor.*setStroke\\|setFill"
---

<objective>
Implement system color adoption for automatic dark mode support.

Purpose: Replace hard-coded or partially-correct colors with NSColor semantic colors that automatically adapt to macOS system appearance (light/dark mode), ensuring the preview looks native in any mode.

Output: All three rendering files use semantic colors that adapt automatically to system appearance.
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance-and-polish/04-CONTEXT.md
@.planning/phases/04-performance-and-polish/04-RESEARCH.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@md-quick-look/MDQuickLook/MarkdownLayoutManager.swift
@md-quick-look/MDQuickLook/TableRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MarkdownRenderer colors</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Update the following color usages to semantic colors:

1. In `applyBaseStyles(to:)` method (around line 542):
   - Change: `NSColor.textColor`
   - To: `NSColor.labelColor`
   - Reason: labelColor is the standard semantic color for primary text that adapts to appearance

2. In `insertListPrefixes(from:to:)` method (around line 525):
   - Change: `NSColor.textColor`
   - To: `NSColor.labelColor`
   - Location: In the prefixString attributes dictionary

3. In `applyLinkStyles(to:)` method (around line 757):
   - Change: `NSColor.systemBlue`
   - To: `NSColor.linkColor`
   - Reason: linkColor provides brighter blue in dark mode for better visibility

4. In `applyInlineCodeAttributes(to:)` method (around line 663):
   - Change: `NSColor.quaternarySystemFill`
   - To: `NSColor.secondarySystemFill`
   - Reason: Per user decision, inline code should use same background as code blocks for consistent styling

NOTE: The following color is ALREADY CORRECT and should NOT be changed:
- `NSColor.secondaryLabelColor` in applyImagePlaceholderStyles (line 801)

This is already a semantic color that adapts correctly.
  </action>
  <verify>
Build succeeds: `make build`
Grep confirms changes: `grep -n "labelColor\|linkColor\|secondarySystemFill" md-quick-look/MDQuickLook/MarkdownRenderer.swift`
  </verify>
  <done>
- applyBaseStyles uses NSColor.labelColor for text
- insertListPrefixes uses NSColor.labelColor for bullet/number text
- applyLinkStyles uses NSColor.linkColor for links
- applyInlineCodeAttributes uses NSColor.secondarySystemFill (matches code blocks)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MarkdownLayoutManager colors</name>
  <files>md-quick-look/MDQuickLook/MarkdownLayoutManager.swift</files>
  <action>
Update the blockquote border color in `drawBackground(forGlyphRange:at:)` method:

1. Find the blockquote border drawing section (around line 108):
   - Change: `NSColor.systemBlue.withAlphaComponent(0.4).setFill()`
   - To: `NSColor.separatorColor.setFill()`
   - Reason: separatorColor is the semantic color for borders/dividers that adapts to appearance

NOTE: The following colors are ALREADY CORRECT and should NOT be changed:
- `NSColor.quaternarySystemFill` for blockquote background (line 96)
- `NSColor.secondarySystemFill` for code block background (line 144)

These are already semantic colors that adapt correctly.
  </action>
  <verify>
Build succeeds: `make build`
Grep confirms: `grep -n "separatorColor" md-quick-look/MDQuickLook/MarkdownLayoutManager.swift`
  </verify>
  <done>
- Blockquote border uses NSColor.separatorColor
- Code block and blockquote backgrounds unchanged (already correct)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update TableRenderer colors</name>
  <files>md-quick-look/MDQuickLook/TableRenderer.swift</files>
  <action>
Update the cell text color in `renderCell()` method:

1. Find the foregroundColor assignment for non-empty cells (around line 205):
   - Change: `foregroundColor = NSColor.textColor`
   - To: `foregroundColor = NSColor.labelColor`
   - Reason: labelColor is the standard semantic color for primary text

NOTE: The following colors are ALREADY CORRECT and should NOT be changed:
- `NSColor.separatorColor` for header border (line 175)
- `NSColor.quaternaryLabelColor` for empty cell middot (line 202)

These are already semantic colors that adapt correctly.
  </action>
  <verify>
Build succeeds: `make build`
Grep confirms: `grep -n "labelColor" md-quick-look/MDQuickLook/TableRenderer.swift`
  </verify>
  <done>
- Table cell text uses NSColor.labelColor
- Header border color unchanged (already correct)
- Empty cell indicator color unchanged (already correct)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>System color adoption for automatic dark mode support across all rendering components</what-built>
  <how-to-verify>
1. Build and install: `make build && make install`
2. Test in Light Mode:
   - System Settings > Appearance > Light
   - Quick Look a markdown file with headings, code blocks, blockquotes, tables, and links
   - Verify: Text is dark on light background, code blocks have visible background, blockquote border visible
3. Test in Dark Mode:
   - System Settings > Appearance > Dark
   - Quick Look the same markdown file
   - Verify: Text is light on dark background, code blocks have visible background, blockquote border visible, links are brighter blue
4. Toggle between modes to confirm colors adapt automatically
  </how-to-verify>
  <resume-signal>Type "approved" if dark mode works correctly, or describe any visibility issues</resume-signal>
</task>

</tasks>

<verification>
1. Build passes: `make build`
2. All three files use semantic colors
3. Visual verification in both light and dark mode shows proper adaptation
4. No hard-coded black/white colors remain for text
</verification>

<success_criteria>
- MarkdownRenderer uses NSColor.labelColor and NSColor.linkColor
- MarkdownRenderer uses NSColor.secondarySystemFill for inline code (matches code blocks)
- MarkdownLayoutManager uses NSColor.separatorColor for blockquote border
- TableRenderer uses NSColor.labelColor for cell text
- Preview looks correct in both light and dark mode
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-and-polish/04-02-SUMMARY.md`
</output>
