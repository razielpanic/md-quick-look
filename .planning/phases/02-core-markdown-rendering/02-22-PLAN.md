---
phase: 02-core-markdown-rendering
plan: 22
type: execute
wave: 2
depends_on:
  - "02-21"
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Lines within a multi-line blockquote render on separate lines"
    - "Blockquote soft breaks are converted to hard breaks before parsing"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Blockquote soft break preprocessing"
      contains: "preprocessBlockquoteSoftBreaks"
  key_links:
    - from: "preprocessBlockquoteSoftBreaks"
      to: "AttributedString(markdown:)"
      via: "markdown preprocessing pipeline"
      pattern: "preprocessBlockquoteSoftBreaks.*preprocessedMarkdown"
---

<objective>
Fix blockquote line rendering by converting soft breaks to hard breaks in preprocessing.

Purpose: CommonMark-compliant AttributedString(markdown:) converts soft breaks (single newlines) to spaces within paragraphs. This causes multi-line blockquotes to render as single lines. Pre-processing the markdown to add trailing spaces before newlines within blockquotes converts them to hard breaks, preserving line separation.

Output: Blockquote lines render on separate lines as user expects.
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add blockquote soft break preprocessing</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Add a new preprocessing method `preprocessBlockquoteSoftBreaks(in:)` that converts soft breaks to hard breaks within blockquotes.

Pattern to match: A line starting with `>` (blockquote marker) followed by content, ending with a newline, where the NEXT line also starts with `>` (continuation).

Implementation:
1. Create method `private func preprocessBlockquoteSoftBreaks(in markdown: String) -> String`
2. Use regex pattern: `(>[^\n]*)\n(>)` - captures blockquote line content and the next blockquote marker
3. Replace with: `$1  \n$2` - adds two trailing spaces before newline (hard break in CommonMark)
4. Apply replacement globally (multiple occurrences)

Add to preprocessing pipeline in `render(markdown:)`:
- After `preprocessImages(in:)` but before `AttributedString(markdown:)`
- Chain: `let preprocessedMarkdown = preprocessBlockquoteSoftBreaks(in: preprocessImages(in: markdown))`

Note: The two trailing spaces (`  `) before `\n` create a hard break in CommonMark, forcing a line break instead of a space.
  </action>
  <verify>
Build succeeds: `cd . && xcodebuild -project md-quick-look/md-quick-look.xcodeproj -scheme md-quick-look -configuration Release build 2>&1 | tail -5`
  </verify>
  <done>
Method `preprocessBlockquoteSoftBreaks(in:)` exists and is called in render pipeline. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build, install, and verify blockquote rendering</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Build and install the updated extension:

```bash
cd .
make install
```

Verify by checking the rendered output of the comprehensive test file:
- The blockquote section (lines 55-58 in comprehensive.md) should now show each `>` line on a separate line
- "This is a blockquote." and "It can span multiple lines." should be on SEPARATE lines
  </action>
  <verify>
`make install` succeeds. Quick Look preview shows blockquote lines on separate lines.
  </verify>
  <done>
Extension installed. Blockquote lines within the same paragraph render on separate lines.
  </done>
</task>

</tasks>

<verification>
- Build: `xcodebuild` completes without errors
- Install: `make install` succeeds
- Visual: Blockquote in comprehensive.md shows 3 lines:
  1. "This is a blockquote."
  2. "It can span multiple lines."
  3. "And have multiple paragraphs."
</verification>

<success_criteria>
- Multi-line blockquotes render each `>` line on a separate visual line
- Soft breaks within blockquotes are converted to hard breaks
- No regression in other markdown elements
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-22-SUMMARY.md`
</output>
