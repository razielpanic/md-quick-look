---
phase: 02-core-markdown-rendering
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
  - samples/comprehensive.md
autonomous: false

must_haves:
  truths:
    - "User sees links rendered as styled text (blue, underlined)"
    - "User sees image placeholders showing [Image: filename] with SF Symbol icon"
    - "User can visually verify all markdown elements render correctly in Finder Quick Look"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Complete markdown renderer with all Phase 2 elements"
      contains: "NSTextAttachment"
    - path: "samples/comprehensive.md"
      provides: "Test file with all markdown element types"
      min_lines: 50
  key_links:
    - from: "MarkdownRenderer.swift"
      to: "NSImage(systemSymbolName:)"
      via: "SF Symbol for image placeholder"
      pattern: "systemSymbolName.*photo"
---

<objective>
Complete Phase 2 rendering with link styling, image placeholders using SF Symbols, and human verification of all elements.

Purpose: Finish the remaining MDRNDR requirements (links as styled text, image placeholders) and verify all Phase 2 elements render correctly in Finder.

Output: Complete MarkdownRenderer with all Phase 2 styling, comprehensive test file, user-verified rendering.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-markdown-rendering/02-CONTEXT.md
@.planning/phases/02-core-markdown-rendering/02-RESEARCH.md

# Files from Plans 01-02
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@md-spotlighter/MDQuickLook/PreviewViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add link styling and image placeholders to MarkdownRenderer</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Extend MarkdownRenderer to handle links and images.

**Links (MDRNDR-10):**
Links are automatically detected by AttributedString(markdown:) and have the `.link` attribute. Per user requirements, links should NOT be clickable but should be visually styled:
- Check for `run.link` attribute (contains URL)
- Apply styling:
  - foregroundColor: NSColor.systemBlue
  - underlineStyle: .single
- Do NOT make them clickable (Quick Look is read-only per CONTEXT.md)

**Images (MDRNDR-11):**
Images in markdown (`![alt](url)`) need to be rendered as placeholders since Quick Look cannot load external images.

The approach:
1. AttributedString(markdown:) doesn't preserve image syntax - it may convert to empty text or skip
2. We need to pre-process the markdown OR post-process to detect image patterns

**Recommended approach - post-process with regex:**
Before converting to NSAttributedString, scan the original markdown for image patterns and store their positions. After AttributedString processing, the images may be lost, so we need a different approach.

**Alternative approach - use swift-markdown for images only:**
Actually, the simplest approach for Quick Look: since AttributedString may strip images, and we just need placeholders, we can:
1. Pre-scan markdown with regex for `!\[([^\]]*)\]\(([^)]+)\)` patterns
2. Extract image references (alt text, URL -> filename)
3. After AttributedString processing, if we detect missing images, append placeholders at end

**Simplest approach (implement this):**
Since AttributedString may not handle images well, create a preprocessing step:
1. Regex find all `!\[([^\]]*)\]\(([^)]+)\)` in original markdown
2. Replace each with `[Image: filename]` text before passing to AttributedString
3. After AttributedString processing, find these placeholders and style them:
   - Add SF Symbol "photo" icon before the text using NSTextAttachment
   - Style with foregroundColor: NSColor.secondaryLabelColor

**Create helper method for image placeholder:**
```swift
private func createImagePlaceholder(filename: String) -> NSAttributedString {
    let attachment = NSTextAttachment()
    if let image = NSImage(systemSymbolName: "photo", accessibilityDescription: "Image") {
        let config = NSImage.SymbolConfiguration(pointSize: 14, weight: .regular)
        attachment.image = image.withSymbolConfiguration(config)
    }

    let result = NSMutableAttributedString(attachment: attachment)
    result.append(NSAttributedString(
        string: " [Image: \(filename)]",
        attributes: [
            .foregroundColor: NSColor.secondaryLabelColor,
            .font: NSFont.systemFont(ofSize: 14)
        ]
    ))
    return result
}
```

**Update render(markdown:) method:**
1. Add image preprocessing: replace `![alt](path)` with placeholder text
2. Process with AttributedString
3. Apply styling
4. Note: If preprocessing approach doesn't preserve image info, consider using swift-markdown Visitor as fallback
  </action>
  <verify>MarkdownRenderer.swift contains link styling (blue, underlined) and image placeholder handling with SF Symbol</verify>
  <done>Links render as blue underlined text. Images render as [Image: filename] placeholders with SF Symbol icon.</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive test file with all elements</name>
  <files>samples/comprehensive.md</files>
  <action>
Create a comprehensive markdown test file that includes ALL Phase 2 elements:

```markdown
# Comprehensive Markdown Test

This file tests all markdown elements supported by MD Spotlighter.

## Heading Hierarchy

### This is H3
#### This is H4
##### This is H5
###### This is H6

## Text Formatting

Regular text with **bold text**, *italic text*, and ~~strikethrough text~~.

You can also combine them: ***bold and italic*** or **bold with ~~strikethrough~~**.

## Code

Inline code: `const x = 42;`

Code block:

```javascript
function hello() {
    console.log("Hello, world!");
    return true;
}
```

Another code block:

```
Plain code block
with multiple lines
```

## Lists

### Unordered List

- First item
- Second item
- Third item with **bold**
- Fourth item

### Ordered List

1. First numbered item
2. Second numbered item
3. Third numbered item

## Blockquote

> This is a blockquote.
> It can span multiple lines.
>
> And have multiple paragraphs.

## Links

Here is a [link to example](https://example.com) in a sentence.

Another [link with longer text](https://github.com) here.

## Images

Here is an image reference:

![Screenshot](screenshot.png)

Another image:

![Logo](images/logo.svg)

---

*End of test file*
```

This file tests: h1-h6, bold, italic, strikethrough, combined formatting, inline code, code blocks, unordered lists, ordered lists, blockquotes, links, images.
  </action>
  <verify>samples/comprehensive.md exists with 60+ lines covering all element types</verify>
  <done>Comprehensive test file created with all Phase 2 markdown element types</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify all markdown elements render correctly</name>
  <what-built>Complete Phase 2 markdown rendering with all element types: headings (h1-h6 visual hierarchy), bold, italic, strikethrough, inline code, code blocks (SF Mono + background), blockquotes (left border bar), lists (indentation), links (blue underlined), image placeholders (SF Symbol + filename)</what-built>
  <how-to-verify>
1. Run `make install` to install the updated extension
2. In Finder, navigate to the samples/ directory
3. Select `comprehensive.md` and press Spacebar to open Quick Look
4. Verify each element renders correctly:

**Headings:**
- [ ] H1 is largest, H6 is smallest
- [ ] Clear visual hierarchy between levels

**Text Formatting:**
- [ ] Bold text has heavier weight
- [ ] Italic text has oblique style
- [ ] Strikethrough has line through text

**Code:**
- [ ] Inline code has monospace font (SF Mono)
- [ ] Inline code has subtle background
- [ ] Code blocks have monospace font
- [ ] Code blocks have distinct background color

**Lists:**
- [ ] Unordered list has bullet points
- [ ] Ordered list has numbers
- [ ] Both have proper indentation

**Blockquotes:**
- [ ] Left vertical bar visible (blue-ish)
- [ ] Text indented from left

**Links:**
- [ ] Links are blue and underlined
- [ ] Links are NOT clickable (read-only)

**Images:**
- [ ] Image placeholders show SF Symbol icon
- [ ] Image placeholders show [Image: filename]
- [ ] Styled with secondary label color

**Overall:**
- [ ] Preview loads instantly (no spinner)
- [ ] Text is readable and well-spaced

If Dark Mode is available, toggle it and verify colors adapt appropriately.
  </how-to-verify>
  <resume-signal>Type "approved" if all elements render correctly, or describe any issues that need fixing</resume-signal>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. MarkdownRenderer.swift handles links and images
3. samples/comprehensive.md exists with all element types
4. Human verification confirms all elements render correctly
</verification>

<success_criteria>
Phase 2 complete when human verifies:
- Headings (h1-h6) show visual hierarchy (MDRNDR-01)
- Bold text renders correctly (MDRNDR-02)
- Italic text renders correctly (MDRNDR-03)
- Strikethrough renders correctly (MDRNDR-04)
- Unordered lists have bullets and indentation (MDRNDR-05)
- Ordered lists have numbers and indentation (MDRNDR-06)
- Code blocks have monospace font and background (MDRNDR-07)
- Blockquotes have left border bar (MDRNDR-08)
- Links render as styled text (MDRNDR-10)
- Images show as placeholders with SF Symbol (MDRNDR-11)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-03-SUMMARY.md`
</output>
