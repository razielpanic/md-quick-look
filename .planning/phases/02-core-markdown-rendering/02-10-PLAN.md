---
phase: 02-core-markdown-rendering
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/PreviewViewController.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Quick Look preview window is scrollable"
    - "User can scroll to see all markdown content including images section"
    - "Image placeholders visible when scrolled into view show correct format"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/PreviewViewController.swift"
      provides: "Scrollable Quick Look preview"
      contains: "NSScrollView"
  key_links:
    - from: "PreviewViewController"
      to: "NSScrollView"
      via: "scrollView.documentView = textView"
      pattern: "hasVerticalScroller"
---

<objective>
Enable Quick Look scrolling and verify image placeholder display (Gap #19 + verify Gap #14)

UAT round 4 found: Quick Look preview window is NOT scrollable. User cannot scroll to the images section to verify Gap #14 fix. Window "defaults to odd shape/size."

This plan:
1. Investigates why scrolling is not working despite NSScrollView being present
2. Fixes the scrolling issue so all content is accessible
3. Adds debug output to verify image placeholders are working once visible

Purpose: Unblock image placeholder verification and ensure full document is viewable
Output: Scrollable Quick Look preview that shows all content including image placeholders
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND4.md
@md-spotlighter/MDQuickLook/PreviewViewController.swift
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix Quick Look scrolling</name>
  <files>md-spotlighter/MDQuickLook/PreviewViewController.swift</files>
  <action>
The current PreviewViewController already has NSScrollView configured (lines 35-39):
```swift
let scrollView = NSScrollView(frame: view.bounds)
scrollView.autoresizingMask = [.width, .height]
scrollView.hasVerticalScroller = true
scrollView.hasHorizontalScroller = false
```

But UAT reports scrolling does not work. Debug and fix:

1. **Check view frame sizing**: The initial view is 800x600 but Quick Look window may have different constraints. Ensure the scroll view fills its parent correctly.

2. **Check textView sizing**: The textView needs to properly report its size to the scroll view. Ensure:
   - `textView.isVerticallyResizable = true`
   - `textView.isHorizontallyResizable = false`
   - `textView.minSize` and `textView.maxSize` are set correctly

3. **Add explicit scroll configuration**:
```swift
// After creating textView
textView.isVerticallyResizable = true
textView.isHorizontallyResizable = false
textView.minSize = NSSize(width: 0, height: 0)
textView.maxSize = NSSize(width: CGFloat.greatestFiniteMagnitude, height: CGFloat.greatestFiniteMagnitude)

// Ensure text container tracks height properly
textContainer.heightTracksTextView = false  // Allow infinite height
```

4. **Check scroll view content size**: After setting up, the scroll view's documentView (textView) must have correct frame. Add logging:
```swift
os_log("ScrollView contentSize: %@", log: .quicklook, type: .debug, NSStringFromSize(scrollView.contentSize))
os_log("TextView frame: %@", log: .quicklook, type: .debug, NSStringFromRect(textView.frame))
```

5. **Force layout if needed**: The text might not be laid out before handler returns. Force layout:
```swift
layoutManager.ensureLayout(forCharacterRange: NSRange(location: 0, length: textStorage.length))
```

6. **Verify scroll works** by adding test scroll position log after layout:
```swift
os_log("Content height after layout: %f", log: .quicklook, type: .debug, textView.frame.height)
```

The key insight: Quick Look extensions may have different sizing behavior than normal views. Ensure textView reports its full content height to the scroll view.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: 1) Scroll bar appears on right side, 2) Can scroll down to see images section, 3) All content visible when scrolled.</verify>
  <done>Quick Look preview is scrollable and all content including image section is accessible</done>
</task>

<task type="auto">
  <name>Task 2: Verify image placeholder display after scrolling works</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Once scrolling works, verify that Gap #14 (image placeholders) is actually fixed.

1. **Add enhanced logging** to `applyImagePlaceholderStyles()`:
```swift
os_log("MarkdownRenderer: Searching for image markers in text of length %d", log: .renderer, type: .info, nsAttributedString.length)

// Log the actual text content around where images should be (for debugging)
let previewText = nsAttributedString.string.prefix(500)
os_log("MarkdownRenderer: First 500 chars: %{public}@", log: .renderer, type: .debug, String(previewText))
```

2. **Log what the regex finds**:
```swift
for match in matches {
    let matchedText = text.substring(with: match.range)
    os_log("MarkdownRenderer: Found image marker: %{public}@", log: .renderer, type: .info, matchedText)
}
```

3. **Log after replacement**:
```swift
os_log("MarkdownRenderer: Replaced %d image markers with placeholders", log: .renderer, type: .info, matches.count)
```

4. **Check Console.app** output when previewing comprehensive.md:
   - Should see "Found 2 image markers to replace" (for screenshot.png and logo.svg)
   - Should see each marker being found and replaced
   - Should NOT see any markers in the rendered text

If logging shows markers are found but replacement fails, investigate the `createImagePlaceholder()` function.
If logging shows markers are NOT found, investigate `preprocessImages()` - the marker format may still be getting modified by AttributedString.
  </action>
  <verify>Check Console.app logs while running `qlmanage -p samples/comprehensive.md`. Verify: 1) "Found 2 image markers" logged, 2) Both markers replaced. Visual verify: 3) Photo icon visible, 4) "[Image: filename]" format, 5) Gray color.</verify>
  <done>Image placeholders display correctly with SF Symbol icon, square brackets, and gray color</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` opens scrollable preview:
   - Vertical scroll bar visible on right
   - Can scroll to bottom of document
   - All sections accessible
3. Images section (when scrolled into view):
   - SF Symbol "photo" icon displays
   - Text format: "[Image: screenshot.png]" and "[Image: logo.svg]"
   - Text color is gray (secondaryLabelColor), NOT blue
   - No marker text exposed ("__IMAGE_PLACEHOLDER__" etc.)
4. Console.app shows successful image marker replacement logs
</verification>

<success_criteria>
- Quick Look preview is scrollable with visible scroll bar
- Can scroll to see entire document including images section
- Image placeholders render with photo icon, square brackets, filename, gray color
- No preprocessing markers visible
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-10-SUMMARY.md`
</output>
