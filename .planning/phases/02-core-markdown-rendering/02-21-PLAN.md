---
phase: 02-core-markdown-rendering
plan: 21
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees list items with single prefix (one bullet or number per item)"
    - "User sees list items with inline formatting rendered correctly on single line"
    - "User sees 'Third item with bold' as one bullet, not 'Third item with bullet bold'"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed insertListPrefixes with ordinal tracking"
      contains: "lastProcessedOrdinal"
  key_links:
    - from: "insertListPrefixes"
      to: "list prefix insertion"
      via: "Ordinal change detection"
      pattern: "ordinal != lastProcessedOrdinal"
---

<objective>
Fix duplicate list item prefixes for items with inline formatting (Gap #29).

Purpose: The `insertListPrefixes()` function inserts a prefix at the START of every run that has `.listItem` in its presentation intent. When a list item contains inline formatting (bold, italic, etc.), AttributedString creates multiple runs for the same list item. This causes multiple prefixes: "Third item with bold" becomes "bullet Third item with bullet bold".

Output: List items with inline formatting show only one prefix at the start, preserving proper formatting.
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ordinal tracking to insertListPrefixes</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Modify `insertListPrefixes()` (currently lines 219-292) to track the last processed ordinal and only insert a prefix when the ordinal changes (first run of each list item).

The current implementation adds a prefix for EVERY run with a list item ordinal:
```swift
if let ordinal = ordinal {
    let nsRange = NSRange(run.range, in: attributedString)
    let prefix: String
    // ... determine prefix
    listItems.append(ListItemInfo(range: nsRange, prefix: prefix))
}
```

Change to track last processed ordinal:

1. Add tracking variable before the loop:
   ```swift
   var lastProcessedOrdinal: Int?
   ```

2. Only add to listItems if ordinal is different from last processed:
   ```swift
   if let ordinal = ordinal {
       // Only insert prefix for FIRST run of each list item
       // Subsequent runs with same ordinal are inline formatting within the item
       if ordinal != lastProcessedOrdinal {
           let nsRange = NSRange(run.range, in: attributedString)
           let prefix: String

           if isOrderedList {
               prefix = "\(ordinal). "
           } else if isUnorderedList {
               prefix = "bullet "
           } else {
               prefix = "bullet "
           }

           listItems.append(ListItemInfo(range: nsRange, prefix: prefix))
           lastProcessedOrdinal = ordinal

           os_log("MarkdownRenderer: Found list item (ordinal: %d, ordered: %d, prefix: %{public}s)",
                  log: .renderer, type: .debug, ordinal, isOrderedList ? 1 : 0, prefix)
       }
   }
   ```

This follows the same ordinal tracking pattern used in:
- `insertBlockBoundaryNewlines()` lines 144-148 (checks `differentListItem` before inserting newline)
- The new `ensureIntraBlockNewlines()` with identity tracking (from plan 02-20)

The key insight: All runs of the same list item have the same ordinal. Only the first run (when ordinal changes) should get a prefix.
  </action>
  <verify>
Run `xcodebuild build -scheme md-quick-look -configuration Release -derivedDataPath build` and verify compilation succeeds with no errors.

Then run `qlmanage -p samples/comprehensive.md` and visually verify:
- "Third item with **bold**" shows as "bullet Third item with bold" (one bullet)
- NOT "bullet Third item with bullet bold" (two bullets)
- All list items still have proper prefixes
- Ordered lists show correct numbering (1., 2., 3.)
  </verify>
  <done>
List items with inline formatting show single prefix. "Third item with bold" displays with one bullet at the start. Gap #29 is closed.
  </done>
</task>

</tasks>

<verification>
Build verification:
```bash
xcodebuild build -scheme md-quick-look -configuration Release -derivedDataPath build
```

Code verification:
- `insertListPrefixes()` contains `lastProcessedOrdinal` tracking
- List prefix insertion is conditional on ordinal change
- Build completes without errors

Visual verification:
- `qlmanage -p samples/comprehensive.md` shows list items with single prefixes
- "Third item with bold" has ONE bullet, not two
</verification>

<success_criteria>
- Build succeeds without errors
- `insertListPrefixes()` tracks last processed ordinal
- List items with inline formatting show single prefix
- All list items still render with appropriate bullets/numbers
- No regressions in other elements
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-21-SUMMARY.md`
</output>
