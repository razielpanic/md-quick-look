---
phase: 02-core-markdown-rendering
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Image placeholders show [Image: filename] format with square brackets"
    - "Image placeholders display in gray color (secondaryLabelColor)"
    - "Image placeholders show SF Symbol photo icon before text"
    - "Bold+strikethrough combination renders both styles"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed image placeholder format and combined formatting"
      contains: "[Image:"
  key_links:
    - from: "createImagePlaceholder"
      to: "NSTextAttachment"
      via: "SF Symbol attachment with explicit bounds"
      pattern: "attachment.bounds"
---

<objective>
Fix image placeholder formatting and combined inline styles

UAT found: image placeholders display with angle brackets instead of square brackets, show blue instead of gray, and the SF Symbol icon doesn't appear. Also, bold+strikethrough combination doesn't render both styles.

Purpose: Address major UAT gaps - image placeholders must be visually distinct from links, combined formatting must work
Output: Correct image placeholder format with icon, working bold+strikethrough
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-markdown-rendering/02-UAT.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix image placeholder formatting</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reported: "there is no icon. your question shows square brackets, but the plugin renders angle brackets. no space after 'IMAGE:'. Not in gray color; it's blue"

Current code analysis:
- `preprocessImages` creates `<<IMAGE:\(filename)>>` markers (angle brackets intentional as internal markers)
- `applyImagePlaceholderStyles` should REPLACE those markers with `[Image: filename]`
- `createImagePlaceholder` returns ` [Image: \(filename)]` with space before bracket

Possible issues:
1. The regex pattern `"<<IMAGE:([^>]+)>>"` might not be matching correctly
2. The replacement might be failing silently
3. The markers might be getting styled by link styling (hence blue)

Debug steps:
1. Add debug logging in `applyImagePlaceholderStyles` to see if regex matches are found
2. Check if `matches.count` is 0 - if so, the pattern isn't matching

Fix the image placeholder:
1. Ensure regex pattern correctly matches the preprocessing output
2. After replacement, verify the text actually changed (log before/after length)
3. The SF Symbol icon needs NSTextAttachment with explicit bounds - verify bounds are set (current code: CGRect(x: 0, y: -3, width: 14, height: 14))

Color fix:
The current code uses `NSColor.secondaryLabelColor` which is gray. If showing blue, link styling is being applied AFTER image placeholder styling. Check the order of style application in render() method:
- `applyLinkStyles` runs after `applyImagePlaceholderStyles`
- Link styling uses `.link` attribute which may exist on the text

Solution: In `applyImagePlaceholderStyles`, after replacing text, also REMOVE the `.link` attribute from the replacement range to prevent link styling from applying.

Or: Run `applyImagePlaceholderStyles` AFTER `applyLinkStyles` and explicitly set foreground color.

Verify the SF Symbol is loading:
```swift
if let image = NSImage(systemSymbolName: "photo", accessibilityDescription: "Image") {
    // This should work on macOS 11+
}
```

If icon still not showing, try:
- Using a larger bounds: CGRect(x: 0, y: -4, width: 16, height: 16)
- Setting attachment.image before setting bounds
- Verifying the configured image is not nil
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify image placeholders show: SF Symbol icon, "[Image: filename]" text (square brackets, space after colon), gray color.</verify>
  <done>Image placeholders render correctly with icon, square brackets, proper spacing, and gray color</done>
</task>

<task type="auto">
  <name>Task 2: Fix combined bold+strikethrough formatting</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reported: "missing strikethrough on bold combination"

Test case from comprehensive.md: `**bold with ~~strikethrough~~**`

Current behavior: Bold applies but strikethrough doesn't (or vice versa).

Root cause analysis:
AttributedString(markdown:) applies `inlinePresentationIntent` for formatting:
- Bold: `.stronglyEmphasized` or `.emphasized`
- Strikethrough: `.strikethrough`

The current code only checks for `.code` in `applyInlineStyles`:
```swift
if inlineIntent.contains(.code) {
    applyInlineCodeAttributes(...)
}
```

It does NOT apply strikethrough styling! Bold/italic come from AttributedString automatically, but strikethrough needs explicit NSAttributedString attribute.

Fix:
1. In `applyInlineStyles`, add handling for `.strikethrough`:
```swift
if inlineIntent.contains(.strikethrough) {
    nsAttributedString.addAttribute(.strikethroughStyle,
                                   value: NSUnderlineStyle.single.rawValue,
                                   range: nsRange)
}
```

2. This works independently of bold - both attributes can coexist on same range

Note: Bold (.stronglyEmphasized) and italic (.emphasized) are handled by AttributedString's automatic conversion to NSAttributedString font traits. But strikethrough requires explicit `.strikethroughStyle` attribute.

Also check: If there are "missing spaces" in combined formatting, this could be related to how inlinePresentationIntent runs are segmented. Each run may have different intents, causing word boundaries to be mishandled. This is likely a separate issue from strikethrough styling.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Find the line "You can also combine them: ***bold and italic*** or **bold with ~~strikethrough~~**." - verify strikethrough renders with the line through the text.</verify>
  <done>Combined bold+strikethrough text shows both bold weight AND strikethrough line</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Image placeholders with SF Symbol icon visible
   - Image text format: "[Image: filename]" (not angle brackets)
   - Image placeholder text in gray (not blue)
   - Combined **bold with ~~strikethrough~~** shows both styles
3. No regression in link styling (links still blue and underlined)
</verification>

<success_criteria>
- Image placeholders show SF Symbol "photo" icon
- Image placeholders use [Image: filename] format with square brackets
- Image placeholder text is gray (secondaryLabelColor)
- Bold+strikethrough combination renders both bold weight and strikethrough line
- Existing link styling unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-05-SUMMARY.md`
</output>
