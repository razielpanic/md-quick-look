---
phase: 02-core-markdown-rendering
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Image placeholders show [Image: filename] format with square brackets"
    - "Image placeholders display in gray color (secondaryLabelColor)"
    - "Image placeholders show SF Symbol photo icon before text"
    - "Strikethrough text renders with line through characters (standalone and in combinations)"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed image placeholder format and combined formatting"
      contains: "[Image:"
  key_links:
    - from: "createImagePlaceholder"
      to: "NSTextAttachment"
      via: "SF Symbol attachment with explicit bounds"
      pattern: "attachment.bounds"
---

<objective>
Fix image placeholder formatting and combined inline styles

UAT found: image placeholders display with angle brackets instead of square brackets, show blue instead of gray, and the SF Symbol icon doesn't appear. Also, bold+strikethrough combination doesn't render both styles.

Purpose: Address major UAT gaps - image placeholders must be visually distinct from links, combined formatting must work
Output: Correct image placeholder format with icon, working bold+strikethrough
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-markdown-rendering/02-UAT.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix image placeholder formatting</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reported: "there is no icon. your question shows square brackets, but the plugin renders angle brackets. no space after 'IMAGE:'. Not in gray color; it's blue"

Fix the image placeholder in `applyImagePlaceholderStyles`:

1. Verify the regex pattern `"<<IMAGE:([^>]+)>>"` matches the preprocessing output from `preprocessImages` which creates `<<IMAGE:\(filename)>>` markers

2. After replacing text with the placeholder, REMOVE the `.link` attribute from the replacement range to prevent blue link styling:
   ```swift
   nsAttributedString.removeAttribute(.link, range: newRange)
   ```

3. For the SF Symbol icon, set the image BEFORE setting bounds:
   ```swift
   let attachment = NSTextAttachment()
   attachment.image = NSImage(systemSymbolName: "photo", accessibilityDescription: "Image")
   attachment.bounds = CGRect(x: 0, y: -4, width: 16, height: 16)
   ```

4. Ensure the replacement produces `[Image: filename]` format (square brackets, space after colon)

5. Apply `.foregroundColor: NSColor.secondaryLabelColor` to the full replacement range after all attributes are set
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify image placeholders show: SF Symbol icon, "[Image: filename]" text (square brackets, space after colon), gray color.</verify>
  <done>Image placeholders render correctly with icon, square brackets, proper spacing, and gray color</done>
</task>

<task type="auto">
  <name>Task 2: Add strikethrough support for all text</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The codebase is missing strikethrough rendering entirely. UAT reported "missing strikethrough on bold combination" - but the root issue is strikethrough is not implemented at all.

AttributedString(markdown:) parses `~~text~~` and sets `inlinePresentationIntent` to `.strikethrough`, but the current `applyInlineStyles` only handles `.code`. Bold/italic come from AttributedString's automatic font trait conversion, but strikethrough requires explicit NSAttributedString attribute.

Add strikethrough support in `applyInlineStyles`:

```swift
if inlineIntent.contains(.strikethrough) {
    nsAttributedString.addAttribute(.strikethroughStyle,
                                   value: NSUnderlineStyle.single.rawValue,
                                   range: nsRange)
}
```

This attribute coexists with bold/italic - both will render together on the same range. No changes needed for combined formatting specifically; once strikethrough is implemented, combinations work automatically.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: 1) Standalone strikethrough text (~~text~~) shows line through, 2) Combined bold+strikethrough (**bold with ~~strikethrough~~**) shows both styles.</verify>
  <done>Strikethrough text renders with line through characters, both standalone and in combinations with bold/italic</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Image placeholders with SF Symbol icon visible
   - Image text format: "[Image: filename]" (not angle brackets)
   - Image placeholder text in gray (not blue)
   - Combined **bold with ~~strikethrough~~** shows both styles
3. No regression in link styling (links still blue and underlined)
</verification>

<success_criteria>
- Image placeholders show SF Symbol "photo" icon
- Image placeholders use [Image: filename] format with square brackets
- Image placeholder text is gray (secondaryLabelColor)
- Bold+strikethrough combination renders both bold weight and strikethrough line
- Existing link styling unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-05-SUMMARY.md`
</output>
