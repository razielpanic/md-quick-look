---
phase: 02-core-markdown-rendering
plan: 16
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Image placeholders display with SF Symbol photo icon"
    - "Image placeholder text shows [Image: filename] format"
    - "Image placeholder text is gray (secondaryLabelColor)"
    - "No preprocessing markers visible in rendered output"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Working image placeholder replacement"
      contains: "createImagePlaceholder"
  key_links:
    - from: "preprocessImages"
      to: "applyImagePlaceholderStyles"
      via: "marker text survives AttributedString conversion"
      pattern: "IMAGEPLACEHOLDER"
---

<objective>
Fix image placeholder rendering - Gap #25 (BLOCKER)

UAT round 5 shows: `IMAGE_PLACEHOLDER__screenshot.png__END` visible in output (missing leading `__`).

**Root cause diagnosed:** `AttributedString(markdown:)` interprets leading underscores as emphasis markers and strips them. The marker `__IMAGE_PLACEHOLDER__filename__END__` becomes `IMAGE_PLACEHOLDER__filename__END` after parsing.

Previous attempts used:
- `__IMAGE_PLACEHOLDER__` markers - underscores stripped
- `[Image: filename]` plain text - converted to link by AttributedString

**Solution:** Use a marker without special markdown characters. Replace underscores with uppercase letters that won't be interpreted as formatting.

Purpose: Make image placeholders work correctly with icon, gray text, and proper formatting
Output: Working image placeholder display without exposed markers
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix image placeholder markers to survive AttributedString parsing</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The underscores in `__IMAGE_PLACEHOLDER__` are being stripped by AttributedString because it interprets them as markdown emphasis markers. Fix by using alphanumeric-only markers.

**Step 1: Update preprocessImages() marker format**

In the `preprocessImages()` function (around line 508), change the placeholder format from:
```swift
let placeholder = "__IMAGE_PLACEHOLDER__\(filename)__END__"
```

To use uppercase letters without underscores:
```swift
let placeholder = "IMAGEPLACEHOLDERSTART\(filename)IMAGEPLACEHOLDEREND"
```

This marker:
- Contains no underscores (won't be interpreted as emphasis)
- Contains no brackets (won't be interpreted as links)
- Contains no asterisks (won't be interpreted as bold/italic)
- Is unlikely to appear naturally in markdown content

**Step 2: Update applyImagePlaceholderStyles() regex pattern**

In the `applyImagePlaceholderStyles()` function (around line 547), change the pattern from:
```swift
let pattern = "__IMAGE_PLACEHOLDER__(.+?)__END__"
```

To match the new format:
```swift
let pattern = "IMAGEPLACEHOLDERSTART(.+?)IMAGEPLACEHOLDEREND"
```

**Step 3: Verify the createImagePlaceholder helper still works**

The `createImagePlaceholder(filename:)` function (around line 588) should remain unchanged - it creates the final styled output with SF Symbol and gray text.

**Step 4: Test the fix by building and previewing**

Run `make build` and verify compilation, then preview a markdown file with images.
  </action>
  <verify>make build && qlmanage -p samples/comprehensive.md 2>&1 | head -50</verify>
  <done>Image placeholders render with photo icon, gray [Image: filename] text, no exposed markers</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - SF Symbol "photo" icon before each image placeholder
   - Text format: "[Image: screenshot.png]" and "[Image: logo.svg]"
   - Gray color (secondaryLabelColor)
   - No marker text visible (IMAGEPLACEHOLDER, __IMAGE_PLACEHOLDER__, etc.)
</verification>

<success_criteria>
- Image placeholders display with photo SF Symbol icon
- Text format is "[Image: filename]"
- Text color is gray (secondaryLabelColor)
- No preprocessing markers visible in rendered output
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-16-SUMMARY.md`
</output>
