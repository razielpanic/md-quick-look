---
phase: 02-core-markdown-rendering
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Image placeholders display correctly with SF Symbol icon, square brackets, and gray color"
    - "Image placeholders do NOT show <<IMAGE:filename>> marker text"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Working image placeholder replacement"
      contains: "applyImagePlaceholderStyles"
  key_links:
    - from: "applyImagePlaceholderStyles"
      to: "createImagePlaceholder"
      via: "replaceCharacters"
      pattern: "<<IMAGE:"
---

<objective>
Fix image placeholder replacement (BLOCKER - Gap #14)

UAT re-test found: image placeholders show `<IMAGE:filename>` in blue text instead of `[Image: filename]` in gray with SF Symbol icon. The preprocessing markers are being exposed to the user.

Root cause: The regex replacement in `applyImagePlaceholderStyles` is not matching the markers OR the replacement is failing silently.

Purpose: Fix the BLOCKER gap preventing Phase 2 completion
Output: Image placeholders render correctly with icon and proper formatting
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix image placeholder replacement</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Debug the image placeholder issue. UAT reports: "no icon, blue text, angle brackets not square"

Hypothesis: The preprocessing creates `<<IMAGE:filename>>` but either:
1. The regex pattern doesn't match after AttributedString processing
2. The replacement happens but gets overwritten by subsequent processing
3. AttributedString is modifying the marker text

Investigation steps:

1. Check the preprocessing output. The marker format in `preprocessImages` is:
   ```swift
   let placeholder = "<<IMAGE:\(filename)>>"
   ```
   But UAT reports `<IMAGE:filename>` (single angle brackets, no space). This suggests AttributedString is consuming one angle bracket on each side.

2. Fix: Change the preprocessing marker to use a format that won't be parsed by AttributedString:
   ```swift
   // Change from:
   let placeholder = "<<IMAGE:\(filename)>>"
   // To:
   let placeholder = "__IMAGE_PLACEHOLDER__\(filename)__END__"
   ```

3. Update the regex pattern in `applyImagePlaceholderStyles` to match:
   ```swift
   // Change from:
   let pattern = "<<IMAGE:([^>]+)>>"
   // To:
   let pattern = "__IMAGE_PLACEHOLDER__(.+?)__END__"
   ```

4. Verify the replacement actually happens by adding logging:
   ```swift
   os_log("MarkdownRenderer: Found %d image markers to replace", log: .renderer, type: .info, matches.count)
   ```

5. After replacing, ensure the gray color is applied:
   ```swift
   // After replaceCharacters, apply foreground color to the whole range
   nsAttributedString.addAttribute(.foregroundColor, value: NSColor.secondaryLabelColor, range: newRange)
   ```

The key insight: AttributedString(markdown:) likely interprets `<<` as something (possibly HTML-like entities). Using underscores creates a marker that won't be modified.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Check: 1) No "__IMAGE_PLACEHOLDER__" or "<<IMAGE:" text visible, 2) Photo icon appears, 3) Text shows "[Image: filename]" format, 4) Gray color (not blue).</verify>
  <done>Image placeholders display correctly without preprocessing markers exposed</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. Open Console.app and filter for "md-quick-look" to see logging output
3. `qlmanage -p samples/comprehensive.md` shows image placeholders:
   - SF Symbol "photo" icon visible
   - Text format: "[Image: screenshot.png]" and "[Image: logo.svg]"
   - Text color is gray (secondaryLabelColor), NOT blue
   - No marker text exposed (`<<IMAGE:...>>` or `__IMAGE_PLACEHOLDER__...`)
</verification>

<success_criteria>
- Image section in comprehensive.md shows proper placeholders
- No preprocessing markers visible in the rendered output
- Icon + text format with gray color
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-07-SUMMARY.md`
</output>
