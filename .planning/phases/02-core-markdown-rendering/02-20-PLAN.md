---
phase: 02-core-markdown-rendering
plan: 20
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees blockquotes with normal line spacing (no excessive gaps between lines)"
    - "User sees blockquote paragraphs properly separated (single blank line between paragraphs)"
    - "User sees blockquote visual differentiation preserved (border and background)"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed ensureIntraBlockNewlines with blockquote identity tracking"
      contains: "previousBlockquoteIdentity"
  key_links:
    - from: "ensureIntraBlockNewlines"
      to: "blockquote newlines"
      via: "Identity change detection"
      pattern: "previousBlockquoteIdentity != currentBlockquoteIdentity"
---

<objective>
Fix blockquote excessive spacing regression from Gap #27 fix (plan 02-19).

Purpose: The simplification in plan 02-19 made `ensureIntraBlockNewlines()` add newlines after EVERY blockquote run. This creates excessive gaps between lines within the same blockquote paragraph. Need to differentiate between intra-paragraph runs (no newline needed) and inter-paragraph runs (newline needed).

Output: Blockquotes render with normal line spacing within paragraphs and proper separation between paragraphs.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add blockquote identity tracking to ensureIntraBlockNewlines</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Modify `ensureIntraBlockNewlines()` (currently lines 176-211) to track blockquote identity and only add newlines at paragraph boundaries.

The current implementation adds a newline after EVERY blockquote run:
```swift
if isBlockquote {
    let runText = String(attributedString[run.range].characters)
    if !runText.hasSuffix("\n") {
        insertionPositions.append(run.range.upperBound)
    }
}
```

Change to track blockquote identity (similar pattern to `insertBlockBoundaryNewlines()` lines 123-129):

1. Add tracking variables before the loop:
   ```swift
   var previousBlockquoteIdentity: Int?
   ```

2. Inside the loop, after checking `isBlockquote`, extract the blockquote identity:
   ```swift
   var currentBlockquoteIdentity: Int?
   for component in intent.components {
       if case .blockQuote = component.kind {
           currentBlockquoteIdentity = component.identity
           break
       }
   }
   ```

3. Only add newline if blockquote identity changes (different paragraph):
   ```swift
   if isBlockquote {
       // Only add newline at paragraph boundaries (identity change)
       // Skip for runs within the same blockquote paragraph
       if previousBlockquoteIdentity != nil && previousBlockquoteIdentity != currentBlockquoteIdentity {
           let runText = String(attributedString[run.range].characters)
           if !runText.hasSuffix("\n") {
               insertionPositions.append(run.range.upperBound)
           }
       }
       previousBlockquoteIdentity = currentBlockquoteIdentity
   }
   ```

4. Also update logging to include identity information for debugging.

This follows the same ordinal/identity tracking pattern used in:
- `insertBlockBoundaryNewlines()` lines 123-129 (list item ordinal extraction)
- `insertBlockBoundaryNewlines()` lines 144-148 (ordinal comparison before newline)

The key insight: Within the same blockquote paragraph, all runs have the same identity. Only when identity changes (new paragraph) do we need a newline.
  </action>
  <verify>
Run `xcodebuild build -scheme md-quick-look -configuration Release -derivedDataPath build` and verify compilation succeeds with no errors.

Then run `qlmanage -p samples/comprehensive.md` and visually verify:
- Blockquote lines within same paragraph appear consecutive (no extra gaps)
- Different blockquote paragraphs have proper separation
- Blockquote border/background still renders correctly
  </verify>
  <done>
Blockquotes render with normal line spacing within paragraphs and proper separation between paragraphs. Gap #28 is closed.
  </done>
</task>

</tasks>

<verification>
Build verification:
```bash
xcodebuild build -scheme md-quick-look -configuration Release -derivedDataPath build
```

Code verification:
- `ensureIntraBlockNewlines()` contains `previousBlockquoteIdentity` tracking
- Blockquote newline insertion is conditional on identity change
- Build completes without errors

Visual verification:
- `qlmanage -p samples/comprehensive.md` shows blockquotes with normal spacing
</verification>

<success_criteria>
- Build succeeds without errors
- `ensureIntraBlockNewlines()` tracks blockquote identity
- Blockquote lines within same paragraph show normal spacing (no excessive gaps)
- Blockquote paragraphs remain properly separated
- No regressions in other elements
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-20-SUMMARY.md`
</output>
