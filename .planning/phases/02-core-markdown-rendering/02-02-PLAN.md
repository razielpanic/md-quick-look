---
phase: 02-core-markdown-rendering
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
  - md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift
  - md-spotlighter/MDQuickLook/PreviewViewController.swift
autonomous: true

must_haves:
  truths:
    - "User sees code blocks with monospaced SF Mono font"
    - "User sees code blocks with subtle background color"
    - "User sees blockquotes with left vertical border bar (GitHub-style)"
    - "User sees unordered lists with bullet points and indentation"
    - "User sees ordered lists with numbers and indentation"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift"
      provides: "Custom layout manager for blockquote border drawing"
      min_lines: 40
      contains: "drawBackground"
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Code block and list styling"
      contains: "codeBlock"
  key_links:
    - from: "PreviewViewController.swift"
      to: "MarkdownLayoutManager"
      via: "Custom text stack setup"
      pattern: "MarkdownLayoutManager"
    - from: "MarkdownLayoutManager.swift"
      to: "PresentationIntent"
      via: "blockQuote detection"
      pattern: "blockQuote"
---

<objective>
Add block-level element styling: code blocks (SF Mono + background), blockquotes (left border bar), and lists (indentation).

Purpose: Complete the block-level styling for markdown elements. Code blocks need distinct monospace font and visual separation. Blockquotes need GitHub-style left border which requires custom NSLayoutManager. Lists need proper indentation hierarchy.

Output: MarkdownLayoutManager.swift for blockquote borders, enhanced MarkdownRenderer with code block and list styling, updated PreviewViewController with custom text stack.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-core-markdown-rendering/02-CONTEXT.md
@.planning/phases/02-core-markdown-rendering/02-RESEARCH.md

# Files from Plan 01
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@md-spotlighter/MDQuickLook/PreviewViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add code block and list styling to MarkdownRenderer</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Extend the existing MarkdownRenderer to handle code blocks and lists.

**Code blocks (MDRNDR-07):**
Add handling for `.codeBlock(languageHint:)` in PresentationIntent:
- Font: `NSFont.monospacedSystemFont(ofSize: 13, weight: .regular)` (SF Mono)
- Background: `NSColor.secondarySystemFill` (adapts to Dark Mode)
- Paragraph style:
  - headIndent: 10pt
  - firstLineHeadIndent: 10pt
  - paragraphSpacing: 8pt before/after

**Inline code:**
Check `inlinePresentationIntent.contains(.code)`:
- Font: `NSFont.monospacedSystemFont(ofSize: 13, weight: .regular)`
- Background: `NSColor.quaternarySystemFill` (lighter than code blocks per research)

**Unordered lists (MDRNDR-05):**
Handle `.listItem(ordinal:)` where ordinal is 0 (indicates unordered):
- Paragraph style:
  - firstLineHeadIndent: 20pt (for bullet)
  - headIndent: 30pt (for text wrap)
  - tabStops: [NSTextTab at 30pt]
  - paragraphSpacing: 4pt

**Ordered lists (MDRNDR-06):**
Handle `.listItem(ordinal:)` where ordinal > 0:
- Same paragraph styling as unordered
- (Numbers are automatically inserted by AttributedString parser)

**Blockquotes (MDRNDR-08) - partial styling:**
Handle `.blockQuote`:
- Background: `NSColor.quaternarySystemFill` (subtle)
- Paragraph style:
  - headIndent: 20pt
  - firstLineHeadIndent: 20pt
  - paragraphSpacing: 8pt
- (Border will be drawn by MarkdownLayoutManager in Task 2)

Note: Collect paragraph styles carefully - if a run already has heading styling, don't override with list styling. Check `component.kind` ordering.
  </action>
  <verify>Run `make build` - should compile. MarkdownRenderer.swift now contains .codeBlock, .listItem, .blockQuote handling</verify>
  <done>MarkdownRenderer handles code blocks (monospace + background), lists (indentation), and blockquotes (background + indent)</done>
</task>

<task type="auto">
  <name>Task 2: Create MarkdownLayoutManager for blockquote borders</name>
  <files>md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift</files>
  <action>
Create a new MarkdownLayoutManager.swift file with a custom NSLayoutManager subclass.

The layout manager draws GitHub-style left vertical bars on blockquotes:

```swift
import Cocoa
import os.log

class MarkdownLayoutManager: NSLayoutManager {

    override func drawBackground(forGlyphRange glyphsToShow: NSRange, at origin: CGPoint) {
        // Draw standard backgrounds first (code block backgrounds, etc.)
        super.drawBackground(forGlyphRange: glyphsToShow, at: origin)

        guard let textStorage = textStorage,
              let textContainer = textContainer(forGlyphAt: glyphsToShow.location, effectiveRange: nil) else {
            return
        }

        // Find blockquote ranges and draw vertical bars
        let charRange = characterRange(forGlyphRange: glyphsToShow, actualGlyphRange: nil)

        textStorage.enumerateAttribute(.presentationIntent,
                                      in: charRange,
                                      options: []) { value, range, _ in
            guard let intent = value as? PresentationIntent else { return }

            // Check if this is a blockquote
            let isBlockquote = intent.components.contains { component in
                if case .blockQuote = component.kind { return true }
                return false
            }

            guard isBlockquote else { return }

            // Get glyph range for this character range
            let glyphRange = self.glyphRange(forCharacterRange: range, actualCharacterRange: nil)

            // Get bounding rect for these glyphs
            let boundingRect = self.boundingRect(forGlyphRange: glyphRange, in: textContainer)

            // Draw vertical bar on left (GitHub-style)
            let barWidth: CGFloat = 4
            let barX = origin.x + 8  // Fixed position from left edge
            let barRect = NSRect(x: barX,
                               y: origin.y + boundingRect.minY,
                               width: barWidth,
                               height: boundingRect.height)

            // Use semantic color that adapts to appearance
            NSColor.systemBlue.withAlphaComponent(0.4).setFill()
            barRect.fill()
        }
    }
}
```

Key implementation notes:
- Call `super.drawBackground` first to draw standard backgrounds
- Use `characterRange(forGlyphRange:)` to convert glyph range to character range
- Enumerate `.presentationIntent` attribute to find blockquotes
- Draw vertical bar using NSRect fill
- Use `NSColor.systemBlue.withAlphaComponent(0.4)` for the bar color (adapts to Dark Mode)
  </action>
  <verify>File exists at md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift with MarkdownLayoutManager class overriding drawBackground</verify>
  <done>MarkdownLayoutManager.swift created with custom drawBackground that draws vertical bars on blockquote paragraphs</done>
</task>

<task type="auto">
  <name>Task 3: Wire up custom text stack in PreviewViewController</name>
  <files>md-spotlighter/MDQuickLook/PreviewViewController.swift</files>
  <action>
Update PreviewViewController to use the custom MarkdownLayoutManager for blockquote border rendering.

Replace the simple `NSTextView(frame:)` creation with a custom text stack:

1. Create text components in order:
```swift
// Create text storage
let textStorage = NSTextStorage()

// Create custom layout manager
let layoutManager = MarkdownLayoutManager()

// Create text container
let textContainer = NSTextContainer(containerSize: NSSize(
    width: scrollView.contentSize.width - 40,  // Account for insets
    height: CGFloat.greatestFiniteMagnitude
))
textContainer.widthTracksTextView = true

// Wire them together
layoutManager.addTextContainer(textContainer)
textStorage.addLayoutManager(layoutManager)

// Create text view with custom container
let textView = NSTextView(frame: scrollView.bounds, textContainer: textContainer)
```

2. Keep existing textView configuration:
- isEditable = false
- isSelectable = true
- backgroundColor = .textBackgroundColor (semantic color for Dark Mode support)
- textContainerInset = NSSize(width: 20, height: 20)

3. Apply styled content:
```swift
textStorage.setAttributedString(styledContent)
```
(Use textStorage instead of textView.textStorage since we created it directly)

4. Update the text container inset handling - with custom text stack, may need to adjust container size calculation.

Ensure scroll view still works correctly with the custom text stack.
  </action>
  <verify>Run `make install && make test samples/basic.md` - extension loads with styled code blocks and blockquote border visible</verify>
  <done>PreviewViewController uses custom text stack with MarkdownLayoutManager, blockquote borders render correctly</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. MarkdownLayoutManager.swift exists with ~40+ lines
3. MarkdownRenderer.swift contains code block, list, and blockquote styling
4. PreviewViewController uses custom text stack
5. `make test samples/basic.md` shows:
   - Code block with monospace font and background
   - Blockquote with left blue border bar
   - Lists with proper indentation
</verification>

<success_criteria>
- Code blocks display with SF Mono font and subtle background color
- Blockquotes display with GitHub-style left vertical border bar
- Lists display with proper bullet/number and indentation
- Custom MarkdownLayoutManager draws blockquote decorations
- All styling adapts to system appearance (semantic colors used)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-02-SUMMARY.md`
</output>
