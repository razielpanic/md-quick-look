---
phase: 02-core-markdown-rendering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/PreviewViewController.swift
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true

must_haves:
  truths:
    - "User sees h1 headings visually larger than h2, which is larger than h3, etc."
    - "User sees bold text rendered with heavier font weight"
    - "User sees italic text rendered with oblique style"
    - "User sees strikethrough text with line through characters"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Custom markdown renderer with PresentationIntent transformation"
      min_lines: 80
      contains: "PresentationIntent"
    - path: "md-quick-look/MDQuickLook/PreviewViewController.swift"
      provides: "Updated controller using MarkdownRenderer"
      contains: "MarkdownRenderer"
  key_links:
    - from: "PreviewViewController.swift"
      to: "MarkdownRenderer.swift"
      via: "MarkdownRenderer().render(markdown:)"
      pattern: "MarkdownRenderer.*render"
    - from: "MarkdownRenderer.swift"
      to: "AttributedString"
      via: "PresentationIntent transformation"
      pattern: "presentationIntent"
---

<objective>
Create MarkdownRenderer foundation with heading visual hierarchy (h1-h6) and inline text formatting (bold, italic, strikethrough).

Purpose: Replace basic `AttributedString(markdown:)` usage with a custom renderer that applies proper visual styling based on PresentationIntent attributes. This establishes the foundation for all Phase 2 styling.

Output: New MarkdownRenderer.swift file with heading sizes (32pt down to 14pt), bold/italic/strikethrough handling, and PreviewViewController updated to use it.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-markdown-rendering/02-CONTEXT.md
@.planning/phases/02-core-markdown-rendering/02-RESEARCH.md

# Current implementation to replace
@md-quick-look/MDQuickLook/PreviewViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MarkdownRenderer with heading hierarchy and inline formatting</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Create a new MarkdownRenderer.swift file in the MDQuickLook extension directory.

The renderer should:
1. Accept markdown string input and return NSAttributedString
2. Parse using `AttributedString(markdown:)` to get semantic structure
3. Transform PresentationIntent attributes into visual styling:

**Heading hierarchy (MDRNDR-01):**
- h1: 32pt, bold, paragraphSpacing 12pt before/after
- h2: 26pt, bold, paragraphSpacing 10pt
- h3: 22pt, bold, paragraphSpacing 8pt
- h4: 18pt, bold, paragraphSpacing 6pt
- h5: 16pt, bold, paragraphSpacing 4pt
- h6: 14pt, bold, paragraphSpacing 4pt

**Inline formatting:**
- Bold (MDRNDR-02): Already handled by AttributedString, ensure preserved
- Italic (MDRNDR-03): Already handled by AttributedString, ensure preserved
- Strikethrough (MDRNDR-04): Already handled by AttributedString, ensure preserved

**Base text styling:**
- Body text: 14pt system font
- Use semantic colors: NSColor.textColor, NSColor.textBackgroundColor

**Implementation pattern from research:**
- Iterate `attributedString.runs.reversed()` to handle nested elements correctly
- Check `run.presentationIntent` for block elements
- Check `run.inlinePresentationIntent` for inline elements
- Use `attributedString[range].font = ...` to apply styling
- Use `attributedString[range].paragraphStyle = ...` for spacing

**Do NOT include yet:** Code block styling, blockquote styling, list indentation, image handling - those are in subsequent plans.

Import Foundation and AppKit. Use OSLog for debug logging matching Phase 1 pattern.
  </action>
  <verify>File exists at md-quick-look/MDQuickLook/MarkdownRenderer.swift with MarkdownRenderer class containing render(markdown:) method that returns NSAttributedString</verify>
  <done>MarkdownRenderer.swift exists with heading hierarchy (h1-h6 sizes), uses PresentationIntent transformation pattern, and handles inline formatting</done>
</task>

<task type="auto">
  <name>Task 2: Update PreviewViewController to use MarkdownRenderer</name>
  <files>md-quick-look/MDQuickLook/PreviewViewController.swift</files>
  <action>
Modify PreviewViewController.swift to use the new MarkdownRenderer instead of basic AttributedString.

Changes:
1. Import MarkdownRenderer (if needed, though same module should auto-import)
2. Replace the line `let attributedString = try AttributedString(markdown: markdownContent)` with:
   ```swift
   let renderer = MarkdownRenderer()
   let styledContent = renderer.render(markdown: markdownContent)
   ```
3. Update the textView setup to use the returned NSAttributedString directly:
   ```swift
   textView.textStorage?.setAttributedString(styledContent)
   ```
4. Remove the intermediate `NSAttributedString(attributedString)` conversion since MarkdownRenderer returns NSAttributedString directly

Keep all existing code structure (scroll view, text container, logging, error handling). Only change the AttributedString creation and application.
  </action>
  <verify>Run `make build` in project root - should compile without errors</verify>
  <done>PreviewViewController uses MarkdownRenderer.render() to get styled NSAttributedString, project builds successfully</done>
</task>

<task type="auto">
  <name>Task 3: Test heading hierarchy with sample file</name>
  <files>samples/headings.md</files>
  <action>
Create a comprehensive test file at samples/headings.md with all heading levels and inline formatting:

```markdown
# Heading Level 1

This is body text with **bold**, *italic*, and ~~strikethrough~~ formatting.

## Heading Level 2

More body text here.

### Heading Level 3

Testing nested **bold with *italic inside* it**.

#### Heading Level 4

##### Heading Level 5

###### Heading Level 6

Back to regular paragraph text.
```

Then run make install && make test to rebuild and test the extension. Verify with Console.app that MarkdownRenderer logs are appearing.
  </action>
  <verify>Run `make install && make test samples/headings.md` - extension loads and shows styled content (check Console.app for logs)</verify>
  <done>samples/headings.md exists, extension builds and loads the sample file without errors</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. MarkdownRenderer.swift exists with ~80+ lines
3. PreviewViewController.swift uses MarkdownRenderer
4. samples/headings.md contains all heading levels (h1-h6)
5. `make test samples/headings.md` opens Quick Look preview
</verification>

<success_criteria>
- MarkdownRenderer class created with render(markdown:) -> NSAttributedString method
- Heading levels h1-h6 have distinct font sizes (32pt to 14pt hierarchy)
- PresentationIntent transformation pattern implemented per research
- PreviewViewController updated to use MarkdownRenderer
- Project compiles and extension loads successfully
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-01-SUMMARY.md`
</output>
