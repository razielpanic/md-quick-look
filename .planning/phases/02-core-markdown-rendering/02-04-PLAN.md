---
phase: 02-core-markdown-rendering
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unordered list items display with bullet characters and line breaks between items"
    - "Ordered list items display with sequential numbers and line breaks between items"
    - "Blockquote lines appear on separate lines with proper visual spacing"
    - "Multiple paragraphs within blockquotes render on separate lines"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "List prefix insertion and intra-block line break handling"
      contains: "insertListPrefixes"
  key_links:
    - from: "MarkdownRenderer.swift"
      to: "NSMutableAttributedString"
      via: "List prefix insertion at list item ranges"
      pattern: "listItem.*ordinal"
---

<objective>
Fix list rendering and intra-block line breaks

The extension builds and loads but list items run together without bullets/numbers, and items within the same block type (list items, blockquote lines) lack proper line breaks.

Purpose: Address blocker/major UAT gaps - users cannot see proper list structure or blockquote formatting
Output: Lists show bullets/numbers, items within blocks appear on separate lines
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-markdown-rendering/02-UAT.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add list prefix insertion (bullets and numbers)</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Add a new method `insertListPrefixes(in:to:)` that processes list items and inserts visual prefixes.

The current `applyListItemAttributes` only sets indentation but doesn't add bullets or numbers. List items come from `PresentationIntent` with `.listItem(ordinal:)` where ordinal is the item number (1-based for ordered lists, but also present for unordered lists).

Key insight from the gap: AttributedString(markdown:) strips list markers (bullets/numbers). We must manually re-insert them.

Implementation:
1. After `applyBlockStyles`, call `insertListPrefixes(from:to:)`
2. For each list item run found via PresentationIntent:
   - Check parent components for `.orderedList` vs `.unorderedList`
   - For unordered: insert "• " at the start of the item range
   - For ordered: insert "{ordinal}. " at the start of the item range
3. Process items in REVERSE order (by range position) to maintain string indices during insertion

Track inserted prefix lengths to adjust subsequent ranges. Use NSMutableAttributedString replaceCharacters or insert method.

Important: PresentationIntent.Component.Kind has `.orderedList` and `.unorderedList` parent types that wrap `.listItem`. Inspect the full component stack to determine list type.

Do NOT modify the existing `applyListItemAttributes` - that handles styling. This new method handles content insertion.
  </action>
  <verify>Build with `make build`. Check that build succeeds. Visually verify with `qlmanage -p samples/comprehensive.md` that lists show bullets and numbers.</verify>
  <done>Unordered lists show "• " prefix, ordered lists show "1. 2. 3." prefixes in Quick Look preview</done>
</task>

<task type="auto">
  <name>Task 2: Add intra-block newlines for list items and blockquote lines</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The current `insertBlockBoundaryNewlines` only inserts newlines when transitioning BETWEEN different block types. It doesn't handle items WITHIN the same block type (multiple list items, multiple blockquote lines).

Fix the `insertBlockBoundaryNewlines` method or create a separate `insertIntraBlockNewlines` method:

1. Track not just `previousBlockComponent` (block type) but also the full PresentationIntent identity
2. For runs that have the SAME block type but are DIFFERENT items (different identity/index):
   - Insert newline at the boundary
3. Specifically handle:
   - List items: Each `.listItem(ordinal: N)` is a separate item - insert newline between ordinal transitions
   - Blockquote paragraphs: Blockquote can contain multiple paragraphs - insert newline between them

Key insight: The `ordinal` in `.listItem(ordinal:)` changes for each list item. Use this to detect item boundaries within the same list.

For blockquotes: Check if runs have `.blockQuote` but different content/identity values.

Alternative approach: Instead of detecting boundaries, ensure EVERY list item and blockquote line ENDS with a newline character. Check if the run's text already ends with "\n" - if not, append one.

Process in reverse order to maintain string indices.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify list items appear on separate lines. Verify blockquote lines appear on separate lines.</verify>
  <done>List items and blockquote lines render on separate lines with visible spacing</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Unordered list with bullets on separate lines
   - Ordered list with numbers on separate lines
   - Blockquote with multi-line support
3. Each list item is visually distinct (not running together)
</verification>

<success_criteria>
- Lists display with proper bullets (•) for unordered, numbers for ordered
- List items appear on separate lines, not concatenated
- Blockquote lines appear on separate lines
- No regression in other rendering (headings, code blocks, inline formatting)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-04-SUMMARY.md`
</output>
