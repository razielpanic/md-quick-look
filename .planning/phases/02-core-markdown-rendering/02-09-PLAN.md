---
phase: 02-core-markdown-rendering
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "List items appear on separate lines without extra blank lines between them"
    - "All paragraphs and blocks are properly separated without text running together"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed newline insertion logic"
      contains: "ensureIntraBlockNewlines"
  key_links:
    - from: "ensureIntraBlockNewlines"
      to: "insertBlockBoundaryNewlines"
      via: "Sequential newline processing"
      pattern: "previousRunEndedWithNewline"
---

<objective>
Fix list spacing and document newline issues (Gaps #11 and #15)

UAT re-test found:
- Gap #11: "unordered list has a line space after 'bold'" - extra blank line after last list item
- Gap #15: "many line feeds missing" - text like "lines.And" runs together

Root cause: The newline insertion logic has two issues:
1. `ensureIntraBlockNewlines` adds newlines unconditionally, creating double-spacing
2. Some paragraph boundaries are still not getting newlines

Purpose: Balance newline insertion - enough for separation, not too many for over-spacing
Output: Proper visual separation without excessive gaps
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ensureIntraBlockNewlines to avoid double-newlines</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The current `ensureIntraBlockNewlines` adds a newline after EVERY list item and blockquote run, even if one already exists. This creates double-spacing.

Fix: Check if the run text already ends with a newline before adding one.

Current code (broken):
```swift
if needsNewline {
    let runEndIndex = run.range.upperBound
    insertionPositions.append(runEndIndex)
}
```

Fixed code:
```swift
if needsNewline {
    // Check if run already ends with newline
    let runText = String(attributedString[run.range].characters)
    if !runText.hasSuffix("\n") {
        let runEndIndex = run.range.upperBound
        insertionPositions.append(runEndIndex)
    }
}
```

This prevents adding a second newline when the run already ends with one.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Check: List items are on separate lines but NO extra blank line after "Third item with **bold**".</verify>
  <done>List items are properly separated without double-spacing</done>
</task>

<task type="auto">
  <name>Task 2: Improve block boundary detection for remaining spacing gaps</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Gap #15 reports "lines.And" running together, indicating some paragraph boundaries are missed.

The issue is in `insertBlockBoundaryNewlines`: it only inserts newlines when `currentBlockComponent != previousBlockComponent`. But paragraphs of the same type should still have breaks between them.

Review the logic and add handling for:
1. Transitions within the same block type (separate paragraphs)
2. Transitions from intent runs to non-intent runs (styled text to plain text)

Enhanced approach - track both component kind AND ordinal/identity:

```swift
// Track more than just component kind - track the specific block
var previousBlockIdentity: Int?

for run in attributedString.runs {
    guard let intent = run.presentationIntent else {
        // Handle no-intent runs...
        previousBlockIdentity = nil
        continue
    }

    // Get block identity from intent
    let currentBlockIdentity = intent.components.first?.identity

    // Insert newline if different block OR different identity
    if !isFirstRun {
        let needsNewline = (currentBlockComponent != previousBlockComponent) ||
                          (currentBlockIdentity != previousBlockIdentity)
        if needsNewline && !previousRunEndedWithNewline {
            insertionOffsets.append(run.range.lowerBound)
        }
    }

    previousBlockIdentity = currentBlockIdentity
}
```

PresentationIntent.Component has an `identity` property that uniquely identifies each block instance. Different paragraphs have different identities even if same kind.

If identity-based detection doesn't resolve all gaps, add a fallback: ensure ANY transition between runs that doesn't already have a newline gets one, unless they're inline elements within the same paragraph.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: No instances of text running together (like "lines.And"). All paragraphs visually separated. All sections have proper spacing.</verify>
  <done>All document sections have proper line breaks without text running together</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - List items on separate lines (no extra gaps)
   - No text running together ("lines.And" should show as "lines." then "And" on next line)
   - Consistent paragraph spacing throughout document
3. Visual rhythm is even - not too tight, not too loose
</verification>

<success_criteria>
- Unordered list: Items separated, NO extra line after "bold"
- Ordered list: Items separated, consistent spacing
- All paragraphs properly separated
- No instances of concatenated text
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-09-SUMMARY.md`
</output>
