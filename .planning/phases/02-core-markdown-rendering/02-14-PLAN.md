---
phase: 02-core-markdown-rendering
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unordered list items appear on consecutive lines with minimal spacing"
    - "Ordered list items appear on consecutive lines with minimal spacing"
    - "No massive blank spaces between list items"
    - "Inline formatting within list items stays on single line"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "List spacing fix"
      contains: "applyListItemAttributes"
  key_links:
    - from: "insertListPrefixes"
      to: "paragraph styling"
      via: "prefix text must include paragraphStyle with paragraphSpacing=0"
      pattern: "paragraphSpacing"
---

<objective>
Fix list huge gaps - Gap #21 and #22 (BLOCKER)

UAT round 5 shows: "Massive blank spaces between list items" for both ordered and unordered lists.

Previous attempts (02-09, 02-12) set `paragraphSpacing = 0` in `applyListItemAttributes()` but the gaps persist.

**Root cause:** When list prefixes are inserted in `insertListPrefixes()`, the inserted prefix text doesn't have a paragraph style. Then `applyBaseStyles()` applies the default spacing (paragraphSpacing=8) to these prefix ranges, causing the gaps.

**Direct fix approach:** Apply the list paragraph style (with paragraphSpacing=0) to the prefix text when inserting it. This ensures the entire list item, including prefix, has tight spacing.

Purpose: Eliminate excessive spacing between list items
Output: List items on consecutive lines with minimal visual gaps
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND5.md
@.planning/phases/02-core-markdown-rendering/02-12-SUMMARY.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add paragraph style to list prefix insertion</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The fix requires adding the list paragraph style to the prefix text when it's inserted, so `applyBaseStyles()` won't override it.

**Step 1: Locate insertListPrefixes() function**

Find where list prefixes (bullets, numbers) are inserted into the attributed string.

**Step 2: Add paragraph style to prefix attributes**

When creating the prefix attributed string, include the list paragraph style:

```swift
// Create the list paragraph style (same as in applyListItemAttributes)
let listParagraphStyle = NSMutableParagraphStyle()
listParagraphStyle.firstLineHeadIndent = 20
listParagraphStyle.headIndent = 30
listParagraphStyle.tabStops = [NSTextTab(textAlignment: .left, location: 30)]
listParagraphStyle.paragraphSpacing = 0  // CRITICAL: zero spacing
listParagraphStyle.lineSpacing = 2

// Apply style to the prefix string
let prefixString = NSAttributedString(
    string: prefix,
    attributes: [
        .font: NSFont.systemFont(ofSize: bodyFontSize),
        .foregroundColor: NSColor.textColor,
        .paragraphStyle: listParagraphStyle  // ADD THIS
    ]
)
```

**Step 3: Ensure applyBaseStyles doesn't override list ranges**

In `applyBaseStyles()`, modify the logic to check if a range already has a paragraph style before applying the default:

```swift
// In applyBaseStyles, enumerate and only apply to ranges without paragraph style
nsAttributedString.enumerateAttribute(.paragraphStyle, in: fullRange, options: []) { value, range, _ in
    if value == nil {
        // Only apply default to ranges that have NO paragraph style
        nsAttributedString.addAttribute(.paragraphStyle, value: defaultParagraphStyle, range: range)
    }
    // If value is not nil, a style already exists - don't override
}
```

**Alternative approach if prefix insertion happens after style application:**

If the order of operations makes the above difficult, ensure that after all prefix insertions, we re-apply list paragraph styles to the full list item ranges (including the newly inserted prefixes). This can be done by calling `applyListItemAttributes` after `insertListPrefixes` with updated ranges.

**Step 4: Clean up any redundant spacing logic**

Remove any other code that might be adding paragraph spacing to list items.
  </action>
  <verify>make build && qlmanage -p samples/comprehensive.md 2>&1 | head -50</verify>
  <done>List items display on consecutive lines with minimal spacing</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Unordered list items on consecutive lines (no blank lines between)
   - Ordered list items on consecutive lines
   - "Third item with **bold**" on single line
   - Spacing between items is minimal (~2pt line spacing)
</verification>

<success_criteria>
- No massive blank spaces between list items
- Unordered list items appear consecutively with minimal gap
- Ordered list items appear consecutively with minimal gap
- Inline formatting (bold, italic) within list items stays on single line
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-14-SUMMARY.md`
</output>
