---
phase: 02-core-markdown-rendering
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unordered list items appear on consecutive lines with minimal spacing"
    - "Ordered list items appear on consecutive lines with minimal spacing"
    - "No massive blank spaces between list items"
    - "Inline formatting within list items stays on single line"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "List spacing fix"
      contains: "applyListItemAttributes"
  key_links:
    - from: "applyListItemAttributes"
      to: "paragraph styling"
      via: "paragraphSpacing must actually apply to all list text"
      pattern: "paragraphSpacing"
---

<objective>
Fix list huge gaps - Gap #21 and #22 (BLOCKER)

UAT round 5 shows: "Massive blank spaces between list items" for both ordered and unordered lists.

Previous attempts (02-09, 02-12) set `paragraphSpacing = 0` but the gaps persist.

This suggests the paragraph style is either:
1. Not being applied to all list item text
2. Being overridden by applyBaseStyles (which sets paragraphSpacing = 8)
3. Not affecting the actual newline spacing

Root cause investigation needed before fixing.

Purpose: Eliminate excessive spacing between list items
Output: List items on consecutive lines with minimal visual gaps
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND5.md
@.planning/phases/02-core-markdown-rendering/02-12-SUMMARY.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose list spacing source</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The code sets `paragraphSpacing = 0` in `applyListItemAttributes()` (line 457) but UAT shows huge gaps.

Possible causes:
1. applyBaseStyles() applies paragraphSpacing=8 AFTER list styles
2. The inserted list prefix (bullet/number) has its own paragraph style
3. Inserted newlines create paragraph breaks with default spacing
4. NSTextView adds its own spacing

Add diagnostic logging to trace paragraph style application:

1. **In applyListItemAttributes()**: Log when style is applied:
```swift
os_log("Applying list item style to range %d-%d with paragraphSpacing=0", log: .renderer, type: .info, range.location, range.location + range.length)
```

2. **In applyBaseStyles()**: Log default paragraph style application:
```swift
nsAttributedString.enumerateAttribute(.paragraphStyle, in: fullRange, options: []) { value, range, _ in
    if value == nil {
        os_log("Applying default paragraphSpacing=8 to range %d-%d", log: .renderer, type: .info, range.location, range.location + range.length)
        nsAttributedString.addAttribute(.paragraphStyle, value: defaultParagraphStyle, range: range)
    } else {
        os_log("Range %d-%d already has paragraph style", log: .renderer, type: .debug, range.location, range.location + range.length)
    }
}
```

3. **After insertListPrefixes()**: Log paragraph styles on list content:
```swift
// At end of render(), before returning
nsAttributedString.enumerateAttribute(.paragraphStyle, in: NSRange(location: 0, length: nsAttributedString.length), options: []) { value, range, _ in
    if let style = value as? NSParagraphStyle {
        let text = (nsAttributedString.string as NSString).substring(with: NSRange(location: range.location, length: min(20, range.length)))
        os_log("Final paragraphSpacing at '%{public}@': %f", log: .renderer, type: .info, text, style.paragraphSpacing)
    }
}
```

4. **Build and test**: Check Console.app logs

This will reveal whether:
- applyBaseStyles is overwriting list styles
- The list prefix text has wrong paragraph style
- Other ranges are getting default spacing
  </action>
  <verify>Check Console.app logs. Look for paragraph spacing values on list item text ranges.</verify>
  <done>Root cause of list spacing issue is identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix list spacing based on diagnosis</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Based on diagnosis from Task 1, implement the correct fix.

**Most likely cause: applyBaseStyles overwrites list paragraph styles**

The order of operations in render() is:
1. applyBlockStyles (sets paragraphSpacing=0 for list items)
2. insertListPrefixes (may not have paragraph style)
3. applyInlineStyles
4. applyLinkStyles
5. applyImagePlaceholderStyles
6. applyBaseStyles (applies paragraphSpacing=8 to ANY range without paragraphStyle)

The issue: When list prefixes are inserted, the inserted prefix text doesn't have a paragraph style. Then applyBaseStyles applies the default spacing to these prefix ranges.

**Fix approach 1: Apply list paragraph style to prefix when inserting**
In `insertListPrefixes()`:
```swift
let paragraphStyle = NSMutableParagraphStyle()
paragraphStyle.firstLineHeadIndent = 20
paragraphStyle.headIndent = 30
paragraphStyle.tabStops = [NSTextTab(textAlignment: .left, location: 30)]
paragraphStyle.paragraphSpacing = 0
paragraphStyle.lineSpacing = 2

let prefixString = NSAttributedString(
    string: item.prefix,
    attributes: [
        .font: NSFont.systemFont(ofSize: bodyFontSize),
        .foregroundColor: NSColor.textColor,
        .paragraphStyle: paragraphStyle  // ADD THIS
    ]
)
```

**Fix approach 2: Apply list style to ENTIRE list item range including prefix**
After inserting prefixes, re-enumerate and apply list style to full range:
```swift
// After prefix insertion
for item in listItems {
    // The prefix was inserted, so the range has shifted
    // Re-apply list paragraph style to ensure prefix is covered
    applyListItemAttributes(to: nsAttributedString, range: adjustedRange, ordinal: item.ordinal)
}
```

**Fix approach 3: Don't let applyBaseStyles override list styles**
Check for list marker attribute before applying default:
```swift
// In applyBaseStyles
nsAttributedString.enumerateAttribute(.paragraphStyle, in: fullRange, options: []) { value, range, _ in
    if value == nil {
        // Check if this is list item content
        let hasListStyle = nsAttributedString.attribute(.listItemMarker, at: range.location, effectiveRange: nil) != nil
        if !hasListStyle {
            nsAttributedString.addAttribute(.paragraphStyle, value: defaultParagraphStyle, range: range)
        }
    }
}
```

**Recommended: Approach 1** (simplest, directly addresses the gap)

Also ensure the newlines between list items don't create new paragraphs with default spacing.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: 1) No massive gaps between list items, 2) Both ordered and unordered lists have tight spacing, 3) Inline formatting stays on same line.</verify>
  <done>List items display on consecutive lines with minimal spacing</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Unordered list items on consecutive lines (no blank lines between)
   - Ordered list items on consecutive lines
   - "Third item with **bold**" on single line
   - Spacing between items is minimal (~2pt line spacing)
3. Console.app logs confirm paragraphSpacing=0 on all list text
</verification>

<success_criteria>
- No massive blank spaces between list items
- Unordered list items appear consecutively with minimal gap
- Ordered list items appear consecutively with minimal gap
- Inline formatting (bold, italic) within list items stays on single line
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-14-SUMMARY.md`
</output>
