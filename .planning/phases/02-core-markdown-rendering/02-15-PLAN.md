---
phase: 02-core-markdown-rendering
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Blockquote paragraphs have proper newline separation"
    - "Blockquote renders with continuous blue border"
    - "Blockquote background is uniform (no gaps)"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Blockquote newline fix"
      contains: "ensureIntraBlockNewlines"
  key_links:
    - from: "ensureIntraBlockNewlines"
      to: "blockquote continuation"
      via: "newlines added correctly for multi-paragraph blockquotes"
      pattern: "isBlockquote"
---

<objective>
Fix blockquote missing newline - Gap #20 (MINOR)

UAT round 5 shows: "Blockquote rendering issue - missing new line"

This appeared after round 3 fixes in plan 02-11, which added blockquote continuation detection to prevent double-newlines. The fix overcorrected - now a necessary newline is missing.

The current logic (lines 213-236) only adds newline if the current run is the "last blockquote run" (not followed by another blockquote). This is wrong - each blockquote paragraph needs its own newline.

Purpose: Fix blockquote paragraph separation without reintroducing double-newlines
Output: Properly separated blockquote paragraphs with continuous border
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND5.md
@.planning/phases/02-core-markdown-rendering/02-11-SUMMARY.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix blockquote newline logic</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The current code in `ensureIntraBlockNewlines()` at lines 213-236 has faulty logic:

```swift
// Current (wrong): Only add newline if this is the last blockquote run
if isLastBlockquoteRun {
    // adds newline
}
```

This prevents newlines between blockquote paragraphs because intermediate blockquote runs are not "last".

**The correct behavior:**
- Add newline after EVERY blockquote run that doesn't already end with one
- Let the LayoutManager handle drawing a continuous border across all blockquote ranges
- The double-newline prevention should happen at the BLOCK BOUNDARY level, not here

**Fix approach:**
Simplify the blockquote handling to match list item handling:

```swift
// For blockquotes, add newline if missing (same as list items)
if isBlockquote {
    let runText = String(attributedString[run.range].characters)
    if !runText.hasSuffix("\n") {
        let runEndIndex = run.range.upperBound
        insertionPositions.append(runEndIndex)
    }
}
```

Remove the `isLastBlockquoteRun` detection entirely from this function.

The block boundary detection in `insertBlockBoundaryNewlines()` will handle preventing double-newlines between different blocks. This function (`ensureIntraBlockNewlines`) should just ensure each run ends with a newline.

**Also check:** Make sure `insertBlockBoundaryNewlines()` isn't ALSO adding newlines for blockquotes, which would cause double-newlines. The two functions should have clear responsibilities:
- `insertBlockBoundaryNewlines`: Add newlines BETWEEN different blocks
- `ensureIntraBlockNewlines`: Add newlines at END of runs within blocks

Look at the boundary detection logic at lines 137-154. It may need adjustment if blockquotes are being double-processed.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: 1) Blockquote paragraphs are separated, 2) No double-spacing within blockquote, 3) Border is continuous.</verify>
  <done>Blockquote renders with proper paragraph separation and continuous border</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Multi-paragraph blockquotes have visible paragraph separation
   - Single continuous blue border on left
   - No double blank lines within blockquote
   - Blockquote background is uniform
3. No visual gaps in the blockquote border
</verification>

<success_criteria>
- Blockquote paragraphs have proper visual separation
- Blue border is continuous (no gaps between paragraphs)
- No double-spacing within blockquotes
- Background is uniform without holes
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-15-SUMMARY.md`
</output>
