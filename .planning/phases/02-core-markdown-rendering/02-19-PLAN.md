---
phase: 02-core-markdown-rendering
plan: 19
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees unordered list items with normal line spacing (no large gaps)"
    - "User sees ordered list items with normal line spacing (no large gaps)"
    - "List items appear on consecutive lines like standard markdown renderers"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed list spacing with single newline between items"
      contains: "ensureIntraBlockNewlines"
  key_links:
    - from: "ensureIntraBlockNewlines"
      to: "insertBlockBoundaryNewlines"
      via: "Coordinated newline insertion"
      pattern: "Only one function adds newlines between list items"
---

<objective>
Fix Gap #27: Remove excessive spacing between list items by eliminating duplicate newline insertion.

Purpose: Both `insertBlockBoundaryNewlines()` and `ensureIntraBlockNewlines()` currently add newlines between list items with different ordinals, causing double newlines and excessive visual gaps.

Output: List items render with normal line spacing (single newlines) like standard markdown renderers.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
</context>

<root_cause>
The double-newline issue occurs because TWO functions both add newlines at list item boundaries:

1. **`insertBlockBoundaryNewlines()`** (lines 144-148): Adds newline when transitioning between list items with different ordinals
2. **`ensureIntraBlockNewlines()`** (lines 216-231): ALSO adds newline when next run has different ordinal

When parsing a list:
```
- First item (ordinal 1)
- Second item (ordinal 2)
```

Both functions see the ordinal change (1 -> 2) and BOTH insert a newline, resulting in:
```
First item\n\n  <- Double newline!
Second item
```

This creates the "huge gaps" reported by the user.
</root_cause>

<solution>
Remove list item newline insertion from `ensureIntraBlockNewlines()`. The `insertBlockBoundaryNewlines()` function already handles list item transitions correctly.

`ensureIntraBlockNewlines()` should ONLY:
1. Handle blockquote internal newlines (keep existing logic)
2. NOT add any newlines for list items (remove list item logic entirely)

The list item newline insertion was originally added for proper separation, but `insertBlockBoundaryNewlines()` already provides this. The `ensureIntraBlockNewlines()` function's list item handling is now redundant and harmful.
</solution>

<tasks>

<task type="auto">
  <name>Task 1: Remove duplicate list item newline insertion</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
In `ensureIntraBlockNewlines()`, remove all list item newline insertion logic. The function should ONLY handle blockquote newlines.

Current code (lines 216-232):
```swift
// For list items, only add newline if NEXT run is different list item
if isListItem {
    let runText = String(attributedString[run.range].characters)
    if !runText.hasSuffix("\n") {
        // Peek at next run
        let nextIndex = index + 1
        if nextIndex < allRuns.count {
            let nextOrdinal = listItemOrdinal(for: allRuns[nextIndex])
            // Only add newline if next run has different ordinal (or no ordinal)
            if nextOrdinal != currentOrdinal {
                insertionPositions.append(run.range.upperBound)
            }
            // If same ordinal, skip - inline formatting continues on same line
        } else {
            // Last run in document - add newline
            insertionPositions.append(run.range.upperBound)
        }
    }
}
```

Replace with: REMOVE THIS ENTIRE BLOCK.

The list item variables (`isListItem`, `currentOrdinal`) and the `listItemOrdinal()` helper function can also be removed since they are no longer needed.

Simplified function should look like:
```swift
private func ensureIntraBlockNewlines(in attributedString: AttributedString) -> AttributedString {
    var result = attributedString
    var insertionPositions: [AttributedString.Index] = []

    // Collect all runs in array for potential peeking
    let allRuns = Array(attributedString.runs)

    // Collect positions where newlines need to be inserted
    for run in allRuns {
        guard let intent = run.presentationIntent else { continue }

        // Check if this run contains a blockquote
        var isBlockquote = false

        for component in intent.components {
            if case .blockQuote = component.kind {
                isBlockquote = true
                break
            }
        }

        // For blockquotes, add newline if missing
        // Each blockquote paragraph/line needs its own newline for proper separation
        if isBlockquote {
            let runText = String(attributedString[run.range].characters)
            if !runText.hasSuffix("\n") {
                insertionPositions.append(run.range.upperBound)
            }
        }
    }

    // Insert newlines in reverse order to maintain indices
    for insertPosition in insertionPositions.reversed() {
        result.insert(AttributedString("\n"), at: insertPosition)
        os_log("MarkdownRenderer: Inserted intra-block newline", log: .renderer, type: .debug)
    }

    return result
}
```

Note: The `listItemOrdinal()` helper function (lines 184-192) can be removed since it's no longer used. However, keep it if you prefer minimal changes - unused code is harmless.
  </action>
  <verify>
Build the project:
```bash
cd /Users/razielpanic/Projects/md-spotlighter && make build
```
Build should succeed with no errors.
  </verify>
  <done>
`ensureIntraBlockNewlines()` no longer inserts newlines for list items. Only `insertBlockBoundaryNewlines()` handles list item transitions, preventing double newlines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build and test Quick Look preview</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
After making the changes, rebuild the project and install it:

```bash
cd /Users/razielpanic/Projects/md-spotlighter && make build && make install
```

Then test the preview:
```bash
qlmanage -p /Users/razielpanic/Projects/md-spotlighter/samples/comprehensive.md
```

Verify that list items now appear with normal line spacing:
- Unordered list items should be on consecutive lines without large gaps
- Ordered list items should be on consecutive lines without large gaps
- "Third item with **bold**" should still render on single line (Gap #26 fix preserved)
  </action>
  <verify>
Visual inspection of Quick Look preview shows:
1. Unordered list items have normal spacing (no huge gaps)
2. Ordered list items have normal spacing (no huge gaps)
3. Inline formatting in list items still works (bold on same line)
  </verify>
  <done>
List items display with normal line spacing matching standard markdown renderers. No excessive gaps between list items.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds without errors
2. Quick Look preview shows list items with normal spacing
3. No regression in inline formatting fix (Gap #26)
4. Blockquotes still render correctly (separate concern, unchanged)
</verification>

<success_criteria>
- Build passes
- Unordered list items appear with normal line spacing (consecutive lines, no large gaps)
- Ordered list items appear with normal line spacing (consecutive lines, no large gaps)
- List items with inline formatting (bold, italic) still render on single line
- No other rendering regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-19-SUMMARY.md`
</output>
