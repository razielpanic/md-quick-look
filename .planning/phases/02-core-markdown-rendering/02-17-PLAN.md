---
phase: 02-core-markdown-rendering
plan: 17
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unordered list items appear on consecutive lines with minimal spacing"
    - "Ordered list items appear on consecutive lines with minimal spacing"
    - "No huge blank spaces between list items"
    - "Inline formatting within list items stays on single line"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "List spacing fix with paragraph style on prefix"
      contains: "insertListPrefixes"
  key_links:
    - from: "insertListPrefixes"
      to: "paragraphStyle attribute"
      via: "prefix NSAttributedString includes paragraphStyle"
      pattern: ".paragraphStyle.*listParagraphStyle"
---

<objective>
Fix list huge gaps - Gap #24 (BLOCKER)

UAT round 5 shows: "Massive blank spaces between list items" for both ordered and unordered lists.

**Root cause diagnosed:** In `insertListPrefixes()` (lines 306-317), the prefix NSAttributedString is created with only `.font` and `.foregroundColor` attributes - NO `.paragraphStyle`. Then in `applyBaseStyles()` (lines 340-344), when enumerating ranges without paragraph style, the default `paragraphSpacing = 8` is applied to these prefix ranges.

The `applyListItemAttributes()` function correctly sets `paragraphSpacing = 0` on the list content ranges, but the inserted prefix characters get the default spacing because they're inserted AFTER style application.

**Solution:** Include the list paragraph style (with paragraphSpacing=0) in the prefix NSAttributedString attributes when creating it in `insertListPrefixes()`.

Purpose: Eliminate excessive spacing between list items
Output: List items on consecutive lines with minimal visual gaps
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add paragraph style to list prefix insertion</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The inserted list prefixes need to have the same paragraph style as the list content to prevent applyBaseStyles from overriding with default spacing.

**Step 1: Locate insertListPrefixes() function (around line 254)**

Find the section where prefix NSAttributedString is created (lines 306-313):

```swift
let prefixString = NSAttributedString(
    string: item.prefix,
    attributes: [
        .font: NSFont.systemFont(ofSize: bodyFontSize),
        .foregroundColor: NSColor.textColor
    ]
)
```

**Step 2: Create list paragraph style and add to prefix attributes**

BEFORE the loop that processes items in reverse (line 306), create the list paragraph style:

```swift
// Create the list paragraph style (must match applyListItemAttributes)
let listParagraphStyle = NSMutableParagraphStyle()
listParagraphStyle.firstLineHeadIndent = 20
listParagraphStyle.headIndent = 30
listParagraphStyle.tabStops = [NSTextTab(textAlignment: .left, location: 30)]
listParagraphStyle.paragraphSpacing = 0  // CRITICAL: zero spacing to prevent gaps
listParagraphStyle.lineSpacing = 2
```

**Step 3: Include paragraphStyle in prefix attributes**

Update the NSAttributedString creation to include the paragraph style:

```swift
let prefixString = NSAttributedString(
    string: item.prefix,
    attributes: [
        .font: NSFont.systemFont(ofSize: bodyFontSize),
        .foregroundColor: NSColor.textColor,
        .paragraphStyle: listParagraphStyle  // ADD THIS LINE
    ]
)
```

The full modified section should look like:

```swift
// Insert prefixes in reverse order to maintain indices
// Create the list paragraph style (must match applyListItemAttributes)
let listParagraphStyle = NSMutableParagraphStyle()
listParagraphStyle.firstLineHeadIndent = 20
listParagraphStyle.headIndent = 30
listParagraphStyle.tabStops = [NSTextTab(textAlignment: .left, location: 30)]
listParagraphStyle.paragraphSpacing = 0  // CRITICAL: zero spacing
listParagraphStyle.lineSpacing = 2

for item in listItems.reversed() {
    let prefixString = NSAttributedString(
        string: item.prefix,
        attributes: [
            .font: NSFont.systemFont(ofSize: bodyFontSize),
            .foregroundColor: NSColor.textColor,
            .paragraphStyle: listParagraphStyle
        ]
    )

    nsAttributedString.insert(prefixString, at: item.range.location)
    os_log("MarkdownRenderer: Inserted list prefix at location %d", log: .renderer, type: .debug, item.range.location)
}
```

**Why this works:**
- When applyBaseStyles runs, it only applies default paragraph style to ranges with NO existing paragraph style
- By giving the prefix a paragraph style with paragraphSpacing=0, applyBaseStyles will skip these ranges
- The prefix paragraph style matches the list content paragraph style from applyListItemAttributes
  </action>
  <verify>make build && qlmanage -p samples/comprehensive.md 2>&1 | head -50</verify>
  <done>List items display on consecutive lines with minimal spacing, no huge gaps</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Unordered list items on consecutive lines (no blank lines between)
   - Ordered list items on consecutive lines
   - "Third item with **bold**" on single line
   - Spacing between items is minimal (~2pt line spacing)
   - No massive blank spaces between any list items
</verification>

<success_criteria>
- No huge blank spaces between list items
- Unordered list items appear consecutively with minimal gap
- Ordered list items appear consecutively with minimal gap
- Inline formatting (bold, italic) within list items stays on single line
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-17-SUMMARY.md`
</output>
