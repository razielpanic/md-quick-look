---
phase: 02-core-markdown-rendering
plan: 06
type: execute
wave: 2
depends_on:
  - "02-04"
  - "02-05"
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
  - md-quick-look/MDQuickLook/MarkdownLayoutManager.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Code block background color renders uniformly without per-line misalignment"
    - "Inline code has proper spacing/newline before next element"
    - "Link sections have proper line breaks between text lines"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Consistent code block background and trailing newlines"
    - path: "md-quick-look/MDQuickLook/MarkdownLayoutManager.swift"
      provides: "Optional code block background drawing override"
  key_links:
    - from: "MarkdownRenderer.swift"
      to: "NSAttributedString"
      via: "Code block background attribute application"
      pattern: "backgroundColor.*secondarySystemFill"
---

<objective>
Fix code block background alignment and minor line break issues

UAT found: code block backgrounds are "misaligned by line" and some sections are missing trailing line breaks (inline code, links).

Purpose: Address minor UAT gaps - polish visual rendering
Output: Uniform code block backgrounds, proper spacing throughout
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-markdown-rendering/02-UAT.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@md-quick-look/MDQuickLook/MarkdownLayoutManager.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix code block background alignment</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift, md-quick-look/MDQuickLook/MarkdownLayoutManager.swift</files>
  <action>
UAT reported: "background color is misaligned by line in the code blocks"

The current `.backgroundColor` attribute renders as inline background (following text bounds), creating jagged appearance. Use LayoutManager custom drawing (matching the existing blockquote pattern):

1. In MarkdownRenderer.swift, add a custom attribute key:
   ```swift
   extension NSAttributedString.Key {
       static let codeBlockMarker = NSAttributedString.Key("com.razielpanic.codeBlockMarker")
   }
   ```

2. In `applyCodeBlockAttributes`, add the marker attribute to the range:
   ```swift
   nsAttributedString.addAttribute(.codeBlockMarker, value: true, range: range)
   ```

3. Remove the `.backgroundColor` attribute from code blocks (LayoutManager will handle it)

4. In MarkdownLayoutManager.drawBackground, after blockquote handling, add code block background drawing:
   ```swift
   textStorage.enumerateAttribute(.codeBlockMarker, in: charRange, options: []) { value, range, _ in
       guard value != nil else { return }
       let glyphRange = self.glyphRange(forCharacterRange: range, actualCharacterRange: nil)
       let boundingRect = self.boundingRect(forGlyphRange: glyphRange, in: textContainer)

       let bgRect = NSRect(x: origin.x + 8,
                          y: origin.y + boundingRect.minY,
                          width: textContainer.containerSize.width - 16,
                          height: boundingRect.height)
       NSColor.secondarySystemFill.setFill()
       bgRect.fill()
   }
   ```
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify code blocks have uniform background without per-line jagging.</verify>
  <done>Code block background renders as uniform rectangle without line-by-line misalignment</done>
</task>

<task type="auto">
  <name>Task 2: Ensure proper trailing newlines throughout document</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reported minor issues with missing line breaks:
- "missing a line break at the end" (inline code, Test 4)
- "Missing line feed in this section" (links, Test 8)

These are likely edge cases where the block boundary newline insertion doesn't catch all transitions.

Fix approach:
1. After all style processing, do a final pass to ensure proper paragraph separation
2. Or enhance `insertBlockBoundaryNewlines` to be more aggressive about inserting newlines

Specific fix:
In `insertBlockBoundaryNewlines`, the logic only inserts when `currentBlockComponent != previousBlockComponent`. But this misses cases where:
- Text without PresentationIntent follows styled text
- Inline elements (code) are at the end of a paragraph

Solution: Add newline insertion logic that checks for ANY run boundary where the following content should be on a new line:
1. After code blocks
2. After blockquotes
3. After list sections
4. Between paragraphs

Alternative: Add a `normalizeNewlines` method called at the end of `render()`:
```swift
private func normalizeNewlines(_ nsAttributedString: NSMutableAttributedString) {
    // Ensure paragraphs are separated
    // Look for runs of text that should have newlines between them
    // This is a cleanup pass for any missed boundaries
}
```

For the link section specifically: Check if the link styling or PresentationIntent detection is stripping paragraph breaks. Links are inline elements, so paragraph boundaries should be preserved.

Debug: Log the raw AttributedString before and after processing to identify where newlines are being lost.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify no text runs together unexpectedly - all elements have proper visual separation.</verify>
  <done>All document sections have proper line breaks and visual separation</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Code blocks with uniform background (no jagged edges)
   - Proper spacing after inline code sections
   - Proper spacing between link text lines
3. Overall document has consistent visual rhythm
</verification>

<success_criteria>
- Code block backgrounds are visually uniform (single filled rectangle appearance)
- No text runs together unexpectedly
- Document has consistent paragraph/block spacing throughout
- No regression in other rendering elements
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-06-SUMMARY.md`
</output>
