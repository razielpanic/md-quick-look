---
phase: 02-core-markdown-rendering
plan: 06
type: execute
wave: 2
depends_on:
  - "02-04"
  - "02-05"
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
  - md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Code block background color renders uniformly without per-line misalignment"
    - "Inline code has proper spacing/newline before next element"
    - "Link sections have proper line breaks between text lines"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Consistent code block background and trailing newlines"
    - path: "md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift"
      provides: "Optional code block background drawing override"
  key_links:
    - from: "MarkdownRenderer.swift"
      to: "NSAttributedString"
      via: "Code block background attribute application"
      pattern: "backgroundColor.*secondarySystemFill"
---

<objective>
Fix code block background alignment and minor line break issues

UAT found: code block backgrounds are "misaligned by line" and some sections are missing trailing line breaks (inline code, links).

Purpose: Address minor UAT gaps - polish visual rendering
Output: Uniform code block backgrounds, proper spacing throughout
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-markdown-rendering/02-UAT.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix code block background alignment</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift, md-spotlighter/MDQuickLook/MarkdownLayoutManager.swift</files>
  <action>
UAT reported: "background color is misaligned by line in the code blocks"

This likely means each line within a code block has a slightly different background position/width, creating a jagged appearance.

Root cause analysis:
Current code applies `.backgroundColor` attribute to the code block range. However, this renders as inline background (following text bounds), not as a full-width block background.

Solutions (try in order):

**Option A: Use paragraph background drawing in MarkdownLayoutManager**
Similar to how blockquote borders are drawn, override `drawBackground` to draw a filled rectangle for code block ranges.

1. Add a custom attribute `.codeBlockMarker` (like `.blockquoteMarker`)
2. In `applyCodeBlockAttributes`, add this marker attribute
3. In MarkdownLayoutManager.drawBackground, detect code block ranges and draw a filled rectangle that spans the full container width

**Option B: Extend code block background to line boundaries**
The NSLayoutManager can provide line fragment rects. For code blocks, iterate line fragments and draw background for each complete line.

**Option C: Ensure consistent paragraph style**
The misalignment might be caused by inconsistent paragraph indentation. Ensure all lines in the code block have the same `headIndent` and `firstLineHeadIndent`.

Start with Option A as it's consistent with the existing blockquote pattern:

```swift
// In MarkdownRenderer.swift
extension NSAttributedString.Key {
    static let codeBlockMarker = NSAttributedString.Key("com.razielpanic.codeBlockMarker")
}

// In applyCodeBlockAttributes
nsAttributedString.addAttribute(.codeBlockMarker, value: true, range: range)

// In MarkdownLayoutManager.drawBackground
// After blockquote handling:
textStorage.enumerateAttribute(.codeBlockMarker, in: charRange, options: []) { value, range, _ in
    guard value != nil else { return }
    let glyphRange = self.glyphRange(forCharacterRange: range, actualCharacterRange: nil)
    let boundingRect = self.boundingRect(forGlyphRange: glyphRange, in: textContainer)

    // Draw full-width background (extend to container edges with padding)
    let bgRect = NSRect(x: origin.x + 8,
                       y: origin.y + boundingRect.minY,
                       width: textContainer.containerSize.width - 16,
                       height: boundingRect.height)
    NSColor.secondarySystemFill.setFill()
    bgRect.fill()
}
```

Remove the `.backgroundColor` attribute from code blocks if using LayoutManager drawing (to avoid double-drawing).
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify code blocks have uniform background without per-line jagging.</verify>
  <done>Code block background renders as uniform rectangle without line-by-line misalignment</done>
</task>

<task type="auto">
  <name>Task 2: Ensure proper trailing newlines throughout document</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reported minor issues with missing line breaks:
- "missing a line break at the end" (inline code, Test 4)
- "Missing line feed in this section" (links, Test 8)

These are likely edge cases where the block boundary newline insertion doesn't catch all transitions.

Fix approach:
1. After all style processing, do a final pass to ensure proper paragraph separation
2. Or enhance `insertBlockBoundaryNewlines` to be more aggressive about inserting newlines

Specific fix:
In `insertBlockBoundaryNewlines`, the logic only inserts when `currentBlockComponent != previousBlockComponent`. But this misses cases where:
- Text without PresentationIntent follows styled text
- Inline elements (code) are at the end of a paragraph

Solution: Add newline insertion logic that checks for ANY run boundary where the following content should be on a new line:
1. After code blocks
2. After blockquotes
3. After list sections
4. Between paragraphs

Alternative: Add a `normalizeNewlines` method called at the end of `render()`:
```swift
private func normalizeNewlines(_ nsAttributedString: NSMutableAttributedString) {
    // Ensure paragraphs are separated
    // Look for runs of text that should have newlines between them
    // This is a cleanup pass for any missed boundaries
}
```

For the link section specifically: Check if the link styling or PresentationIntent detection is stripping paragraph breaks. Links are inline elements, so paragraph boundaries should be preserved.

Debug: Log the raw AttributedString before and after processing to identify where newlines are being lost.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify no text runs together unexpectedly - all elements have proper visual separation.</verify>
  <done>All document sections have proper line breaks and visual separation</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - Code blocks with uniform background (no jagged edges)
   - Proper spacing after inline code sections
   - Proper spacing between link text lines
3. Overall document has consistent visual rhythm
</verification>

<success_criteria>
- Code block backgrounds are visually uniform (single filled rectangle appearance)
- No text runs together unexpectedly
- Document has consistent paragraph/block spacing throughout
- No regression in other rendering elements
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-06-SUMMARY.md`
</output>
