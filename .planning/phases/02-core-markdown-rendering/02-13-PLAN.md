---
phase: 02-core-markdown-rendering
plan: 13
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Image placeholders display with SF Symbol photo icon"
    - "Image placeholder text shows [Image: filename] format with square brackets"
    - "Image placeholder text is gray (secondaryLabelColor)"
    - "No preprocessing markers visible (__IMAGE_PLACEHOLDER__, __END__, etc.)"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Working image placeholder replacement"
      contains: "createImagePlaceholder"
  key_links:
    - from: "preprocessImages"
      to: "applyImagePlaceholderStyles"
      via: "plain text placeholders survive AttributedString conversion"
      pattern: "\\[Image:"
---

<objective>
Fix image placeholder rendering - Gap #23 (BLOCKER)

UAT round 5 shows:
- No photo icon displayed
- Text is not gray color
- No square brackets around filename
- "_END" marker text visible in output

Previous attempts (02-03, 02-05, 02-07) used `__IMAGE_PLACEHOLDER__filename__END__` markers that were partially modified by AttributedString, causing "_END" to appear in output. The marker-based approach is fundamentally flawed because AttributedString can split or modify marker text.

**Direct fix approach:** Replace images with plain text BEFORE AttributedString parsing. The placeholder `[Image: filename]` is just normal text that survives parsing intact. Then style it (gray color, SF Symbol icon) after conversion.

Purpose: Make image placeholders work correctly with icon, gray text, and proper formatting
Output: Working image placeholder display without exposed markers
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND5.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace image preprocessing with plain text placeholders</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The current marker-based approach fails because AttributedString modifies/splits the markers. Fix by using plain text placeholders that survive parsing.

**Step 1: Update preprocessImages() to emit plain text instead of markers**

Replace the current preprocessImages function:

```swift
private func preprocessImages(in markdown: String) -> String {
    // Replace ![alt](url) with plain text "[Image: filename]"
    // This plain text survives AttributedString parsing intact
    let pattern = "!\\[([^\\]]*)\\]\\(([^)]+)\\)"
    guard let regex = try? NSRegularExpression(pattern: pattern) else { return markdown }

    let nsString = markdown as NSString
    let matches = regex.matches(in: markdown, options: [], range: NSRange(location: 0, length: nsString.length))

    var result = markdown
    for match in matches.reversed() {
        guard match.numberOfRanges >= 3 else { continue }
        let urlRange = match.range(at: 2)
        let url = nsString.substring(with: urlRange)
        let filename = (url as NSString).lastPathComponent

        // Plain text placeholder - will be styled later
        let placeholder = "[Image: \(filename)]"
        result = (result as NSString).replacingCharacters(in: match.range, with: placeholder) as String
    }

    return result
}
```

**Step 2: Update applyImagePlaceholderStyles() to find plain text pattern**

Replace the current applyImagePlaceholderStyles function:

```swift
private func applyImagePlaceholderStyles(to nsAttributedString: NSMutableAttributedString) {
    // Find [Image: filename] patterns and style them
    let pattern = "\\[Image: ([^\\]]+)\\]"
    guard let regex = try? NSRegularExpression(pattern: pattern) else { return }

    let fullRange = NSRange(location: 0, length: nsAttributedString.length)
    let matches = regex.matches(in: nsAttributedString.string, options: [], range: fullRange)

    for match in matches.reversed() {
        guard match.range.location != NSNotFound else { continue }

        // Create SF Symbol attachment for photo icon
        let attachment = NSTextAttachment()
        if let symbolImage = NSImage(systemSymbolName: "photo", accessibilityDescription: "Image") {
            let config = NSImage.SymbolConfiguration(pointSize: bodyFontSize, weight: .regular)
            attachment.image = symbolImage.withSymbolConfiguration(config)
        }

        // Get the full placeholder text "[Image: filename]"
        let placeholderText = (nsAttributedString.string as NSString).substring(with: match.range)

        // Create styled replacement: icon + space + text
        let styledString = NSMutableAttributedString()

        // Add icon
        let iconString = NSAttributedString(attachment: attachment)
        styledString.append(iconString)
        styledString.append(NSAttributedString(string: " "))

        // Add placeholder text in gray
        let textAttributes: [NSAttributedString.Key: Any] = [
            .font: NSFont.systemFont(ofSize: bodyFontSize),
            .foregroundColor: NSColor.secondaryLabelColor
        ]
        styledString.append(NSAttributedString(string: placeholderText, attributes: textAttributes))

        // Replace in the attributed string
        nsAttributedString.replaceCharacters(in: match.range, with: styledString)
    }
}
```

**Step 3: Clean up unused marker constants**

Remove any `IMAGE_PLACEHOLDER_START`, `IMAGE_PLACEHOLDER_END`, or similar marker constants that are no longer needed.
  </action>
  <verify>make build && qlmanage -p samples/comprehensive.md 2>&1 | head -50</verify>
  <done>Image placeholders render correctly with icon, square brackets, gray color, no exposed markers</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - SF Symbol "photo" icon before each image placeholder
   - Text format: "[Image: screenshot.png]" and "[Image: logo.svg]"
   - Gray color (secondaryLabelColor)
   - No marker text visible (__IMAGE_PLACEHOLDER__, __END__, XXIMAGEX, etc.)
</verification>

<success_criteria>
- Image placeholders display with photo SF Symbol icon
- Text format is "[Image: filename]" with square brackets
- Text color is gray (secondaryLabelColor), not blue or black
- No preprocessing markers visible in rendered output
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-13-SUMMARY.md`
</output>
