---
phase: 02-core-markdown-rendering
plan: 13
type: execute
wave: 1
depends_on: []
files_modified:
  - md-spotlighter/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Image placeholders display with SF Symbol photo icon"
    - "Image placeholder text shows [Image: filename] format with square brackets"
    - "Image placeholder text is gray (secondaryLabelColor)"
    - "No preprocessing markers visible (__IMAGE_PLACEHOLDER__, __END__, etc.)"
  artifacts:
    - path: "md-spotlighter/MDQuickLook/MarkdownRenderer.swift"
      provides: "Working image placeholder replacement"
      contains: "createImagePlaceholder"
  key_links:
    - from: "preprocessImages"
      to: "applyImagePlaceholderStyles"
      via: "marker pattern must survive AttributedString conversion intact"
      pattern: "IMAGE_PLACEHOLDER"
---

<objective>
Fix image placeholder rendering - Gap #23 (BLOCKER)

UAT round 5 shows:
- No photo icon displayed
- Text is not gray color
- No square brackets around filename
- "_END" marker text visible in output

Previous attempts (02-03, 02-05, 02-07) failed. The current implementation uses `__IMAGE_PLACEHOLDER__filename__END__` markers but UAT shows "_END" is visible, meaning:
1. The marker is being partially modified by AttributedString, OR
2. The regex replacement is failing/partial

Root cause investigation needed before fixing.

Purpose: Make image placeholders work correctly with icon, gray text, and proper formatting
Output: Working image placeholder display without exposed markers
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND5.md
@md-spotlighter/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose image marker failure</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
The UAT shows "_END" text visible. This suggests either:
1. AttributedString modifies the marker in unexpected ways
2. The regex match is partial
3. Markers are split across AttributedString runs

Add diagnostic logging to trace exactly what happens:

1. **In preprocessImages()**: Log the exact marker being inserted:
```swift
os_log("preprocessImages: Inserting marker: %{public}@", log: .renderer, type: .info, placeholder)
```

2. **After AttributedString conversion** (after line 46): Log what the text looks like:
```swift
// After let attributedString = try? AttributedString(...)
let debugText = String(attributedString.characters)
os_log("After AttributedString: first 800 chars: %{public}@", log: .renderer, type: .info, String(debugText.prefix(800)))
```

3. **In applyImagePlaceholderStyles()**: Log more detail about what regex finds:
```swift
// Before the pattern matching
let searchText = nsAttributedString.string
os_log("Searching for markers in: %{public}@", log: .renderer, type: .debug, String(searchText.suffix(300)))
```

4. **Build and test**: Run `qlmanage -p samples/comprehensive.md` and check Console.app logs

This will reveal:
- Whether the marker survives AttributedString parsing intact
- What the regex is actually searching
- Why "_END" appears in output
  </action>
  <verify>Check Console.app logs during preview. Logs should show the marker before/after AttributedString conversion.</verify>
  <done>Root cause of image placeholder failure is identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix image marker replacement based on diagnosis</name>
  <files>md-spotlighter/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Based on the diagnosis from Task 1, implement the correct fix.

**Most likely causes and fixes:**

**Cause A: AttributedString modifies underscores**
If the marker is being changed (e.g., underscores becoming styled or characters being consumed):
- Use a completely inert marker format, e.g., `XXIMAGEXPLCHLDRXX` + filename + `XXENDXX` (no underscores, no angle brackets)
- Update both `preprocessImages()` and `applyImagePlaceholderStyles()` regex

**Cause B: Regex pattern issue**
If the marker is intact but regex fails:
- The `.+?` might be too greedy or matching wrong characters
- Change to explicit character class: `[A-Za-z0-9._-]+` for filename
- Test the regex separately on the actual text content

**Cause C: Markers split across runs**
If AttributedString puts the marker in multiple runs:
- Work on the raw string BEFORE creating AttributedString
- Replace markers in the preprocessed markdown string directly with placeholder text
- Then feed the already-replaced text to AttributedString

**Implementation approach (safest - Cause C fix):**
Move image replacement BEFORE AttributedString parsing:
```swift
func render(markdown: String) -> NSAttributedString {
    // Pre-process images to placeholder TEXT (not markers)
    let withPlaceholders = preprocessImagesAsText(in: markdown)

    // Now parse - placeholders are just regular text
    guard let attributedString = try? AttributedString(markdown: withPlaceholders) else {
        return NSAttributedString(string: markdown)
    }
    ...
}

private func preprocessImagesAsText(in markdown: String) -> String {
    // Replace ![alt](url) with plain text "[Image: filename]"
    // The SF Symbol icon can be added post-conversion
    let pattern = "!\\[([^\\]]*)\\]\\(([^)]+)\\)"
    guard let regex = try? NSRegularExpression(pattern: pattern) else { return markdown }

    let nsString = markdown as NSString
    let matches = regex.matches(in: markdown, options: [], range: NSRange(location: 0, length: nsString.length))

    var result = markdown
    for match in matches.reversed() {
        guard match.numberOfRanges >= 3 else { continue }
        let urlRange = match.range(at: 2)
        let url = nsString.substring(with: urlRange)
        let filename = (url as NSString).lastPathComponent

        // Insert plain text that won't be modified
        let placeholder = "[Image: \(filename)]"
        result = (result as NSString).replacingCharacters(in: match.range, with: placeholder) as String
    }

    return result
}
```

Then in `applyImagePlaceholderStyles()`, find `[Image: ...]` patterns and:
1. Apply gray color
2. Insert SF Symbol icon before the bracket
3. Remove any inherited link attribute

This approach is more robust because:
- No special markers that could be modified
- The placeholder is just normal text
- Styling happens post-conversion like other formatting
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: 1) Photo icon visible, 2) Text shows "[Image: filename]", 3) Text is gray, 4) No markers visible.</verify>
  <done>Image placeholders render correctly with icon, square brackets, gray color, no exposed markers</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows:
   - SF Symbol "photo" icon before each image placeholder
   - Text format: "[Image: screenshot.png]" and "[Image: logo.svg]"
   - Gray color (secondaryLabelColor)
   - No marker text visible (__IMAGE_PLACEHOLDER__, __END__, XXIMAGEX, etc.)
3. Console.app logs show successful image detection and styling
</verification>

<success_criteria>
- Image placeholders display with photo SF Symbol icon
- Text format is "[Image: filename]" with square brackets
- Text color is gray (secondaryLabelColor), not blue or black
- No preprocessing markers visible in rendered output
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-13-SUMMARY.md`
</output>
