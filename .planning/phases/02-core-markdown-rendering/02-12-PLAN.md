---
phase: 02-core-markdown-rendering
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - md-quick-look/MDQuickLook/MarkdownRenderer.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unordered list items appear on consecutive lines without massive gaps"
    - "Ordered list items appear on consecutive lines without massive gaps"
    - "List items with inline formatting (bold) remain on single line"
    - "All text throughout document is properly separated (no running together)"
  artifacts:
    - path: "md-quick-look/MDQuickLook/MarkdownRenderer.swift"
      provides: "Fixed list paragraph spacing"
      contains: "applyListItemAttributes"
  key_links:
    - from: "applyListItemAttributes"
      to: "NSMutableParagraphStyle"
      via: "paragraphSpacing settings"
      pattern: "paragraphSpacing"
---

<objective>
Fix list excessive spacing and inline formatting continuity (Gaps #17, #18)

UAT round 4 found:
- Gap #17 (BLOCKER): Unordered lists have "massive blank spaces" between items, "Third item with" split from "bold"
- Gap #18 (BLOCKER): Ordered lists have same massive spacing issue

The previous fix (02-09) added `hasSuffix("\n")` check but UAT shows spacing got WORSE, not better. This suggests the paragraph styling (not newline insertion) is the culprit, or the check introduced a regression.

Purpose: Fix list rendering to show items on consecutive lines
Output: Clean, properly-spaced lists without excessive gaps
</objective>

<execution_context>
@gsd:workflows/execute-plan.md
@gsd:templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-core-markdown-rendering/02-VERIFICATION-ROUND4.md
@.planning/phases/02-core-markdown-rendering/02-09-PLAN.md
@md-quick-look/MDQuickLook/MarkdownRenderer.swift
@samples/comprehensive.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug list spacing - identify root cause</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reports "massive blank spaces" between list items. The current paragraph styling for lists:

```swift
private func applyListItemAttributes(to nsAttributedString: NSMutableAttributedString, range: NSRange, ordinal: Int) {
    let paragraphStyle = NSMutableParagraphStyle()
    paragraphStyle.firstLineHeadIndent = 20
    paragraphStyle.headIndent = 30
    paragraphStyle.tabStops = [NSTextTab(textAlignment: .left, location: 30)]
    paragraphStyle.paragraphSpacing = 4  // <-- This adds space AFTER each paragraph
    nsAttributedString.addAttribute(.paragraphStyle, value: paragraphStyle, range: range)
}
```

And base styling adds:
```swift
let defaultParagraphStyle = NSMutableParagraphStyle()
defaultParagraphStyle.paragraphSpacing = 8  // <-- This ALSO adds spacing
```

**Debug hypothesis**: Multiple paragraph styles are stacking, OR newlines are creating multiple "paragraphs" within each list item.

Add debug logging to understand what's happening:

```swift
// In applyListItemAttributes:
os_log("MarkdownRenderer: List item range %d-%d, text: %{public}@",
       log: .renderer, type: .debug,
       range.location, range.location + range.length,
       nsAttributedString.attributedSubstring(from: range).string.prefix(50))
```

**Key debug questions:**
1. How many times is `applyListItemAttributes` called per list item?
2. What is the actual text content of each "list item" range?
3. Are there newlines WITHIN the list item range?

Check the render() flow:
1. insertBlockBoundaryNewlines - adds newlines at block transitions
2. ensureIntraBlockNewlines - adds newlines after list items
3. applyBlockStyles - applies paragraph styles

If newlines are inserted WITHIN list item ranges, each line gets treated as a separate paragraph with `paragraphSpacing`.
  </action>
  <verify>Build with `make build`. Check Console.app logs while running `qlmanage -p samples/comprehensive.md`. Identify: How many list item calls? What text ranges?</verify>
  <done>Root cause of excessive list spacing identified</done>
</task>

<task type="auto">
  <name>Task 2: Fix list paragraph spacing</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
Based on debug findings, fix the spacing. Most likely fixes:

**Fix A: Remove paragraphSpacing from list items entirely**
```swift
private func applyListItemAttributes(to nsAttributedString: NSMutableAttributedString, range: NSRange, ordinal: Int) {
    let paragraphStyle = NSMutableParagraphStyle()
    paragraphStyle.firstLineHeadIndent = 20
    paragraphStyle.headIndent = 30
    paragraphStyle.tabStops = [NSTextTab(textAlignment: .left, location: 30)]
    // REMOVE paragraphSpacing for lists - newlines provide separation
    paragraphStyle.paragraphSpacing = 0
    paragraphStyle.paragraphSpacingBefore = 0
    nsAttributedString.addAttribute(.paragraphStyle, value: paragraphStyle, range: range)
}
```

**Fix B: Use lineSpacing instead of paragraphSpacing**
`paragraphSpacing` adds space after each paragraph (each newline-terminated block).
`lineSpacing` adds space between lines within a paragraph.

For lists, we want minimal inter-item spacing:
```swift
paragraphStyle.lineSpacing = 2  // Small spacing between wrapped lines
paragraphStyle.paragraphSpacing = 2  // Small spacing between items
```

**Fix C: Ensure base styles don't override list styles**
In `applyBaseStyles`, check if paragraphStyle is already set before applying default:
```swift
nsAttributedString.enumerateAttribute(.paragraphStyle, in: fullRange, options: []) { value, range, _ in
    if value == nil {
        nsAttributedString.addAttribute(.paragraphStyle, value: defaultParagraphStyle, range: range)
    }
    // Don't override existing paragraph styles from list/code/blockquote
}
```

The current code already does this, but verify the order of operations: `applyBlockStyles` (which includes list styles) should run BEFORE `applyBaseStyles`.

Check render() order in the file - if `applyBaseStyles` runs first, it would set default and then block styles would override. But if block styles don't FULLY replace the paragraph style (just add to it), there could be cumulative effects.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: List items appear on consecutive lines with small (normal) spacing, not massive gaps.</verify>
  <done>List items have appropriate spacing without excessive gaps</done>
</task>

<task type="auto">
  <name>Task 3: Fix inline formatting continuity in list items</name>
  <files>md-quick-look/MDQuickLook/MarkdownRenderer.swift</files>
  <action>
UAT reports: "'Third item with' split from 'â€¢ bold' onto separate lines"

This indicates that "Third item with **bold**" is being broken into separate elements:
- "Third item with " (plain text)
- "bold" (styled text)

And something is inserting a line break between them.

**Hypothesis**: The `insertBlockBoundaryNewlines` or `ensureIntraBlockNewlines` logic is treating inline formatting transitions as block boundaries.

Check `insertBlockBoundaryNewlines`:
```swift
let currentBlockComponent = intent.components.first?.kind
```

If the bold text has a DIFFERENT `PresentationIntent` than the plain text, this would trigger a newline.

**Fix**: Only insert block boundaries for TRUE block-level transitions, not inline formatting:

```swift
// In insertBlockBoundaryNewlines, check for actual block elements:
for component in intent.components {
    switch component.kind {
    case .header, .codeBlock, .orderedList, .unorderedList, .blockQuote, .paragraph, .listItem:
        // These are block elements
        isBlockElement = true
    default:
        break
    }
}
```

Actually, the issue might be that WITHIN a list item, there are multiple runs (one for plain text, one for bold), and the logic treats each run transition as requiring a newline.

**Better fix**: Track the current LIST context. If we're inside a listItem, don't insert newlines between runs:

```swift
// Track if we're in a multi-run block that shouldn't be split
var inListItem = false
var currentListItemOrdinal: Int?

for run in attributedString.runs {
    guard let intent = run.presentationIntent else { ... }

    var runListItemOrdinal: Int?
    for component in intent.components {
        if case .listItem(ordinal: let ord) = component.kind {
            runListItemOrdinal = ord
        }
    }

    // If same list item ordinal, don't insert newline
    if let current = runListItemOrdinal, current == currentListItemOrdinal {
        // Same list item, skip newline insertion
        previousRunEndedWithNewline = runEndsWithNewline
        continue
    }

    currentListItemOrdinal = runListItemOrdinal
    // ... rest of logic
}
```

This ensures that multiple runs within the same list item (plain + bold) don't get split.
  </action>
  <verify>Build with `make build`. Run `qlmanage -p samples/comprehensive.md`. Verify: "Third item with bold" appears on single line (bold word formatted but not on separate line).</verify>
  <done>List items with inline formatting render on single lines</done>
</task>

</tasks>

<verification>
1. `make build` succeeds without errors
2. `qlmanage -p samples/comprehensive.md` shows lists with:
   - Unordered list: Items on consecutive lines with minimal spacing
   - Ordered list: Items on consecutive lines with minimal spacing
   - "Third item with **bold**" all on one line (bold styled but not separated)
   - No "massive gaps" between any list items
3. Document spacing overall is correct (no text running together, no excessive gaps)
</verification>

<success_criteria>
- Unordered list: Items appear consecutively with normal line spacing (~4-8pt)
- Ordered list: Items appear consecutively with normal line spacing
- "Third item with bold" on single line
- No massive vertical gaps anywhere in lists
- Other document elements still properly separated
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-markdown-rendering/02-12-SUMMARY.md`
</output>
