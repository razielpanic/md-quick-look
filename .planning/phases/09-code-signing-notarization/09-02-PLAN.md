---
phase: 09-code-signing-notarization
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Makefile
autonomous: false
user_setup:
  - service: apple-notarization
    why: "Notarization requires app-specific password for Apple ID"
    account_setup:
      - task: "Generate app-specific password"
        location: "https://appleid.apple.com > Sign-In and Security > App-Specific Passwords"
        required_before: "Can store notarization credentials"
    dashboard_config:
      - task: "Note your Apple ID email"
        location: "The email you use to sign into developer.apple.com"

must_haves:
  truths:
    - "Signed app passes codesign verification"
    - "Signed app passes Gatekeeper assessment (spctl)"
    - "App is notarized by Apple"
    - "Notarization ticket is stapled to app bundle"
    - "Extension inside app is properly signed"
  artifacts:
    - path: "build/Build/Products/Release/MDQuickLook.app"
      provides: "Signed, notarized, stapled application bundle"
    - path: "Makefile"
      provides: "Updated with sign-and-notarize target"
      contains: "notarytool"
  key_links:
    - from: "MDQuickLook.app"
      to: "Contents/PlugIns/MDQuickLook.appex"
      via: "Nested code signature"
      pattern: "sealed resources"
    - from: "MDQuickLook.app"
      to: "Apple notary service"
      via: "xcrun notarytool submit"
      pattern: "status: Accepted"
---

<objective>
Sign, notarize, and staple the app for secure distribution outside the App Store.

Purpose: Complete the code signing and notarization workflow so the app can be distributed via GitHub without Gatekeeper warnings.

Output:
- Fully signed MDQuickLook.app with hardened runtime
- Notarization ticket stapled to app bundle
- Updated Makefile with release signing target
- Verified Gatekeeper compliance
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-code-signing-notarization/09-RESEARCH.md
@.planning/phases/09-code-signing-notarization/09-01-SUMMARY.md
@Makefile
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Store Notarization Credentials in Keychain</name>
  <action>
    Before Claude can submit for notarization, credentials must be stored in keychain.

    1. Generate an app-specific password (if not already done):
       - Go to https://appleid.apple.com
       - Sign in with your Apple ID
       - Go to "Sign-In and Security" > "App-Specific Passwords"
       - Click "+" to generate a new password
       - Name it "Notarization" or similar
       - Copy the password (format: xxxx-xxxx-xxxx-xxxx)

    2. Store credentials in keychain by running this command in Terminal:
       ```
       xcrun notarytool store-credentials "NotaryProfile" \
         --apple-id "YOUR_APPLE_ID_EMAIL" \
         --team-id "YOUR_TEAM_ID" \
         --password "YOUR_APP_SPECIFIC_PASSWORD"
       ```

    Replace:
    - YOUR_APPLE_ID_EMAIL: Your Apple ID email
    - YOUR_TEAM_ID: 10-character Team ID from Plan 09-01
    - YOUR_APP_SPECIFIC_PASSWORD: The app-specific password you just generated

    3. Verify it worked:
       ```
       xcrun notarytool history --keychain-profile "NotaryProfile"
       ```
       Should show submission history (may be empty if first time)
  </action>
  <verify>User confirms credentials stored successfully</verify>
  <done>Type "credentials stored" to continue</done>
</task>

<task type="auto">
  <name>Task 2: Build, Sign, Notarize, and Staple</name>
  <files>build/Build/Products/Release/MDQuickLook.app</files>
  <action>
    Execute the complete signing and notarization workflow:

    1. Clean and build Release configuration:
       ```bash
       make clean
       make build
       ```

    2. Verify signatures are valid (Xcode automatic signing handles inside-out order):
       ```bash
       codesign --verify --deep --strict --verbose=2 \
         build/Build/Products/Release/MDQuickLook.app
       ```

    3. Verify hardened runtime is enabled:
       ```bash
       codesign --display --verbose \
         build/Build/Products/Release/MDQuickLook.app 2>&1 | grep runtime
       ```
       Must show "runtime" flag

    4. Create ZIP for notarization submission:
       ```bash
       ditto -c -k --keepParent \
         build/Build/Products/Release/MDQuickLook.app \
         build/MDQuickLook.zip
       ```

    5. Submit to Apple notary service (with --wait to block until complete):
       ```bash
       xcrun notarytool submit build/MDQuickLook.zip \
         --keychain-profile "NotaryProfile" \
         --wait
       ```
       This may take 1-15 minutes. Wait for "status: Accepted"

    6. Staple the notarization ticket to the app:
       ```bash
       xcrun stapler staple build/Build/Products/Release/MDQuickLook.app
       ```

    7. Verify stapling succeeded:
       ```bash
       xcrun stapler validate build/Build/Products/Release/MDQuickLook.app
       ```

    8. Test Gatekeeper assessment:
       ```bash
       spctl --assess --type execute --verbose \
         build/Build/Products/Release/MDQuickLook.app
       ```
       Must show "accepted" with "source=Notarized Developer ID"

    If notarization fails:
    - Get detailed log: `xcrun notarytool log SUBMISSION_ID --keychain-profile "NotaryProfile"`
    - Common issues: missing hardened runtime, unsigned nested code, invalid entitlements
  </action>
  <verify>
    All verification commands pass:
    - `codesign --verify --deep --strict` exits 0
    - `xcrun stapler validate` shows "The validate action worked!"
    - `spctl --assess --type execute --verbose` shows "accepted"
  </verify>
  <done>
    - App is signed with Developer ID Application
    - Notarization status is "Accepted"
    - Ticket is stapled to app bundle
    - Gatekeeper assessment passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Release Target to Makefile</name>
  <files>Makefile</files>
  <action>
    Add a `release` target to Makefile that builds, signs, notarizes, and staples.

    Add these targets after the existing targets:

    ```makefile
    # Build signed release for distribution
    release: clean
    	xcodebuild -project $(PROJECT_DIR)/MDQuickLook.xcodeproj \
    		-scheme $(SCHEME) \
    		-configuration Release \
    		-derivedDataPath $(BUILD_DIR) \
    		build
    	@echo "Verifying code signature..."
    	codesign --verify --deep --strict $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    	@echo "Creating ZIP for notarization..."
    	ditto -c -k --keepParent $(BUILD_DIR)/Build/Products/Release/$(APP_NAME) $(BUILD_DIR)/$(APP_NAME:.app=.zip)
    	@echo "Submitting to Apple notary service (this may take several minutes)..."
    	xcrun notarytool submit $(BUILD_DIR)/$(APP_NAME:.app=.zip) \
    		--keychain-profile "NotaryProfile" \
    		--wait
    	@echo "Stapling notarization ticket..."
    	xcrun stapler staple $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    	@echo "Verifying Gatekeeper acceptance..."
    	spctl --assess --type execute --verbose $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    	@echo "Release build complete: $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)"

    # Verify existing build signatures
    verify:
    	codesign --verify --deep --strict --verbose=2 $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    	codesign --display --verbose $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    	xcrun stapler validate $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    	spctl --assess --type execute --verbose $(BUILD_DIR)/Build/Products/Release/$(APP_NAME)
    ```

    Update .PHONY line to include new targets:
    ```makefile
    .PHONY: build install clean reload test all release verify
    ```
  </action>
  <verify>
    `make release` target exists: `grep "^release:" Makefile`
    `make verify` target exists: `grep "^verify:" Makefile`
  </verify>
  <done>
    - Makefile has `release` target for full signing workflow
    - Makefile has `verify` target for checking signatures
    - Running `make release` produces signed, notarized app
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. App is signed and notarized:
   ```bash
   make verify
   ```
   All checks should pass

2. Clean test on signed app:
   ```bash
   # Verify the complete chain
   codesign --verify --deep --strict build/Build/Products/Release/MDQuickLook.app
   xcrun stapler validate build/Build/Products/Release/MDQuickLook.app
   spctl --assess --type execute --verbose build/Build/Products/Release/MDQuickLook.app
   ```

3. Extension is properly signed:
   ```bash
   codesign --verify --deep --strict \
     "build/Build/Products/Release/MDQuickLook.app/Contents/PlugIns/MDQuickLook.appex"
   ```
</verification>

<success_criteria>
- App passes `codesign --verify --deep --strict`
- App passes `spctl --assess --type execute` with "accepted"
- Notarization ticket is stapled (`xcrun stapler validate` works)
- Extension .appex is properly signed within the app bundle
- `make release` target automates the full workflow
- No Gatekeeper warnings when launching the app
</success_criteria>

<output>
After completion, create `.planning/phases/09-code-signing-notarization/09-02-SUMMARY.md`
</output>
