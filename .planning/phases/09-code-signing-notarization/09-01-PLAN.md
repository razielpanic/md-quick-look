---
phase: 09-code-signing-notarization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MDQuickLook/MDQuickLook/MDQuickLook.entitlements
  - MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
autonomous: false
user_setup:
  - service: apple-developer
    why: "Code signing with Developer ID requires Apple Developer Program membership"
    account_setup:
      - task: "Join Apple Developer Program ($99/year)"
        location: "https://developer.apple.com/programs/"
        required_before: "Xcode can resolve signing identity"
    dashboard_config:
      - task: "Verify Developer ID Application certificate exists"
        location: "Xcode > Settings > Accounts > Manage Certificates"

must_haves:
  truths:
    - "Xcode project has hardened runtime enabled for all targets"
    - "Main app target has entitlements file configured"
    - "Extension target has entitlements file configured"
    - "Development Team ID is set for all targets"
    - "Signing identity is Developer ID Application"
  artifacts:
    - path: "MDQuickLook/MDQuickLook/MDQuickLook.entitlements"
      provides: "Main app sandbox and file access entitlements"
      contains: "com.apple.security.app-sandbox"
    - path: "MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj"
      provides: "Updated build settings with team ID and signing identity"
      contains: "CODE_SIGN_IDENTITY"
  key_links:
    - from: "project.pbxproj"
      to: "MDQuickLook.entitlements"
      via: "CODE_SIGN_ENTITLEMENTS build setting"
      pattern: 'CODE_SIGN_ENTITLEMENTS.*MDQuickLook\.entitlements'
---

<objective>
Configure the Xcode project for Developer ID code signing and hardened runtime.

Purpose: Prepare the project to build signed releases that can be distributed outside the App Store. This is the foundation for notarization.

Output:
- Main app entitlements file (MDQuickLook.entitlements)
- Updated project.pbxproj with Developer ID signing configuration
- Verified build with code signing enabled
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-code-signing-notarization/09-RESEARCH.md
@MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj
@MDQuickLook/MDQuickLook Extension/MDQuickLook.entitlements
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Verify Apple Developer Account Setup</name>
  <action>
    Before proceeding, the user must have:

    1. Active Apple Developer Program membership ($99/year)
       - If not enrolled: https://developer.apple.com/programs/

    2. Developer ID Application certificate in Xcode
       - Open Xcode > Settings > Accounts
       - Select your Apple ID
       - Click "Manage Certificates"
       - If no "Developer ID Application" certificate: click "+" and create one

    3. Note your Team ID (10-character alphanumeric)
       - Visible in Xcode under team name, or at developer.apple.com/account
  </action>
  <verify>User confirms Developer ID Application certificate exists in Xcode</verify>
  <done>Type your Team ID (e.g., "ABCD123456") to continue</done>
</task>

<task type="auto">
  <name>Task 2: Create Main App Entitlements File</name>
  <files>MDQuickLook/MDQuickLook/MDQuickLook.entitlements</files>
  <action>
    Create entitlements file for the main app target with sandbox enabled.

    The main app (host for Quick Look extension) needs minimal entitlements:
    - App sandbox enabled (required for hardened runtime + notarization)
    - Read-only file access for user-selected files (consistency with extension)

    Use the same structure as the extension entitlements file for consistency.
    Do NOT add network access or other permissions unless specifically needed.
  </action>
  <verify>
    File exists: `ls -la MDQuickLook/MDQuickLook/MDQuickLook.entitlements`
    File contains sandbox key: `grep "app-sandbox" MDQuickLook/MDQuickLook/MDQuickLook.entitlements`
  </verify>
  <done>MDQuickLook.entitlements file exists with app-sandbox enabled</done>
</task>

<task type="auto">
  <name>Task 3: Update Xcode Project Build Settings</name>
  <files>MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj</files>
  <action>
    Update project.pbxproj to configure code signing for distribution:

    For BOTH Debug and Release configurations, for BOTH targets (MDQuickLook app and MDQuickLook Extension):

    1. Set DEVELOPMENT_TEAM to the user's Team ID (provided in Task 1)
    2. Set CODE_SIGN_IDENTITY to "Developer ID Application" for Release
    3. Set CODE_SIGN_ENTITLEMENTS for main app target to "MDQuickLook/MDQuickLook.entitlements"
    4. Verify ENABLE_HARDENED_RUNTIME remains YES

    Important:
    - Keep CODE_SIGN_STYLE = Automatic (Xcode handles inside-out signing order)
    - Extension target already has entitlements set, verify it's correct
    - Debug can keep "Apple Development" for faster iteration

    Use sed or direct file modification. The project.pbxproj is plain text.
  </action>
  <verify>
    Build succeeds: `cd MDQuickLook && xcodebuild -project MDQuickLook.xcodeproj -scheme MDQuickLook -configuration Release build 2>&1 | tail -20`
    Signing configured: `grep "DEVELOPMENT_TEAM" MDQuickLook/MDQuickLook.xcodeproj/project.pbxproj | head -4`
  </verify>
  <done>
    - DEVELOPMENT_TEAM set for all targets
    - Release builds use Developer ID Application identity
    - Main app entitlements linked in project
    - Build succeeds with code signing
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Entitlements files exist:
   - `ls MDQuickLook/MDQuickLook/MDQuickLook.entitlements` (main app)
   - `ls MDQuickLook/MDQuickLook\ Extension/MDQuickLook.entitlements` (extension)

2. Build produces signed app:
   ```bash
   make build
   codesign --verify --deep build/Build/Products/Release/MDQuickLook.app
   ```

3. Hardened runtime enabled:
   ```bash
   codesign --display --verbose build/Build/Products/Release/MDQuickLook.app 2>&1 | grep runtime
   ```
   Should show "flags=0x10000(runtime)"
</verification>

<success_criteria>
- Main app entitlements file created with sandbox enabled
- project.pbxproj updated with Team ID and Developer ID signing
- Release build succeeds with code signing
- Both .app and embedded .appex are signed with hardened runtime
</success_criteria>

<output>
After completion, create `.planning/phases/09-code-signing-notarization/09-01-SUMMARY.md`
</output>
