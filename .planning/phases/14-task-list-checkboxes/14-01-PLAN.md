---
phase: 14-task-list-checkboxes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
autonomous: false

must_haves:
  truths:
    - "`- [ ]` items display an empty circle SF Symbol checkbox"
    - "`- [x]` items display a filled checkmark.circle.fill SF Symbol checkbox"
    - "Both checkbox states use system accent blue color"
    - "Checkboxes are baseline-aligned with their list item text"
    - "Mixed lists show bullets for regular items and checkboxes for task items"
    - "Task list syntax inside code blocks renders as literal text (not checkboxes)"
    - "Checkbox size scales with font size across width tiers"
    - "Wrapped text aligns to first line of text, not to the checkbox"
  artifacts:
    - path: "MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift"
      provides: "Task list preprocessing, checkbox attachment creation, placeholder replacement"
      contains: "checkmark.circle.fill"
  key_links:
    - from: "MarkdownRenderer.preprocessTaskLists"
      to: "MarkdownRenderer.render"
      via: "Called in render() before AttributedString parsing, after image preprocessing"
      pattern: "preprocessTaskLists"
    - from: "MarkdownRenderer.applyTaskCheckboxStyles"
      to: "MarkdownRenderer.render"
      via: "Called after applyBaseStyles to replace placeholders with SF Symbol attachments"
      pattern: "applyTaskCheckboxStyles"
    - from: "MarkdownRenderer.insertListPrefixes"
      to: "Task list detection"
      via: "Must skip inserting bullet prefix for task list items (placeholder already present)"
      pattern: "TASKUNCHECKED|TASKCHECKED"
---

<objective>
Render GFM task list items (`- [ ]` and `- [x]`) as visual SF Symbol checkboxes in the Quick Look markdown preview.

Purpose: Task lists are common in markdown files (TODOs, checklists, project tracking). Rendering them as visual checkboxes instead of raw syntax provides instant visual scanning of completion status -- core to the "effortless context" value proposition.

Output: Updated MarkdownRenderer.swift with task list preprocessing, SF Symbol checkbox creation, placeholder replacement, and proper paragraph styling for checkbox alignment.
</objective>

<execution_context>
@/Users/razielpanic/.claude/get-shit-done/workflows/execute-plan.md
@/Users/razielpanic/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-task-list-checkboxes/14-CONTEXT.md
@.planning/phases/14-task-list-checkboxes/14-RESEARCH.md
@MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift
@MDQuickLook/MDQuickLook Extension/MarkdownLayoutManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement task list checkbox rendering in MarkdownRenderer</name>
  <files>MDQuickLook/MDQuickLook Extension/MarkdownRenderer.swift</files>
  <action>
Add task list checkbox rendering to MarkdownRenderer.swift using the established preprocessing + placeholder replacement pattern (same as image placeholders). This involves four changes:

**1. Add preprocessTaskLists method (preprocessing stage)**

Create a `preprocessTaskLists(in:)` method that converts task list markers to placeholders BEFORE `AttributedString(markdown:)` parsing. This follows the same pattern as `preprocessImages(in:)`.

- Match `- [ ] ` at the start of a line (or after whitespace for nested) and replace with `- TASKUNCHECKEDPLACEHOLDER `
- Match `- [x] ` (case-insensitive for `x`/`X`) at the start of a line and replace with `- TASKCHECKEDPLACEHOLDER `
- Use regex: `^(\s*)-\s*\[\s*\]\s+` for unchecked, `^(\s*)-\s*\[[xX]\]\s+` for checked
- Preserve leading whitespace (indentation) for nesting
- IMPORTANT: Do NOT match inside code blocks. Use a simple state machine: track whether we're inside a fenced code block (``` or ~~~) by scanning line-by-line, and skip replacement for lines inside code fences. The research says swift-markdown AST handles this automatically, but our preprocessing happens BEFORE AST parsing on raw text, so we must handle it ourselves.

**2. Wire preprocessTaskLists into the render pipeline**

In the `render(markdown:widthTier:availableWidth:)` method, call `preprocessTaskLists(in:)` in the preprocessing chain. Add it after `preprocessBlockquoteSoftBreaks` but before the table check:

```swift
let preprocessedMarkdown = preprocessTaskLists(in: preprocessBlockquoteSoftBreaks(in: preprocessImages(in: bodyMarkdown)))
```

Also wire it into `renderNonTableSegment(_:)` to ensure task lists inside hybrid table documents are handled:

```swift
// In renderNonTableSegment, preprocess the segment before parsing
let preprocessed = preprocessTaskLists(in: trimmed)
guard let attributedString = try? AttributedString(markdown: preprocessed) else {
```

**3. Add checkboxAttachment helper and applyTaskCheckboxStyles method (post-processing stage)**

Create a `checkboxAttachment(checked:fontSize:)` method that creates an NSTextAttachment with an SF Symbol:
- Unchecked: `circle` SF Symbol (per user decision -- NOT `square`)
- Checked: `checkmark.circle.fill` SF Symbol (per user decision -- NOT `checkmark.square.fill`)
- Use `NSImage.SymbolConfiguration(pointSize: fontSize, weight: .regular)` with `.applying(.init(hierarchicalColor: .controlAccentColor))` for system accent blue color on both states
- Set attachment bounds with negative y offset for baseline alignment: `CGRect(x: 0, y: -(fontSize * 0.15), width: fontSize, height: fontSize)` -- start with these values and adjust if needed
- Add accessibility descriptions: "Incomplete task" / "Completed task"

Create `applyTaskCheckboxStyles(to:)` method that finds TASKUNCHECKEDPLACEHOLDER and TASKCHECKEDPLACEHOLDER in the NSMutableAttributedString and replaces each with the appropriate SF Symbol attachment. Follow the same pattern as `applyImagePlaceholderStyles(to:)`:
- Use regex to find `TASK(UN)?CHECKEDPLACEHOLDER` patterns
- For each match (in reverse order to maintain indices), create the checkbox attachment string via `NSAttributedString(attachment:)` followed by a small gap space
- The gap space should be 2-3pt (per user decision). Create this as a fixed-width space by using NSAttributedString with a space character and `.kern` attribute set to create the tight gap, OR use a simple thin space character
- Replace the placeholder text with the attachment + gap

Call `applyTaskCheckboxStyles(to:)` in BOTH render paths:
- In `render()` standard path: call it after `applyBaseStyles(to:)` but before the front matter prepend
- In `renderNonTableSegment(_:)`: call it after `applyBaseStyles(to:)` before returning

**4. Update insertListPrefixes to skip task list items**

Modify `insertListPrefixes(from:to:)` so it does NOT insert a bullet prefix ("â€¢ ") for list items whose text starts with a TASKUNCHECKEDPLACEHOLDER or TASKCHECKEDPLACEHOLDER marker. The placeholder IS the prefix for task items.

Check: after the prefix insertion point is determined (at `item.range.location`), look at the text at that location in the NSMutableAttributedString. If the text right after begins with "TASK" (the placeholder), skip inserting the bullet prefix for that item.

**5. Update paragraph style for task list items**

Task list items need a hanging indent so wrapped text aligns to the first line of text, not to the checkbox. The existing `applyListItemAttributes` already sets `headIndent` for wrapped text. Since task items get their checkbox via placeholder replacement (which changes the visual width of the prefix), ensure the paragraph style accounts for this:
- The checkbox attachment is `fontSize` wide + 2-3pt gap
- At normal tier: firstLineHeadIndent=20, headIndent should be 20 + fontSize + gap (approximately 20 + 14 + 3 = 37)
- At narrow tier: firstLineHeadIndent=10, headIndent should be 10 + fontSize + gap (approximately 10 + 12 + 3 = 25)

Since the paragraph style is applied generically to all list items in `applyListItemAttributes`, and task items should have a slightly wider headIndent than regular bullets, handle this in `applyTaskCheckboxStyles` -- after replacing the placeholder, update the paragraph style for that range to use the wider headIndent. Use the same paragraph style values but with adjusted headIndent.

**Key constraints:**
- Use `circle` and `checkmark.circle.fill` per user decision (NOT square/checkmark.square.fill)
- Use system accent blue via hierarchicalColor (NOT foregroundColor attribute)
- No text styling change for checked items (no strikethrough, no dimming)
- Task item text is plain text only -- no need to handle inline formatting within task items
- Same checkbox style at all nesting levels (no size or icon variation by depth)
- Same vertical spacing between task items as regular list items
  </action>
  <verify>
Run `make build` from the project root to verify the project compiles without errors. Check that:
1. No compiler errors or warnings related to the new methods
2. The build product is created at build/Build/Products/Release/MD Quick Look.app
  </verify>
  <done>
MarkdownRenderer.swift contains:
- `preprocessTaskLists(in:)` method that converts `- [ ]` / `- [x]` to placeholders (skipping code blocks)
- `checkboxAttachment(checked:fontSize:)` method creating SF Symbol NSTextAttachment with `circle` / `checkmark.circle.fill`
- `applyTaskCheckboxStyles(to:)` method replacing placeholders with checkbox attachments
- Both render paths (standard + hybrid table) call preprocessing and post-processing
- `insertListPrefixes` skips bullet insertion for task list items
- Project builds successfully with `make build`
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of task list checkboxes</name>
  <what-built>
Task list checkbox rendering in the Quick Look extension. GFM task list items (`- [ ]` and `- [x]`) now render as SF Symbol circle checkboxes with system accent blue color, baseline-aligned with text, with proper text wrapping alignment.
  </what-built>
  <how-to-verify>
1. Install the updated extension: `make install` from project root
2. Reload the Quick Look extension: `make reload`
3. Create or locate a test markdown file with this content:

```markdown
# Task List Test

## Basic task list
- [ ] Unchecked item
- [x] Checked item
- [ ] Another unchecked item

## Mixed list (regular + task items)
- Regular bullet item
- [ ] Task item mixed in
- Another regular bullet
- [x] Completed task mixed in

## Nested task lists
- Parent bullet item
  - [ ] Nested unchecked task
  - [x] Nested checked task
- [ ] Parent task item
  - Regular nested bullet
  - [x] Nested checked under task parent

## Long text wrapping
- [ ] This is a very long task item that should wrap to the next line and the wrapped text should align with the first line of text, not with the checkbox symbol itself

## Code block (should NOT convert)
```
- [ ] This should render as literal text
- [x] This too
```

## After code block
- [ ] This should be a checkbox again
```

4. Select the test file in Finder, press spacebar to open Quick Look
5. Verify:
   - Unchecked items show an empty circle (not square) in blue
   - Checked items show a filled circle with checkmark in blue
   - Checkboxes align with the text baseline (not floating above or below)
   - Mixed lists show bullets for regular items and circles for task items
   - Nested task lists render correctly at all levels
   - Long text wraps with indent aligned to first line of text
   - Code block content shows literal `- [ ]` text, not checkboxes
   - Items after the code block ARE checkboxes
6. Test in Finder column view (narrow preview pane):
   - Checkboxes are smaller (scaled with narrow tier font)
   - Still readable and properly aligned
7. Check both light and dark mode appearance
  </how-to-verify>
  <resume-signal>Type "approved" if checkboxes render correctly, or describe any visual issues (alignment, sizing, color, spacing) that need adjustment.</resume-signal>
</task>

</tasks>

<verification>
- `make build` succeeds with no errors
- Test markdown file with task lists renders checkboxes in Quick Look spacebar popup
- Mixed lists (bullets + checkboxes) display correctly
- Code block task list syntax NOT converted to checkboxes
- Both width tiers (narrow preview pane + normal popup) render properly
</verification>

<success_criteria>
- TASK-01: `- [ ]` renders with `circle` SF Symbol (empty circle)
- TASK-02: `- [x]` renders with `checkmark.circle.fill` SF Symbol (filled circle)
- TASK-03: Both checkbox states use system accent blue via hierarchicalColor
- TASK-04: Checkboxes baseline-aligned with list item text, wrapped text aligns to first line
- TASK-05: Mixed lists show bullets for regular items, checkboxes for task items
- TASK-06: Task list syntax in code blocks renders as literal text
</success_criteria>

<output>
After completion, create `.planning/phases/14-task-list-checkboxes/14-01-SUMMARY.md`
</output>
